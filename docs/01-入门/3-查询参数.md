# 查询参数

## 1. 基础语法

查询参数是 URL 中 `?` 后面的键值对，用于过滤、排序、分页等操作。非路径参数的函数参数会自动成为查询参数。

```python
from fastapi import FastAPI

app = FastAPI()

fake_items_db = [{"item_name": "Foo"}, {"item_name": "Bar"}, {"item_name": "Baz"}]

@app.get("/items/")
async def read_item(skip: int = 0, limit: int = 10):
    # skip 和 limit 是查询参数
    return fake_items_db[skip : skip + limit]
```

访问示例:

- `/items/` → 返回前 10 个
- `/items/?skip=20` → 跳过前 20 个
- `/items/?skip=0&limit=5` → 返回前 5 个

## 2. 参数声明规则

```python
@app.get("/items/{item_id}")
async def read_item(
    item_id: str,               # 路径参数
    q: str | None = None,       # 可选查询参数
    short: bool = False         # 带默认值的查询参数
):
    return {"item_id": item_id, "q": q, "short": short}
```

- **路径参数**: 在 URL 路径中，如 `{item_id}`
- **查询参数**: 不在路径中，可以有默认值!

## 3. 类型转换和验证

FastAPI 自动将 URL 字符串转换为 Python 类型

```python
@app.get("/data")
async def process_data(
    count: int = 0,           # "123" → 123
    price: float = 0.0,       # "19.99" → 19.99
    enabled: bool = False,    # "true" → True
    tags: list[str] = []      # 多个值自动组合成列表
):
    return {"count": count, "price": price, "enabled": enabled, "tags": tags}
```

### 3.1 布尔值转换

FastAPI 能识别多种布尔值:

- `true`, `True`, `TRUE`, `1`, `on`, `yes` → `True`
- `false`, `False`, `FALSE`, `0`, `off`, `no` → `False`

## 4. 必选查询参数

没有默认值的参数是必选的!

```python
@app.get("/items/{item_id}")
async def read_user_item(item_id: str, needy: str):  # needy 是必选的
    return {"item_id": item_id, "needy": needy}
```

如果访问时不提供 `needy` 参数，会返回错误。

## 5. 多值参数（列表）

使用 `list[str]` 接受多个同名参数:

```python
@app.get("/items/")
async def read_items(tags: list[str] | None = None):
    return {"tags": tags, "count": len(tags) if tags else 0}
```

访问示例:

- `/items/` → tags=None
- `/items/?tags=python` → tags=["python"]
- `/items/?tags=python&tags=fastapi` → tags=["python", "fastapi"]

## 6. 使用 Query 进行高级验证

```python
from fastapi import FastAPI, Query

@app.get("/items/")
async def read_items(
    q: str | None = Query(
        None,                   # 默认值
        min_length=3,           # 最小长度
        max_length=50,          # 最大长度
        title="搜索关键词",
        description="输入要搜索的关键词"
    ),
    page: int = Query(
        1,
        ge=1,                  # 大于等于 1
        le=1000,               # 小于等于 1000
        description="页码"
    )
):
    return {"q": q, "page": page}
```

## 7. 常用参数模式

### 7.1 分页

```python
@app.get("/api/posts")
async def get_posts(
    page: int = 1,           # 页码从 1 开始
    per_page: int = 20       # 每页数量
):
    # 实现分页逻辑
    pass
```

### 7.2 搜索和筛选

```python
@app.get("/api/products")
async def search_products(
    q: str | None = None,        # 搜索关键词
    category: str | None = None, # 分类筛选
    min_price: float = 0,        # 价格范围
    max_price: float = 99999
):
    # 实现搜索逻辑
    pass
```

### 7.3 排序

```python
@app.get("/api/users")
async def get_users(
    sort: str = "created_at",   # 排序字段
    order: str = "desc"         # 排序方向 asc/desc
):
    # 实现排序逻辑
    pass
```

## 8. 快速参考

| 功能         | 语法                          | 示例                       |
| ------------ | ----------------------------- | -------------------------- |
| 基本查询参数 | `param: type = default`       | `page: int = 1`            |
| 可选参数     | `param: type \| None = None`  | `q: str \| None = None`    |
| 必选参数     | `param: type`                 | `version: str`             |
| 多值参数     | `param: list[str]`            | `tags: list[str]`          |
| 验证         | `Query(default, constraints)` | `Query(..., min_length=3)` |
| 布尔参数     | `param: bool = default`       | `active: bool = True`      |

## 9. 实践示例

```python
from fastapi import FastAPI, Query
from typing import List, Optional

app = FastAPI()

# 用户列表 API
@app.get("/api/users")
async def get_users(
    page: int = Query(1, ge=1, description="页码"),
    per_page: int = Query(20, ge=1, le=100, description="每页数量"),
    search: Optional[str] = Query(None, max_length=100, description="搜索关键词"),
    active_only: bool = Query(True, description="只返回活跃用户"),
    sort: str = Query("created_at", regex="^(name|email|created_at)$", description="排序字段")
):
    """
    获取用户列表

    - page: 第几页（从1开始）
    - per_page: 每页多少用户
    - search: 搜索用户名或邮箱
    - active_only: 是否只返回活跃用户
    - sort: 排序字段
    """
    # 实现数据库查询
    # SELECT * FROM users
    # WHERE active = $active_only
    # AND (name ILIKE $search OR email ILIKE $search)
    # ORDER BY $sort
    # LIMIT $per_page OFFSET ($page-1)*$per_page
    pass

# 产品搜索 API
@app.get("/api/products")
async def search_products(
    q: Optional[str] = Query(None, description="搜索关键词"),
    category: List[str] = Query([], description="产品类别（可多选）"),
    min_price: float = Query(0, ge=0, description="最低价格"),
    max_price: float = Query(99999, ge=0, description="最高价格"),
    in_stock: bool = Query(True, description="是否有货"),
    on_sale: bool = Query(False, description="是否促销中")
):
    """
    搜索产品

    - q: 搜索产品名称
    - category: 类别筛选（可多选，如 ?category=electronics&category=phones）
    - min_price/max_price: 价格范围
    - in_stock: 只显示有货的商品
    - on_sale: 只显示促销商品
    """
    # 构建查询条件
    query = {"price": {"$gte": min_price, "$lte": max_price}}

    if q:
        query["name"] = {"$regex": q, "$options": "i"}

    if category:
        query["category"] = {"$in": category}

    if in_stock:
        query["stock"] = {"$gt": 0}

    if on_sale:
        query["discount"] = {"$gt": 0}

    return {"query": query}
```

## 10. 最佳实践

1. **提供合理的默认值**
2. **使用描述性参数名**
3. **设置参数限制防止滥用**
4. **组合使用路径参数和查询参数**
5. **保持 API 一致性**

**运行测试: **

```bash
fastapi dev main.py
```

测试这些 URL:

- `/api/users?page=2&per_page=10&search=john&active_only=false&sort=name`
- `/api/products?q=phone&category=electronics&category=phones&min_price=100&max_price=1000`
