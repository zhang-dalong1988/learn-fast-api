# 路径参数

## 1. 路径参数

FastAPI 使用 Python 的字符串格式化语法来声明路径参数(变量):

```python
from fastapi import FastAPI  # 导入 FastAPI 框架

app = FastAPI()  # 创建应用实例

@app.get("/items/{item_id}")  # 定义 GET 路由, {item_id} 是路径参数
async def read_item(item_id):  # item_id 参数会自动从 URL 路径中获取
    return {"item_id": item_id}  # 返回 JSON 响应
```

路径参数 `item_id` 的值会自动传递给函数的同名参数。

运行示例并访问 http://127.0.0.1:8000/items/foo, 将收到如下响应:

```json
{
  "item_id": "foo"
}
```

## 2. 声明路径参数的类型

通过 Python 标准类型注解, 可以为路径参数指定类型:

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/items/{item_id}")  # 路径参数定义
async def read_item(item_id: int):  # : int 表示期望接收整数类型
    return {"item_id": item_id}  # 返回的 item_id 将是整数而非字符串
```

在此示例中, `item_id` 被声明为 `int` 类型。

### 2.1 数据转换

访问 http://127.0.0.1:8000/items/3, 将收到如下响应:

```json
{
  "item_id": 3
}
```

**注意**: 函数接收和返回的是整数 `3`, 而非字符串 `"3"`。FastAPI 根据类型声明自动转换数据类型。

### 2.2 数据校验

访问 http://127.0.0.1:8000/items/foo, 将收到 HTTP 错误:

```json
{
  "detail": [
    {
      "loc": ["path", "item_id"],
      "msg": "value is not a valid integer",
      "type": "type_error.integer"
    }
  ]
}
```

这是由于路径参数 `"foo"` 无法转换为 `int` 类型所致。

同样, 浮点数(如 http://127.0.0.1:8000/items/4.2)也会触发相同错误。

**特点**: FastAPI 利用 Python 类型声明实现数据校验, 错误信息准确定位了校验失败的原因。

## 3. 自动文档

访问 http://127.0.0.1:8000/docs, 可查看自动生成的交互式 API 文档:

![Swagger UI 文档截图显示路径参数是整数类型](https://fastapi.tiangolo.com/img/tutorial/path-params/image01.png)

## 4. OpenAPI 兼容性

FastAPI 基于 OpenAPI 规范生成 schema,因此兼容众多工具。

ReDoc 提供了另一种文档界面, 访问 http://127.0.0.1:8000/redoc 查看:

![ReDoc 文档截图显示路径参数是整数类型](https://fastapi.tiangolo.com/img/tutorial/path-params/image02.png)

## 5. Pydantic 集成

FastAPI 深度集成 Pydantic, 利用其强大的数据校验能力。

除 `int` 外, `str`, `float`, `bool` 及各种复合数据类型均可使用类型声明。

## 6. 路径操作顺序

路径操作按声明顺序进行匹配, 因此顺序很重要。

例如, `/users/me` 用于获取当前用户信息, 而 `/users/{user_id}` 用于获取指定用户信息。

必须将固定路径 `/users/me` 放在参数化路径 `/users/{user_id}` 之前:

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/users/me")  # 固定路径 - 必须先定义
async def read_user_me():
    return {"user_id": "the current user"}

@app.get("/users/{user_id}")  # 参数化路径 - 必须后定义
async def read_user(user_id: str):
    return {"user_id": user_id}
```

如果顺序颠倒, `/users/{user_id}` 会匹配 `/users/me`, 将 `"me"` 当作 `user_id` 参数处理。

## 7. Enum 预设值

若路径参数只能接受特定的预定义值, 可使用 Python `Enum` 类。

### 7.1 创建 Enum 类

继承 `str` 和 `Enum` 创建枚举类：

```python
from enum import Enum
from fastapi import FastAPI

class ModelName(str, Enum):  # 继承 str 和 Enum, 使其既是字符串又是枚举
    alexnet = "alexnet"
    resnet = "resnet"
    lenet = "lenet"

app = FastAPI()

@app.get("/models/{model_name}")
async def get_model(model_name: ModelName):  # 参数使用枚举类型
    if model_name is ModelName.alexnet:  # 使用 is 比较枚举成员
        return {"model_name": model_name, "message": "Deep Learning FTW!"}

    if model_name.value == "lenet":  # 使用 .value 获取实际字符串值
        return {"model_name": model_name, "message": "LeCNN all the images"}

    return {"model_name": model_name, "message": "Have some residuals"}
```

继承 `str` 确保 API 文档将值正确显示为字符串类型。

### 7.2 枚举值操作

在 `get_model` 函数中:

- 使用 `ModelName.alexnet` 比较枚举成员
- 使用 `model_name.value` 获取实际值(`"alexnet"`, `"resnet"` 或 `"lenet"`)

### 7.3 文档展示

访问 http://127.0.0.1:8000/docs, API 文档将显示所有可用的枚举值:

![Swagger UI 文档截图显示可能的枚举值](https://fastapi.tiangolo.com/img/tutorial/path-params/image03.png)

## 8. 路径参数包含路径

当路径参数本身需要包含路径(如 `home/johndoe/myfile.txt`)时:

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/files/{file_path:path}")  # :path 是路径转换器, 允许匹配包含斜杠的路径
async def read_file(file_path: str):  # file_path 可以是 "home/user/file.txt"
    return {"file_path": file_path}
```

使用 `:path` 转换器声明该参数可匹配任意路径。

### 8.1 URL 格式

若 `file_path` 为 `/home/johndoe/myfile.txt`, 完整的 URL 为:

```
/files//home/johndoe/myfile.txt
```

**注意**: 路径前缀 `/` 导致 URL 中出现**双斜杠**。

### 8.2 OpenAPI 限制

OpenAPI 不支持包含路径的路径参数定义, 但 FastAPI 可通过 Starlette 实现此功能。

虽然文档正常工作, 但不会在 schema 中明确标注该参数包含路径。

## 9. 总结

通过简短的 Python 类型声明, FastAPI 提供:

- **编辑器支持**: 错误检查、自动补全等功能
- **数据解析**: 请求中数据的自动提取
- **数据校验**: 类型和格式的自动验证
- **自动文档**: OpenAPI schema 和交互式文档生成

一次声明, 多重收益。这是 FastAPI 相比其他框架的核心优势之一。
