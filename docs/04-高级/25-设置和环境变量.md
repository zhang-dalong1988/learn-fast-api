# 设置和环境变量 - FastAPI

在应用程序中管理设置和环境变量是一种常见需求。FastAPI 可以与各种设置管理解决方案很好地集成。

## 使用 Pydantic 的 `Settings`

FastAPI 提供了与 Pydantic 的 `Settings` 类的集成，使管理设置变得简单。

### 基本用法

```python
from pydantic_settings import BaseSettings
from fastapi import FastAPI


class Settings(BaseSettings):
    app_name: str = "FastAPI App"
    debug: bool = False
    database_url: str = "sqlite:///./test.db"
    secret_key: str = "your-secret-key-here"


settings = Settings()
app = FastAPI()


@app.get("/")
async def root():
    return {
        "app_name": settings.app_name,
        "debug": settings.debug,
        "database_url": settings.database_url,
    }
```

### 从环境变量读取

Pydantic 的 `BaseSettings` 会自动从环境变量中读取设置：

```python
from pydantic_settings import BaseSettings
from fastapi import FastAPI
from typing import Optional

class Settings(BaseSettings):
    app_name: str = "FastAPI App"
    debug: bool = False
    database_url: str = "sqlite:///./test.db"
    secret_key: str
    api_v1_str: str = "/api/v1"
    version: str = "0.1.0"
    description: str = "A FastAPI application"

    # 可选字段
    email: Optional[str] = None

    # 复杂类型
    allowed_origins: list[str] = ["*"]

    class Config:
        env_file = ".env"


settings = Settings()
app = FastAPI()


@app.get("/settings")
async def get_settings():
    return {
        "app_name": settings.app_name,
        "debug": settings.debug,
        "database_url": settings.database_url,
        "api_v1_str": settings.api_v1_str,
        "version": settings.version,
        "email": settings.email,
        "allowed_origins": settings.allowed_origins,
    }
```

### 创建 `.env` 文件

创建一个 `.env` 文件来存储环境变量：

```env
# .env
APP_NAME="My Production App"
DEBUG=false
DATABASE_URL="postgresql://user:password@host:port/dbname"
SECRET_KEY="super-secret-key-for-production"
EMAIL="admin@example.com"
ALLOWED_ORIGINS=["https://example.com", "https://api.example.com"]
```

## 不同环境的配置

### 开发环境配置

```python
# config.py
from pydantic_settings import BaseSettings
from typing import Optional


class Settings(BaseSettings):
    # 应用设置
    app_name: str = "My FastAPI App"
    debug: bool = True
    version: str = "0.1.0"

    # 数据库设置
    database_url: str = "sqlite:///./dev.db"

    # 安全设置
    secret_key: str = "dev-secret-key"

    # CORS 设置
    allowed_origins: list[str] = ["http://localhost:3000", "http://localhost:8080"]

    # 日志设置
    log_level: str = "DEBUG"

    class Config:
        env_file = ".env.dev"


# main.py
from fastapi import FastAPI
from config import Settings

settings = Settings()
app = FastAPI(debug=settings.debug)


@app.get("/")
async def root():
    return {"app_name": settings.app_name, "environment": "development"}
```

### 生产环境配置

```python
# config.py
from pydantic_settings import BaseSettings
from typing import Optional
import secrets


class Settings(BaseSettings):
    # 应用设置
    app_name: str
    debug: bool = False
    version: str = "1.0.0"

    # 数据库设置
    database_url: str

    # 安全设置
    secret_key: str = secrets.token_urlsafe(32)

    # CORS 设置
    allowed_origins: list[str] = []

    # 日志设置
    log_level: str = "INFO"

    # 其他设置
    max_connection_count: int = 10
    timeout_seconds: int = 30

    class Config:
        env_file = ".env.prod"


# main.py
from fastapi import FastAPI
from config import Settings

settings = Settings()
app = FastAPI()


@app.get("/")
async def root():
    return {"app_name": settings.app_name, "environment": "production"}
```

## 使用环境特定的配置文件

### 配置文件结构

```
project/
├── config/
│   ├── __init__.py
│   ├── base.py
│   ├── dev.py
│   ├── prod.py
│   └── test.py
├── .env
├── .env.dev
├── .env.prod
└── .env.test
```

### 基础配置类

```python
# config/base.py
from pydantic_settings import BaseSettings
from typing import Optional


class BaseSettings(BaseSettings):
    app_name: str = "My FastAPI App"
    version: str = "0.1.0"
    debug: bool = False

    # 数据库设置
    database_url: str = "sqlite:///./default.db"

    # 安全设置
    secret_key: str = "default-secret-key"

    # API 设置
    api_v1_str: str = "/api/v1"

    class Config:
        env_file = ".env"


# config/dev.py
from .base import BaseSettings


class DevelopmentSettings(BaseSettings):
    debug: bool = True
    database_url: str = "sqlite:///./dev.db"
    secret_key: str = "dev-secret-key"

    class Config:
        env_file = ".env.dev"


# config/prod.py
from .base import BaseSettings
import secrets


class ProductionSettings(BaseSettings):
    debug: bool = False
    secret_key: str = secrets.token_urlsafe(32)

    class Config:
        env_file = ".env.prod"


# config/test.py
from .base import BaseSettings


class TestSettings(BaseSettings):
    database_url: str = "sqlite:///./test.db"
    secret_key: str = "test-secret-key"

    class Config:
        env_file = ".env.test"


# config/__init__.py
from functools import lru_cache
import os
from typing import Union

from .base import BaseSettings
from .dev import DevelopmentSettings
from .prod import ProductionSettings
from .test import TestSettings


@lru_cache()
def get_settings() -> Union[DevelopmentSettings, ProductionSettings, TestSettings]:
    env = os.getenv("ENVIRONMENT", "dev").lower()

    if env == "prod":
        return ProductionSettings()
    elif env == "test":
        return TestSettings()
    else:
        return DevelopmentSettings()
```

### 在应用中使用配置

```python
# main.py
from fastapi import FastAPI
from config import get_settings

settings = get_settings()
app = FastAPI(debug=settings.debug)


@app.get("/")
async def root():
    return {
        "app_name": settings.app_name,
        "environment": os.getenv("ENVIRONMENT", "development"),
        "debug": settings.debug,
    }
```

## 在依赖项中使用设置

```python
from fastapi import FastAPI, Depends
from pydantic_settings import BaseSettings

app = FastAPI()


class Settings(BaseSettings):
    app_name: str = "My App"
    admin_email: str = "admin@example.com"


def get_settings() -> Settings:
    return Settings()


@app.get("/info")
async def get_info(settings: Settings = Depends(get_settings)):
    return {
        "app_name": settings.app_name,
        "admin_email": settings.admin_email,
    }
```

## 在测试中使用设置

```python
from fastapi import FastAPI
from fastapi.testclient import TestClient
from pydantic_settings import BaseSettings
import pytest

# 测试配置
class TestSettings(BaseSettings):
    app_name: str = "Test App"
    database_url: str = "sqlite:///./test.db"

    class Config:
        env_file = ".env.test"


app = FastAPI()
settings = TestSettings()


@app.get("/")
async def root():
    return {"app_name": settings.app_name}


def test_app():
    with TestClient(app) as client:
        response = client.get("/")
        assert response.json() == {"app_name": "Test App"}
```

## 管理敏感信息

### 使用 python-dotenv

```python
from pydantic_settings import BaseSettings
from typing import Optional

class Settings(BaseSettings):
    # 敏感信息
    database_password: str
    secret_key: str
    api_key: Optional[str] = None

    # 非敏感信息
    app_name: str = "My App"
    debug: bool = False

    class Config:
        env_file = ".env"
        case_sensitive = False  # 允许不区分大小写的环境变量
```

### 加载多个环境文件

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # 默认配置
    app_name: str = "My App"

    # 从 .env.local 覆盖
    local_setting: str = "default"

    # 从 .env.production 覆盖
    production_setting: str = "default"

    class Config:
        env_file = [".env", ".env.local"]
```

## 高级用法

### 类型转换

```python
from pydantic_settings import BaseSettings
from typing import List
from datetime import datetime, timedelta

class Settings(BaseSettings):
    # 自动类型转换
    timeout: int = 30  # 从环境变量 "TIMEOUT=60" 自动转换为 int
    enable_feature: bool = True  # 从 "ENABLE_FEATURE=false" 自动转换为 bool

    # 列表
    allowed_hosts: List[str] = ["localhost", "127.0.0.1"]

    # 日期时间
    maintenance_window_start: datetime = "2023-01-01T00:00:00"
    max_age: timedelta = "30d"  # 自动转换为 timedelta
```

### 验证设置

```python
from pydantic import validator, Field
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    database_url: str = Field(..., min_length=1)
    secret_key: str = Field(..., min_length=32)

    @validator("database_url")
    def validate_database_url(cls, v):
        if not v.startswith(("sqlite:///", "postgresql://", "mysql://")):
            raise ValueError("Database URL must start with sqlite:///, postgresql:// or mysql://")
        return v
```

## 最佳实践

1. **不要提交 .env 文件**：将 `.env` 添加到 `.gitignore`。

2. **使用 .env.example**：创建 `.env.example` 文件作为模板。

3. **分离敏感信息**：使用不同的配置文件管理不同环境的敏感信息。

4. **默认值**：为所有设置提供合理的默认值。

5. **验证**：使用 Pydantic 的验证功能确保设置的正确性。

6. **文档化**：在代码中记录每个设置的用途和格式。

7. **环境变量命名**：使用清晰、一致的环境变量命名约定。

## 更多信息

有关更多详细信息，请查看：

- [Pydantic Settings 文档](https://pydantic-docs.helpmanual.io/usage/settings/)
- [python-dotenv 文档](https://github.com/theskumar/python-dotenv)
- [FastAPI 配置指南](https://fastapi.tiangolo.com/advanced/settings/)