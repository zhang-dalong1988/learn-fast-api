# 生命周期事件 - FastAPI

您可以使用 `lifespan` 事件处理程序（启动和关闭）在应用程序启动时运行代码，在应用程序关闭时运行代码。

这对于设置数据库连接、加载机器学习模型等非常有用。

## 使用 `contextlib` 进行资源管理

对于资源管理（例如，创建数据库连接池或启动机器学习模型），建议使用 `contextlib.asynccontextmanager` 创建上下文管理器。

这在应用程序关闭时会自动清理资源。

## 使用 `lifespan` 事件处理器

要使用生命周期事件处理器，您可以在 FastAPI 应用程序中定义一个 `lifespan` 异步上下文管理器。

Python 3.10+

```python
from contextlib import asynccontextmanager

from fastapi import FastAPI


def fake_answer_to_everything_ml_model(x: float):
    return x * 42


ml_models = {}


@asynccontextmanager
async def lifespan(app: FastAPI):
    # Load the ML model
    ml_models["answer_to_everything"] = fake_answer_to_everything_ml_model
    yield
    # Clean up the ML models and release the resources
    ml_models.clear()


app = FastAPI(lifespan=lifespan)


@app.get("/predict")
async def predict(x: float):
    result = ml_models["answer_to_everything"](x)
    return {"result": result}
```

Python 3.9+

```python
from contextlib import asynccontextmanager

from fastapi import FastAPI


def fake_answer_to_everything_ml_model(x: float):
    return x * 42


ml_models = {}


@asynccontextmanager
async def lifespan(app: FastAPI):
    # Load the ML model
    ml_models["answer_to_everything"] = fake_answer_to_everything_ml_model
    yield
    # Clean up the ML models and release the resources
    ml_models.clear()


app = FastAPI(lifespan=lifespan)


@app.get("/predict")
async def predict(x: float):
    result = ml_models["answer_to_everything"](x)
    return {"result": result}
```

## 替代方案：`startup` 和 `shutdown` 事件处理器

如果您需要更细粒度的控制，您可以使用 `startup` 和 `shutdown` 事件处理器：

```python
from fastapi import FastAPI


app = FastAPI()


@app.on_event("startup")
async def startup_event():
    # Code to run when the application starts
    print("Application startup!")


@app.on_event("shutdown")
async def shutdown_event():
    # Code to run when the application shuts down
    print("Application shutdown!")
```

## 技术细节

### 事件处理程序执行顺序

- 所有 `startup` 事件处理程序在应用程序启动时按定义顺序执行。
- 所有 `shutdown` 事件处理程序在应用程序关闭时按相反顺序执行（后进先出）。

### 异常处理

如果在 `startup` 事件处理程序中发生异常，应用程序将不会启动。

如果在 `shutdown` 事件处理程序中发生异常，错误将被记录，但应用程序仍将继续关闭。

### 使用场景

- **数据库连接**：在启动时建立连接池，在关闭时关闭连接
- **机器学习模型**：在启动时加载模型，在关闭时释放内存
- **日志配置**：在启动时配置日志系统
- **缓存初始化**：在启动时初始化缓存系统

## 注意事项

1. **不要在事件处理程序中执行长时间运行的任务**，这会延迟应用程序的启动或关闭。
2. **确保在 `shutdown` 事件处理程序中正确释放资源**，以避免资源泄漏。
3. **在测试环境中**，您可能需要模拟这些事件处理程序的行为。

## 与依赖项系统集成

事件处理程序可以与 FastAPI 的依赖项系统一起使用：

```python
from fastapi import FastAPI, Depends
from contextlib import asynccontextmanager


app = FastAPI()


# Database dependency
async def get_db():
    # Database connection logic
    pass


@asynccontextmanager
async def lifespan(app: FastAPI):
    # Initialize resources
    print("Initializing application...")
    yield
    # Cleanup resources
    print("Cleaning up application...")


app = FastAPI(lifespan=lifespan)


@app.get("/")
async def root(db=Depends(get_db)):
    return {"message": "Hello World"}
```

## 测试生命周期事件

在测试环境中，您可能需要控制生命周期事件：

```python
from fastapi import FastAPI
from fastapi.testclient import TestClient
from contextlib import asynccontextmanager


@asynccontextmanager
async def lifespan(app: FastAPI):
    print("Starting up...")
    yield
    print("Shutting down...")


app = FastAPI(lifespan=lifespan)


def test_read_main():
    with TestClient(app) as client:
        response = client.get("/")
        assert response.status_code == 200
```

## 更多信息

有关更多详细信息，请查看 Starlette 关于事件处理程序的文档。