# ä»£ç†æœåŠ¡å™¨å - FastAPI

åœ¨è®¸å¤šæƒ…å†µä¸‹,æ‚¨ä¼šåœ¨ FastAPI åº”ç”¨ç¨‹åºå‰ä½¿ç”¨ä»£ç†,å¦‚ Traefik æˆ– Nginx.

è¿™äº›ä»£ç†å¯ä»¥å¤„ç† HTTPS è¯ä¹¦å’Œå…¶ä»–äº‹æƒ….

åœ¨æ‚¨åº”ç”¨ç¨‹åºå‰çš„ä»£ç†é€šå¸¸ä¼šåœ¨å°†è¯·æ±‚å‘é€ç»™æ‚¨çš„æœåŠ¡å™¨ä¹‹å‰åŠ¨æ€è®¾ç½®ä¸€äº›å¤´ä¿¡æ¯,è®©æœåŠ¡å™¨çŸ¥é“è¯·æ±‚å·²è¢«ä»£ç†è½¬å‘,è®©æœåŠ¡å™¨çŸ¥é“åŸå§‹çš„(å…¬å…±)URL,åŒ…æ‹¬åŸŸå,æ­£åœ¨ä½¿ç”¨ HTTPS ç­‰.

æœåŠ¡å™¨ç¨‹åº(ä¾‹å¦‚é€šè¿‡ FastAPI CLI çš„ Uvicorn)èƒ½å¤Ÿè§£é‡Šè¿™äº›å¤´ä¿¡æ¯,ç„¶åå°†è¯¥ä¿¡æ¯ä¼ é€’ç»™æ‚¨çš„åº”ç”¨ç¨‹åº.

ä½†ä¸ºäº†å®‰å…¨èµ·è§,ç”±äºæœåŠ¡å™¨ä¸çŸ¥é“å®ƒä½äºå—ä¿¡ä»»çš„ä»£ç†åé¢,å®ƒä¸ä¼šè§£é‡Šè¿™äº›å¤´ä¿¡æ¯.

æ‚¨å¯ä»¥ä½¿ç”¨ CLI é€‰é¡¹ `--forwarded-allow-ips` å¯åŠ¨ FastAPI CLI,å¹¶ä¼ é€’åº”è¯¥è¢«ä¿¡ä»»ä»¥è¯»å–è¿™äº›è½¬å‘å¤´ä¿¡æ¯çš„ IP åœ°å€.

å¦‚æœå°†å…¶è®¾ç½®ä¸º `--forwarded-allow-ips="*"`,å®ƒå°†ä¿¡ä»»æ‰€æœ‰ä¼ å…¥çš„ IP.

å¦‚æœæ‚¨çš„æœåŠ¡å™¨ä½äºå—ä¿¡ä»»çš„ä»£ç†åé¢,å¹¶ä¸”åªæœ‰ä»£ç†ä¸ä¹‹é€šä¿¡,è¿™å°†ä½¿å…¶æ¥å—è¯¥ä»£ç†çš„ä»»ä½• IP.

```bash
$ fastapi run --forwarded-allow-ips="*"

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

### ä½¿ç”¨ HTTPS çš„é‡å®šå‘

ä¾‹å¦‚,å‡è®¾æ‚¨å®šä¹‰äº†ä¸€ä¸ªè·¯å¾„æ“ä½œ `/items/`:

Python 3.8+

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/items/")
def read_items():
    return ["plumbus", "portal gun"]
```

å¦‚æœå®¢æˆ·ç«¯å°è¯•è®¿é—® `/items`,é»˜è®¤æƒ…å†µä¸‹,å®ƒå°†è¢«é‡å®šå‘åˆ° `/items/`.

ä½†åœ¨è®¾ç½® CLI é€‰é¡¹ `--forwarded-allow-ips` ä¹‹å‰,å®ƒå¯èƒ½ä¼šé‡å®šå‘åˆ° `http://localhost:8000/items/`.

ä½†ä¹Ÿè®¸æ‚¨çš„åº”ç”¨ç¨‹åºæ‰˜ç®¡åœ¨ `https://mysuperapp.com`,é‡å®šå‘åº”è¯¥åˆ° `https://mysuperapp.com/items/`.

é€šè¿‡è®¾ç½® `--proxy-headers`,ç°åœ¨ FastAPI å°†èƒ½å¤Ÿé‡å®šå‘åˆ°æ­£ç¡®çš„ä½ç½®.ğŸ˜

```
https://mysuperapp.com/items/
```

æç¤º

å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äº HTTPS çš„ä¿¡æ¯,è¯·æŸ¥çœ‹å…³äº HTTPS çš„æŒ‡å—.

ä»¥ä¸‹æ˜¯ä»£ç†å¦‚ä½•åœ¨å®¢æˆ·ç«¯å’Œåº”ç”¨ç¨‹åºæœåŠ¡å™¨ä¹‹é—´æ·»åŠ è½¬å‘å¤´çš„å¯è§†åŒ–è¡¨ç¤º:

```
sequenceDiagram
    participant Client
    participant Proxy as Proxy/Load Balancer
    participant Server as FastAPI Server

    Client->>Proxy: HTTPS Request<br/>Host: mysuperapp.com<br/>Path: /items

    Note over Proxy: Proxy adds forwarded headers

    Proxy->>Server: HTTP Request<br/>X-Forwarded-For: [client IP]<br/>X-Forwarded-Proto: https<br/>X-Forwarded-Host: mysuperapp.com<br/>Path: /items

    Note over Server: Server interprets headers<br/>(if --forwarded-allow-ips is set)

    Server->>Proxy: HTTP Response<br/>with correct HTTPS URLs

    Proxy->>Client: HTTPS Response
```

ä»£ç†æ‹¦æˆªåŸå§‹å®¢æˆ·ç«¯è¯·æ±‚,å¹¶åœ¨å°†è¯·æ±‚ä¼ é€’ç»™åº”ç”¨ç¨‹åºæœåŠ¡å™¨ä¹‹å‰æ·»åŠ ç‰¹æ®Šçš„è½¬å‘å¤´(`X-Forwarded-*`).

è¿™äº›å¤´ä¿¡æ¯ä¿ç•™äº†å¦åˆ™ä¼šä¸¢å¤±çš„å…³äºåŸå§‹è¯·æ±‚çš„ä¿¡æ¯:

- **X-Forwarded-For**:åŸå§‹å®¢æˆ·ç«¯çš„ IP åœ°å€
- **X-Forwarded-Proto**:åŸå§‹åè®®(`https`)
- **X-Forwarded-Host**:åŸå§‹ä¸»æœº(`mysuperapp.com`)

å½“ FastAPI CLI é…ç½®äº† `--forwarded-allow-ips` æ—¶,å®ƒä¿¡ä»»è¿™äº›å¤´ä¿¡æ¯å¹¶ä½¿ç”¨å®ƒä»¬,ä¾‹å¦‚åœ¨é‡å®šå‘ä¸­ç”Ÿæˆæ­£ç¡®çš„ URL.

## å¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„ä»£ç†

æ‚¨å¯èƒ½æœ‰ä¸€ä¸ªä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºæ·»åŠ è·¯å¾„å‰ç¼€çš„ä»£ç†.

åœ¨è¿™äº›æƒ…å†µä¸‹,æ‚¨å¯ä»¥ä½¿ç”¨ `root_path` æ¥é…ç½®æ‚¨çš„åº”ç”¨ç¨‹åº.

`root_path` æ˜¯ ASGI è§„èŒƒ(FastAPI é€šè¿‡ Starlette æ„å»ºäºå…¶ä¸Š)æä¾›çš„æœºåˆ¶.

`root_path` ç”¨äºå¤„ç†è¿™äº›ç‰¹å®šæƒ…å†µ.

å®ƒä¹Ÿåœ¨æŒ‚è½½å­åº”ç”¨ç¨‹åºæ—¶åœ¨å†…éƒ¨ä½¿ç”¨.

åœ¨è¿™ç§æƒ…å†µä¸‹,å¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„ä»£ç†æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ä»£ç ä¸­å£°æ˜ä¸€ä¸ªä½äº `/app` çš„è·¯å¾„,ä½†ç„¶åæ‚¨åœ¨å…¶ä¸Šæ·»åŠ ä¸€ä¸ªå±‚(ä»£ç†),å°†æ‚¨çš„ FastAPI åº”ç”¨ç¨‹åºæ”¾åœ¨åƒ `/api/v1` è¿™æ ·çš„è·¯å¾„ä¸‹.

åœ¨è¿™ç§æƒ…å†µä¸‹,åŸå§‹è·¯å¾„ `/app` å®é™…ä¸Šå°†åœ¨ `/api/v1/app` ä¸Šæä¾›æœåŠ¡.

å³ä½¿æ‚¨æ‰€æœ‰çš„ä»£ç éƒ½æ˜¯åœ¨å‡è®¾åªæœ‰ `/app` çš„æƒ…å†µä¸‹ç¼–å†™çš„.

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI()

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

ä»£ç†å°†åœ¨å°†è¯·æ±‚ä¼ è¾“ç»™åº”ç”¨ç¨‹åºæœåŠ¡å™¨(å¯èƒ½æ˜¯é€šè¿‡ FastAPI CLI çš„ Uvicorn)ä¹‹å‰åŠ¨æ€"å‰¥ç¦»"è·¯å¾„å‰ç¼€,è®©æ‚¨çš„åº”ç”¨ç¨‹åºç¡®ä¿¡å®ƒåœ¨ `/app` ä¸Šæä¾›æœåŠ¡,è¿™æ ·æ‚¨å°±ä¸å¿…æ›´æ–°æ‰€æœ‰ä»£ç ä»¥åŒ…å«å‰ç¼€ `/api/v1`.

åˆ°è¿™é‡Œä¸ºæ­¢,ä¸€åˆ‡éƒ½å°†æ­£å¸¸å·¥ä½œ.

ä½†æ˜¯,å½“æ‚¨æ‰“å¼€é›†æˆçš„æ–‡æ¡£ UI(å‰ç«¯)æ—¶,å®ƒä¼šæœŸæœ›åœ¨ `/openapi.json` è·å– OpenAPI æ¨¡å¼,è€Œä¸æ˜¯ `/api/v1/openapi.json`.

æ‰€ä»¥,å‰ç«¯(åœ¨æµè§ˆå™¨ä¸­è¿è¡Œ)å°†å°è¯•è®¿é—® `/openapi.json`,ä½†æ— æ³•è·å– OpenAPI æ¨¡å¼.

å› ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæœ‰ä¸€ä¸ªè·¯å¾„å‰ç¼€ä¸º `/api/v1` çš„ä»£ç†,å‰ç«¯éœ€è¦åœ¨ `/api/v1/openapi.json` è·å– OpenAPI æ¨¡å¼.

```
graph LR

browser("Browser")
proxy["Proxy on http://0.0.0.0:9999/api/v1/app"]
server["Server on http://127.0.0.1:8000/app"]

browser --> proxy
proxy --> server
```

æç¤º

IP `0.0.0.0` é€šå¸¸ç”¨äºè¡¨ç¤ºç¨‹åºç›‘å¬è¯¥æœºå™¨/æœåŠ¡å™¨ä¸Šæ‰€æœ‰å¯ç”¨çš„ IP.

æ–‡æ¡£ UI è¿˜éœ€è¦ OpenAPI æ¨¡å¼æ¥å£°æ˜è¿™ä¸ª API `æœåŠ¡å™¨` ä½äº `/api/v1`(åœ¨ä»£ç†åé¢).ä¾‹å¦‚:

```json
{
    "openapi": "3.1.0",
    // More stuff here
    "servers": [
        {
            "url": "/api/v1"
        }
    ],
    "paths": {
            // More stuff here
    }
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­,"ä»£ç†"å¯èƒ½ç±»ä¼¼äº Traefik.æœåŠ¡å™¨å°†æ˜¯ç±»ä¼¼äºå¸¦æœ‰ Uvicorn çš„ FastAPI CLI,è¿è¡Œæ‚¨çš„ FastAPI åº”ç”¨ç¨‹åº.

### æä¾› `root_path`

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹,æ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹ `--root-path`,å¦‚:

```bash
$ fastapi run main.py --forwarded-allow-ips="*" --root-path /api/v1

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

å¦‚æœæ‚¨ä½¿ç”¨ Hypercorn,å®ƒä¹Ÿæœ‰é€‰é¡¹ `--root-path`.

æŠ€æœ¯ç»†èŠ‚

ASGI è§„èŒƒä¸ºè¿™ä¸ªç”¨ä¾‹å®šä¹‰äº†ä¸€ä¸ª `root_path`.

`--root-path` å‘½ä»¤è¡Œé€‰é¡¹æä¾›äº†é‚£ä¸ª `root_path`.

### æ£€æŸ¥å½“å‰çš„ `root_path`

æ‚¨å¯ä»¥è·å–åº”ç”¨ç¨‹åºä¸ºæ¯ä¸ªè¯·æ±‚ä½¿ç”¨çš„å½“å‰ `root_path`,å®ƒæ˜¯ `scope` å­—å…¸(ASGI è§„èŒƒçš„ä¸€éƒ¨åˆ†)çš„ä¸€éƒ¨åˆ†.

è¿™é‡Œæˆ‘ä»¬åœ¨æ¶ˆæ¯ä¸­åŒ…å«å®ƒä»…ç”¨äºæ¼”ç¤ºç›®çš„.

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI()

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

ç„¶å,å¦‚æœæ‚¨ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¯åŠ¨ Uvicorn:

```bash
$ fastapi run main.py --forwarded-allow-ips="*" --root-path /api/v1

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

å“åº”å°†ç±»ä¼¼äº:

```json
{
    "message": "Hello World",
    "root_path": "/api/v1"
}
```

### åœ¨ FastAPI åº”ç”¨ç¨‹åºä¸­è®¾ç½® `root_path`

æˆ–è€…,å¦‚æœæ‚¨æ²¡æœ‰åŠæ³•æä¾›åƒ `--root-path` è¿™æ ·çš„å‘½ä»¤è¡Œé€‰é¡¹æˆ–ç­‰æ•ˆé¡¹,æ‚¨å¯ä»¥åœ¨åˆ›å»º FastAPI åº”ç”¨ç¨‹åºæ—¶è®¾ç½® `root_path` å‚æ•°:

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI(root_path="/api/v1")

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

å°† `root_path` ä¼ é€’ç»™ `FastAPI` ç›¸å½“äºå°† `--root-path` å‘½ä»¤è¡Œé€‰é¡¹ä¼ é€’ç»™ Uvicorn æˆ– Hypercorn.

### å…³äº `root_path`

è¯·è®°ä½,æœåŠ¡å™¨(Uvicorn)ä¸ä¼šå°†è¯¥ `root_path` ç”¨äºé™¤å°†å…¶ä¼ é€’ç»™åº”ç”¨ç¨‹åºä¹‹å¤–çš„ä»»ä½•å…¶ä»–ç›®çš„.

ä½†å¦‚æœæ‚¨ä½¿ç”¨æµè§ˆå™¨è®¿é—® http://127.0.0.1:8000/app,æ‚¨å°†çœ‹åˆ°æ­£å¸¸å“åº”:

```json
{
    "message": "Hello World",
    "root_path": "/api/v1"
}
```

æ‰€ä»¥,å®ƒä¸ä¼šæœŸæœ›åœ¨ `http://127.0.0.1:8000/api/v1/app` è®¿é—®.

Uvicorn å°†æœŸæœ›ä»£ç†åœ¨ `http://127.0.0.1:8000/app` è®¿é—® Uvicorn,ç„¶åä»£ç†å°†è´Ÿè´£åœ¨å…¶ä¸Šæ·»åŠ é¢å¤–çš„ `/api/v1` å‰ç¼€.

## å…³äºå¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„ä»£ç†

è¯·è®°ä½,å¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„ä»£ç†åªæ˜¯é…ç½®å®ƒçš„ä¸€ç§æ–¹å¼.

å¯èƒ½åœ¨è®¸å¤šæƒ…å†µä¸‹,é»˜è®¤å°†æ˜¯ä»£ç†æ²¡æœ‰å‰¥ç¦»çš„è·¯å¾„å‰ç¼€.

åœ¨è¿™ç§æƒ…å†µä¸‹(æ²¡æœ‰å‰¥ç¦»çš„è·¯å¾„å‰ç¼€),ä»£ç†å°†åœ¨åƒ `https://myawesomeapp.com` è¿™æ ·çš„åœ°æ–¹ç›‘å¬,ç„¶åå¦‚æœæµè§ˆå™¨è®¿é—® `https://myawesomeapp.com/api/v1/app`,è€Œæ‚¨çš„æœåŠ¡å™¨(ä¾‹å¦‚ Uvicorn)åœ¨ `http://127.0.0.1:8000` ä¸Šç›‘å¬,ä»£ç†(æ²¡æœ‰å‰¥ç¦»çš„è·¯å¾„å‰ç¼€)å°†åœ¨ç›¸åŒçš„è·¯å¾„è®¿é—® Uvicorn:`http://127.0.0.1:8000/api/v1/app`.

## ä½¿ç”¨ Traefik æœ¬åœ°æµ‹è¯•

æ‚¨å¯ä»¥ä½¿ç”¨ Traefik è½»æ¾åœ°åœ¨æœ¬åœ°è¿è¡Œå¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„å®éªŒ.

ä¸‹è½½ Traefik,å®ƒæ˜¯ä¸€ä¸ªå•ç‹¬çš„äºŒè¿›åˆ¶æ–‡ä»¶,æ‚¨å¯ä»¥è§£å‹ç¼©æ–‡ä»¶å¹¶ç›´æ¥ä»ç»ˆç«¯è¿è¡Œ.

ç„¶ååˆ›å»ºä¸€ä¸ªæ–‡ä»¶ `traefik.toml`:

```toml
[entryPoints]
  [entryPoints.http]
    address = ":9999"

[providers]
  [providers.file]
    filename = "routes.toml"
```

è¿™å‘Šè¯‰ Traefik åœ¨ç«¯å£ 9999 ä¸Šç›‘å¬å¹¶ä½¿ç”¨å¦ä¸€ä¸ªæ–‡ä»¶ `routes.toml`.

æç¤º

æˆ‘ä»¬ä½¿ç”¨ç«¯å£ 9999 è€Œä¸æ˜¯æ ‡å‡† HTTP ç«¯å£ 80,è¿™æ ·æ‚¨å°±ä¸å¿…ä½¿ç”¨ç®¡ç†å‘˜(`sudo`)æƒé™è¿è¡Œå®ƒ.

ç°åœ¨åˆ›å»ºå¦ä¸€ä¸ªæ–‡ä»¶ `routes.toml`:

```toml
[http]
  [http.middlewares]

    [http.middlewares.api-stripprefix.stripPrefix]
      prefixes = ["/api/v1"]

  [http.routers]

    [http.routers.app-http]
      entryPoints = ["http"]
      service = "app"
      rule = "PathPrefix(`/api/v1`)"
      middlewares = ["api-stripprefix"]

  [http.services]

    [http.services.app]
      [http.services.app.loadBalancer]
        [[http.services.app.loadBalancer.servers]]
          url = "http://127.0.0.1:8000"
```

è¿™ä¸ªæ–‡ä»¶é…ç½® Traefik ä½¿ç”¨è·¯å¾„å‰ç¼€ `/api/v1`.

ç„¶å Traefik å°†å°†å…¶è¯·æ±‚é‡å®šå‘åˆ°æ‚¨åœ¨ `http://127.0.0.1:8000` ä¸Šè¿è¡Œçš„ Uvicorn.

ç°åœ¨å¯åŠ¨ Traefik:

```bash
$ ./traefik --configFile=traefik.toml

INFO[0000] Configuration loaded from file: /home/user/awesomeapi/traefik.toml
```

ç°åœ¨ä½¿ç”¨ `--root-path` é€‰é¡¹å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åº:

```bash
$ fastapi run main.py --forwarded-allow-ips="*" --root-path /api/v1

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

### æ£€æŸ¥å“åº”

ç°åœ¨,å¦‚æœæ‚¨è®¿é—® Uvicorn ç«¯å£çš„ URL:http://127.0.0.1:8000/app,æ‚¨å°†çœ‹åˆ°æ­£å¸¸å“åº”:

```json
{
    "message": "Hello World",
    "root_path": "/api/v1"
}
```

æç¤º

è¯·æ³¨æ„,å³ä½¿æ‚¨åœ¨ `http://127.0.0.1:8000/app` è®¿é—®å®ƒ,å®ƒä¹Ÿæ˜¾ç¤ºæ¥è‡ªé€‰é¡¹ `--root-path` çš„ `/api/v1` çš„ `root_path`.

ç°åœ¨æ‰“å¼€ Traefik ç«¯å£çš„ URL,åŒ…æ‹¬è·¯å¾„å‰ç¼€:http://127.0.0.1:9999/api/v1/app.

æˆ‘ä»¬å¾—åˆ°ç›¸åŒçš„å“åº”:

```json
{
    "message": "Hello World",
    "root_path": "/api/v1"
}
```

ä½†è¿™æ¬¡æ˜¯åœ¨å¸¦æœ‰ä»£ç†æä¾›çš„å‰ç¼€è·¯å¾„çš„ URL ä¸Š:`/api/v1`.

å½“ç„¶,è¿™é‡Œçš„æƒ³æ³•æ˜¯æ¯ä¸ªäººéƒ½é€šè¿‡ä»£ç†è®¿é—®åº”ç”¨ç¨‹åº,æ‰€ä»¥å¸¦æœ‰è·¯å¾„å‰ç¼€ `/api/v1` çš„ç‰ˆæœ¬æ˜¯"æ­£ç¡®"çš„ç‰ˆæœ¬.

è€Œæ²¡æœ‰è·¯å¾„å‰ç¼€(`http://127.0.0.1:8000/app`)çš„ç‰ˆæœ¬,ç”± Uvicorn ç›´æ¥æä¾›,å°†ä¸“é—¨ä¾›ä»£ç†(Traefik)è®¿é—®.

è¿™æ¼”ç¤ºäº†ä»£ç†(Traefik)å¦‚ä½•ä½¿ç”¨è·¯å¾„å‰ç¼€ä»¥åŠæœåŠ¡å™¨(Uvicorn)å¦‚ä½•ä½¿ç”¨æ¥è‡ªé€‰é¡¹ `--root-path` çš„ `root_path`.

### æ£€æŸ¥æ–‡æ¡£ UI

ä½†è¿™æ˜¯æœ‰è¶£çš„éƒ¨åˆ†.âœ¨

è®¿é—®åº”ç”¨ç¨‹åºçš„"å®˜æ–¹"æ–¹å¼æ˜¯é€šè¿‡æˆ‘ä»¬å®šä¹‰çš„å¸¦æœ‰è·¯å¾„å‰ç¼€çš„ä»£ç†.æ‰€ä»¥,æ­£å¦‚æˆ‘ä»¬é¢„æœŸçš„é‚£æ ·,å¦‚æœæ‚¨å°è¯• Uvicorn ç›´æ¥æä¾›çš„æ–‡æ¡£ UI,URL ä¸­æ²¡æœ‰è·¯å¾„å‰ç¼€,å®ƒå°†æ— æ³•å·¥ä½œ,å› ä¸ºå®ƒæœŸæœ›é€šè¿‡ä»£ç†è®¿é—®.

æ‚¨å¯ä»¥åœ¨ http://127.0.0.1:8000/docs æ£€æŸ¥å®ƒ:

![å›¾ç‰‡ 1](https://fastapi.tiangolo.com/img/tutorial/behind-a-proxy/image01.png)

ä½†å¦‚æœæˆ‘ä»¬åœ¨"å®˜æ–¹" URL ä½¿ç”¨å¸¦æœ‰ç«¯å£ `9999` çš„ä»£ç†è®¿é—®æ–‡æ¡£ UI,åœ¨ `/api/v1/docs`,å®ƒæ­£ç¡®å·¥ä½œ!ğŸ‰

æ‚¨å¯ä»¥åœ¨ http://127.0.0.1:9999/api/v1/docs æ£€æŸ¥å®ƒ:

![å›¾ç‰‡ 2](https://fastapi.tiangolo.com/img/tutorial/behind-a-proxy/image02.png)

æ­£å¦‚æˆ‘ä»¬æƒ³è¦çš„.âœ”ï¸

è¿™æ˜¯å› ä¸º FastAPI ä½¿ç”¨è¿™ä¸ª `root_path` æ¥åœ¨ OpenAPI ä¸­ä½¿ç”¨ `root_path` æä¾›çš„ URL åˆ›å»ºé»˜è®¤çš„ `æœåŠ¡å™¨`.

## é™„åŠ æœåŠ¡å™¨

è­¦å‘Š

è¿™æ˜¯ä¸€ä¸ªæ›´é«˜çº§çš„ç”¨ä¾‹.è¯·éšæ„è·³è¿‡å®ƒ.

é»˜è®¤æƒ…å†µä¸‹,FastAPI å°†åœ¨ OpenAPI æ¨¡å¼ä¸­åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ `root_path` URL çš„ `æœåŠ¡å™¨`.

ä½†æ‚¨ä¹Ÿå¯ä»¥æä¾›å…¶ä»–æ›¿ä»£çš„ `æœåŠ¡å™¨`,ä¾‹å¦‚,å¦‚æœæ‚¨å¸Œæœ›ç›¸åŒçš„æ–‡æ¡£ UI ä¸é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒäº¤äº’.

å¦‚æœæ‚¨ä¼ é€’è‡ªå®šä¹‰çš„ `æœåŠ¡å™¨` åˆ—è¡¨å¹¶ä¸”æœ‰ä¸€ä¸ª `root_path`(å› ä¸ºæ‚¨çš„ API ä½äºä»£ç†åé¢),FastAPI å°†åœ¨åˆ—è¡¨çš„å¼€å¤´æ’å…¥ä¸€ä¸ªå¸¦æœ‰è¿™ä¸ª `root_path` çš„"æœåŠ¡å™¨".

ä¾‹å¦‚:

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI(
    servers=[
        {"url": "https://stag.example.com", "description": "Staging environment"},
        {"url": "https://prod.example.com", "description": "Production environment"},
    ],
    root_path="/api/v1",
)

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

å°†ç”Ÿæˆå¦‚ä¸‹çš„ OpenAPI æ¨¡å¼:

```json
{
    "openapi": "3.1.0",
    // More stuff here
    "servers": [
        {
            "url": "/api/v1"
        },
        {
            "url": "https://stag.example.com",
            "description": "Staging environment"
        },
        {
            "url": "https://prod.example.com",
            "description": "Production environment"
        }
    ],
    "paths": {
            // More stuff here
    }
}
```

æç¤º

è¯·æ³¨æ„è‡ªåŠ¨ç”Ÿæˆçš„æœåŠ¡å™¨,`url` å€¼ä¸º `/api/v1`,å–è‡ª `root_path`.

åœ¨ http://127.0.0.1:9999/api/v1/docs çš„æ–‡æ¡£ UI ä¸­,å®ƒå°†çœ‹èµ·æ¥åƒ:

![å›¾ç‰‡ 3](https://fastapi.tiangolo.com/img/tutorial/behind-a-proxy/image03.png)

æç¤º

æ–‡æ¡£ UI å°†ä¸æ‚¨é€‰æ‹©çš„æœåŠ¡å™¨äº¤äº’.

### ç¦ç”¨æ¥è‡ª `root_path` çš„è‡ªåŠ¨æœåŠ¡å™¨

å¦‚æœæ‚¨ä¸å¸Œæœ› FastAPI åŒ…å«ä½¿ç”¨ `root_path` çš„è‡ªåŠ¨æœåŠ¡å™¨,æ‚¨å¯ä»¥ä½¿ç”¨å‚æ•° `root_path_in_servers=False`:

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI(
    servers=[
        {"url": "https://stag.example.com", "description": "Staging environment"},
        {"url": "https://prod.example.com", "description": "Production environment"},
    ],
    root_path="/api/v1",
    root_path_in_servers=False,
)

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

ç„¶åå®ƒä¸ä¼šåŒ…å«åœ¨ OpenAPI æ¨¡å¼ä¸­.

## æŒ‚è½½å­åº”ç”¨ç¨‹åº

å¦‚æœæ‚¨éœ€è¦æŒ‚è½½å­åº”ç”¨ç¨‹åº(å¦‚å­åº”ç”¨ç¨‹åº - æŒ‚è½½ä¸­æ‰€è¿°),åŒæ—¶è¿˜ä½¿ç”¨å¸¦æœ‰ `root_path` çš„ä»£ç†,æ‚¨å¯ä»¥æ­£å¸¸è¿›è¡Œ,æ­£å¦‚æ‚¨æ‰€æœŸæœ›çš„é‚£æ ·.

FastAPI å°†åœ¨å†…éƒ¨æ™ºèƒ½åœ°ä½¿ç”¨ `root_path`,æ‰€ä»¥å®ƒå°±æ˜¯èƒ½å·¥ä½œ.âœ¨