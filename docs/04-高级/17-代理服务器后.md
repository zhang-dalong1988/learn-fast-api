# ä»£ç†æœåŠ¡å™¨å - FastAPI

åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ‚¨ä¼šåœ¨ FastAPI åº”ç”¨ç¨‹åºå‰ä½¿ç”¨ä»£ç†ï¼Œå¦‚ Traefik æˆ– Nginxã€‚

è¿™äº›ä»£ç†å¯ä»¥å¤„ç† HTTPS è¯ä¹¦å’Œå…¶ä»–äº‹æƒ…ã€‚

åœ¨æ‚¨åº”ç”¨ç¨‹åºå‰çš„ä»£ç†é€šå¸¸ä¼šåœ¨å°†è¯·æ±‚å‘é€ç»™æ‚¨çš„æœåŠ¡å™¨ä¹‹å‰åŠ¨æ€è®¾ç½®ä¸€äº›å¤´ä¿¡æ¯ï¼Œè®©æœåŠ¡å™¨çŸ¥é“è¯·æ±‚å·²è¢«ä»£ç†è½¬å‘ï¼Œè®©æœåŠ¡å™¨çŸ¥é“åŸå§‹çš„ï¼ˆå…¬å…±ï¼‰URLï¼ŒåŒ…æ‹¬åŸŸåï¼Œæ­£åœ¨ä½¿ç”¨ HTTPS ç­‰ã€‚

æœåŠ¡å™¨ç¨‹åºï¼ˆä¾‹å¦‚é€šè¿‡ FastAPI CLI çš„ Uvicornï¼‰èƒ½å¤Ÿè§£é‡Šè¿™äº›å¤´ä¿¡æ¯ï¼Œç„¶åå°†è¯¥ä¿¡æ¯ä¼ é€’ç»™æ‚¨çš„åº”ç”¨ç¨‹åºã€‚

ä½†ä¸ºäº†å®‰å…¨èµ·è§ï¼Œç”±äºæœåŠ¡å™¨ä¸çŸ¥é“å®ƒä½äºå—ä¿¡ä»»çš„ä»£ç†åé¢ï¼Œå®ƒä¸ä¼šè§£é‡Šè¿™äº›å¤´ä¿¡æ¯ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨ CLI é€‰é¡¹ `--forwarded-allow-ips` å¯åŠ¨ FastAPI CLIï¼Œå¹¶ä¼ é€’åº”è¯¥è¢«ä¿¡ä»»ä»¥è¯»å–è¿™äº›è½¬å‘å¤´ä¿¡æ¯çš„ IP åœ°å€ã€‚

å¦‚æœå°†å…¶è®¾ç½®ä¸º `--forwarded-allow-ips="*"`ï¼Œå®ƒå°†ä¿¡ä»»æ‰€æœ‰ä¼ å…¥çš„ IPã€‚

å¦‚æœæ‚¨çš„æœåŠ¡å™¨ä½äºå—ä¿¡ä»»çš„ä»£ç†åé¢ï¼Œå¹¶ä¸”åªæœ‰ä»£ç†ä¸ä¹‹é€šä¿¡ï¼Œè¿™å°†ä½¿å…¶æ¥å—è¯¥ä»£ç†çš„ä»»ä½• IPã€‚

```bash
$ fastapi run --forwarded-allow-ips="*"

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

### ä½¿ç”¨ HTTPS çš„é‡å®šå‘

ä¾‹å¦‚ï¼Œå‡è®¾æ‚¨å®šä¹‰äº†ä¸€ä¸ªè·¯å¾„æ“ä½œ `/items/`ï¼š

Python 3.8+

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/items/")
def read_items():
    return ["plumbus", "portal gun"]
```

å¦‚æœå®¢æˆ·ç«¯å°è¯•è®¿é—® `/items`ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå°†è¢«é‡å®šå‘åˆ° `/items/`ã€‚

ä½†åœ¨è®¾ç½® CLI é€‰é¡¹ `--forwarded-allow-ips` ä¹‹å‰ï¼Œå®ƒå¯èƒ½ä¼šé‡å®šå‘åˆ° `http://localhost:8000/items/`ã€‚

ä½†ä¹Ÿè®¸æ‚¨çš„åº”ç”¨ç¨‹åºæ‰˜ç®¡åœ¨ `https://mysuperapp.com`ï¼Œé‡å®šå‘åº”è¯¥åˆ° `https://mysuperapp.com/items/`ã€‚

é€šè¿‡è®¾ç½® `--proxy-headers`ï¼Œç°åœ¨ FastAPI å°†èƒ½å¤Ÿé‡å®šå‘åˆ°æ­£ç¡®çš„ä½ç½®ã€‚ğŸ˜

```
https://mysuperapp.com/items/
```

æç¤º

å¦‚æœæ‚¨æƒ³äº†è§£æ›´å¤šå…³äº HTTPS çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹å…³äº HTTPS çš„æŒ‡å—ã€‚

ä»¥ä¸‹æ˜¯ä»£ç†å¦‚ä½•åœ¨å®¢æˆ·ç«¯å’Œåº”ç”¨ç¨‹åºæœåŠ¡å™¨ä¹‹é—´æ·»åŠ è½¬å‘å¤´çš„å¯è§†åŒ–è¡¨ç¤ºï¼š

```
sequenceDiagram
    participant Client
    participant Proxy as Proxy/Load Balancer
    participant Server as FastAPI Server

    Client->>Proxy: HTTPS Request<br/>Host: mysuperapp.com<br/>Path: /items

    Note over Proxy: Proxy adds forwarded headers

    Proxy->>Server: HTTP Request<br/>X-Forwarded-For: [client IP]<br/>X-Forwarded-Proto: https<br/>X-Forwarded-Host: mysuperapp.com<br/>Path: /items

    Note over Server: Server interprets headers<br/>(if --forwarded-allow-ips is set)

    Server->>Proxy: HTTP Response<br/>with correct HTTPS URLs

    Proxy->>Client: HTTPS Response
```

ä»£ç†æ‹¦æˆªåŸå§‹å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¹¶åœ¨å°†è¯·æ±‚ä¼ é€’ç»™åº”ç”¨ç¨‹åºæœåŠ¡å™¨ä¹‹å‰æ·»åŠ ç‰¹æ®Šçš„è½¬å‘å¤´ï¼ˆ`X-Forwarded-*`ï¼‰ã€‚

è¿™äº›å¤´ä¿¡æ¯ä¿ç•™äº†å¦åˆ™ä¼šä¸¢å¤±çš„å…³äºåŸå§‹è¯·æ±‚çš„ä¿¡æ¯ï¼š

- **X-Forwarded-For**ï¼šåŸå§‹å®¢æˆ·ç«¯çš„ IP åœ°å€
- **X-Forwarded-Proto**ï¼šåŸå§‹åè®®ï¼ˆ`https`ï¼‰
- **X-Forwarded-Host**ï¼šåŸå§‹ä¸»æœºï¼ˆ`mysuperapp.com`ï¼‰

å½“ FastAPI CLI é…ç½®äº† `--forwarded-allow-ips` æ—¶ï¼Œå®ƒä¿¡ä»»è¿™äº›å¤´ä¿¡æ¯å¹¶ä½¿ç”¨å®ƒä»¬ï¼Œä¾‹å¦‚åœ¨é‡å®šå‘ä¸­ç”Ÿæˆæ­£ç¡®çš„ URLã€‚

## å¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„ä»£ç†

æ‚¨å¯èƒ½æœ‰ä¸€ä¸ªä¸ºæ‚¨çš„åº”ç”¨ç¨‹åºæ·»åŠ è·¯å¾„å‰ç¼€çš„ä»£ç†ã€‚

åœ¨è¿™äº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `root_path` æ¥é…ç½®æ‚¨çš„åº”ç”¨ç¨‹åºã€‚

`root_path` æ˜¯ ASGI è§„èŒƒï¼ˆFastAPI é€šè¿‡ Starlette æ„å»ºäºå…¶ä¸Šï¼‰æä¾›çš„æœºåˆ¶ã€‚

`root_path` ç”¨äºå¤„ç†è¿™äº›ç‰¹å®šæƒ…å†µã€‚

å®ƒä¹Ÿåœ¨æŒ‚è½½å­åº”ç”¨ç¨‹åºæ—¶åœ¨å†…éƒ¨ä½¿ç”¨ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„ä»£ç†æ„å‘³ç€æ‚¨å¯ä»¥åœ¨ä»£ç ä¸­å£°æ˜ä¸€ä¸ªä½äº `/app` çš„è·¯å¾„ï¼Œä½†ç„¶åæ‚¨åœ¨å…¶ä¸Šæ·»åŠ ä¸€ä¸ªå±‚ï¼ˆä»£ç†ï¼‰ï¼Œå°†æ‚¨çš„ FastAPI åº”ç”¨ç¨‹åºæ”¾åœ¨åƒ `/api/v1` è¿™æ ·çš„è·¯å¾„ä¸‹ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒåŸå§‹è·¯å¾„ `/app` å®é™…ä¸Šå°†åœ¨ `/api/v1/app` ä¸Šæä¾›æœåŠ¡ã€‚

å³ä½¿æ‚¨æ‰€æœ‰çš„ä»£ç éƒ½æ˜¯åœ¨å‡è®¾åªæœ‰ `/app` çš„æƒ…å†µä¸‹ç¼–å†™çš„ã€‚

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI()

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

ä»£ç†å°†åœ¨å°†è¯·æ±‚ä¼ è¾“ç»™åº”ç”¨ç¨‹åºæœåŠ¡å™¨ï¼ˆå¯èƒ½æ˜¯é€šè¿‡ FastAPI CLI çš„ Uvicornï¼‰ä¹‹å‰åŠ¨æ€"å‰¥ç¦»"è·¯å¾„å‰ç¼€ï¼Œè®©æ‚¨çš„åº”ç”¨ç¨‹åºç¡®ä¿¡å®ƒåœ¨ `/app` ä¸Šæä¾›æœåŠ¡ï¼Œè¿™æ ·æ‚¨å°±ä¸å¿…æ›´æ–°æ‰€æœ‰ä»£ç ä»¥åŒ…å«å‰ç¼€ `/api/v1`ã€‚

åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œä¸€åˆ‡éƒ½å°†æ­£å¸¸å·¥ä½œã€‚

ä½†æ˜¯ï¼Œå½“æ‚¨æ‰“å¼€é›†æˆçš„æ–‡æ¡£ UIï¼ˆå‰ç«¯ï¼‰æ—¶ï¼Œå®ƒä¼šæœŸæœ›åœ¨ `/openapi.json` è·å– OpenAPI æ¨¡å¼ï¼Œè€Œä¸æ˜¯ `/api/v1/openapi.json`ã€‚

æ‰€ä»¥ï¼Œå‰ç«¯ï¼ˆåœ¨æµè§ˆå™¨ä¸­è¿è¡Œï¼‰å°†å°è¯•è®¿é—® `/openapi.json`ï¼Œä½†æ— æ³•è·å– OpenAPI æ¨¡å¼ã€‚

å› ä¸ºæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæœ‰ä¸€ä¸ªè·¯å¾„å‰ç¼€ä¸º `/api/v1` çš„ä»£ç†ï¼Œå‰ç«¯éœ€è¦åœ¨ `/api/v1/openapi.json` è·å– OpenAPI æ¨¡å¼ã€‚

```
graph LR

browser("Browser")
proxy["Proxy on http://0.0.0.0:9999/api/v1/app"]
server["Server on http://127.0.0.1:8000/app"]

browser --> proxy
proxy --> server
```

æç¤º

IP `0.0.0.0` é€šå¸¸ç”¨äºè¡¨ç¤ºç¨‹åºç›‘å¬è¯¥æœºå™¨/æœåŠ¡å™¨ä¸Šæ‰€æœ‰å¯ç”¨çš„ IPã€‚

æ–‡æ¡£ UI è¿˜éœ€è¦ OpenAPI æ¨¡å¼æ¥å£°æ˜è¿™ä¸ª API `æœåŠ¡å™¨` ä½äº `/api/v1`ï¼ˆåœ¨ä»£ç†åé¢ï¼‰ã€‚ä¾‹å¦‚ï¼š

```json
{
    "openapi": "3.1.0",
    // More stuff here
    "servers": [
        {
            "url": "/api/v1"
        }
    ],
    "paths": {
            // More stuff here
    }
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ"ä»£ç†"å¯èƒ½ç±»ä¼¼äº Traefikã€‚æœåŠ¡å™¨å°†æ˜¯ç±»ä¼¼äºå¸¦æœ‰ Uvicorn çš„ FastAPI CLIï¼Œè¿è¡Œæ‚¨çš„ FastAPI åº”ç”¨ç¨‹åºã€‚

### æä¾› `root_path`

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹ `--root-path`ï¼Œå¦‚ï¼š

```bash
$ fastapi run main.py --forwarded-allow-ips="*" --root-path /api/v1

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

å¦‚æœæ‚¨ä½¿ç”¨ Hypercornï¼Œå®ƒä¹Ÿæœ‰é€‰é¡¹ `--root-path`ã€‚

æŠ€æœ¯ç»†èŠ‚

ASGI è§„èŒƒä¸ºè¿™ä¸ªç”¨ä¾‹å®šä¹‰äº†ä¸€ä¸ª `root_path`ã€‚

`--root-path` å‘½ä»¤è¡Œé€‰é¡¹æä¾›äº†é‚£ä¸ª `root_path`ã€‚

### æ£€æŸ¥å½“å‰çš„ `root_path`

æ‚¨å¯ä»¥è·å–åº”ç”¨ç¨‹åºä¸ºæ¯ä¸ªè¯·æ±‚ä½¿ç”¨çš„å½“å‰ `root_path`ï¼Œå®ƒæ˜¯ `scope` å­—å…¸ï¼ˆASGI è§„èŒƒçš„ä¸€éƒ¨åˆ†ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚

è¿™é‡Œæˆ‘ä»¬åœ¨æ¶ˆæ¯ä¸­åŒ…å«å®ƒä»…ç”¨äºæ¼”ç¤ºç›®çš„ã€‚

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI()

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

ç„¶åï¼Œå¦‚æœæ‚¨ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å¯åŠ¨ Uvicornï¼š

```bash
$ fastapi run main.py --forwarded-allow-ips="*" --root-path /api/v1

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

å“åº”å°†ç±»ä¼¼äºï¼š

```json
{
    "message": "Hello World",
    "root_path": "/api/v1"
}
```

### åœ¨ FastAPI åº”ç”¨ç¨‹åºä¸­è®¾ç½® `root_path`

æˆ–è€…ï¼Œå¦‚æœæ‚¨æ²¡æœ‰åŠæ³•æä¾›åƒ `--root-path` è¿™æ ·çš„å‘½ä»¤è¡Œé€‰é¡¹æˆ–ç­‰æ•ˆé¡¹ï¼Œæ‚¨å¯ä»¥åœ¨åˆ›å»º FastAPI åº”ç”¨ç¨‹åºæ—¶è®¾ç½® `root_path` å‚æ•°ï¼š

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI(root_path="/api/v1")

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

å°† `root_path` ä¼ é€’ç»™ `FastAPI` ç›¸å½“äºå°† `--root-path` å‘½ä»¤è¡Œé€‰é¡¹ä¼ é€’ç»™ Uvicorn æˆ– Hypercornã€‚

### å…³äº `root_path`

è¯·è®°ä½ï¼ŒæœåŠ¡å™¨ï¼ˆUvicornï¼‰ä¸ä¼šå°†è¯¥ `root_path` ç”¨äºé™¤å°†å…¶ä¼ é€’ç»™åº”ç”¨ç¨‹åºä¹‹å¤–çš„ä»»ä½•å…¶ä»–ç›®çš„ã€‚

ä½†å¦‚æœæ‚¨ä½¿ç”¨æµè§ˆå™¨è®¿é—® http://127.0.0.1:8000/appï¼Œæ‚¨å°†çœ‹åˆ°æ­£å¸¸å“åº”ï¼š

```json
{
    "message": "Hello World",
    "root_path": "/api/v1"
}
```

æ‰€ä»¥ï¼Œå®ƒä¸ä¼šæœŸæœ›åœ¨ `http://127.0.0.1:8000/api/v1/app` è®¿é—®ã€‚

Uvicorn å°†æœŸæœ›ä»£ç†åœ¨ `http://127.0.0.1:8000/app` è®¿é—® Uvicornï¼Œç„¶åä»£ç†å°†è´Ÿè´£åœ¨å…¶ä¸Šæ·»åŠ é¢å¤–çš„ `/api/v1` å‰ç¼€ã€‚

## å…³äºå¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„ä»£ç†

è¯·è®°ä½ï¼Œå¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„ä»£ç†åªæ˜¯é…ç½®å®ƒçš„ä¸€ç§æ–¹å¼ã€‚

å¯èƒ½åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œé»˜è®¤å°†æ˜¯ä»£ç†æ²¡æœ‰å‰¥ç¦»çš„è·¯å¾„å‰ç¼€ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ˆæ²¡æœ‰å‰¥ç¦»çš„è·¯å¾„å‰ç¼€ï¼‰ï¼Œä»£ç†å°†åœ¨åƒ `https://myawesomeapp.com` è¿™æ ·çš„åœ°æ–¹ç›‘å¬ï¼Œç„¶åå¦‚æœæµè§ˆå™¨è®¿é—® `https://myawesomeapp.com/api/v1/app`ï¼Œè€Œæ‚¨çš„æœåŠ¡å™¨ï¼ˆä¾‹å¦‚ Uvicornï¼‰åœ¨ `http://127.0.0.1:8000` ä¸Šç›‘å¬ï¼Œä»£ç†ï¼ˆæ²¡æœ‰å‰¥ç¦»çš„è·¯å¾„å‰ç¼€ï¼‰å°†åœ¨ç›¸åŒçš„è·¯å¾„è®¿é—® Uvicornï¼š`http://127.0.0.1:8000/api/v1/app`ã€‚

## ä½¿ç”¨ Traefik æœ¬åœ°æµ‹è¯•

æ‚¨å¯ä»¥ä½¿ç”¨ Traefik è½»æ¾åœ°åœ¨æœ¬åœ°è¿è¡Œå¸¦æœ‰å‰¥ç¦»è·¯å¾„å‰ç¼€çš„å®éªŒã€‚

ä¸‹è½½ Traefikï¼Œå®ƒæ˜¯ä¸€ä¸ªå•ç‹¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥è§£å‹ç¼©æ–‡ä»¶å¹¶ç›´æ¥ä»ç»ˆç«¯è¿è¡Œã€‚

ç„¶ååˆ›å»ºä¸€ä¸ªæ–‡ä»¶ `traefik.toml`ï¼š

```toml
[entryPoints]
  [entryPoints.http]
    address = ":9999"

[providers]
  [providers.file]
    filename = "routes.toml"
```

è¿™å‘Šè¯‰ Traefik åœ¨ç«¯å£ 9999 ä¸Šç›‘å¬å¹¶ä½¿ç”¨å¦ä¸€ä¸ªæ–‡ä»¶ `routes.toml`ã€‚

æç¤º

æˆ‘ä»¬ä½¿ç”¨ç«¯å£ 9999 è€Œä¸æ˜¯æ ‡å‡† HTTP ç«¯å£ 80ï¼Œè¿™æ ·æ‚¨å°±ä¸å¿…ä½¿ç”¨ç®¡ç†å‘˜ï¼ˆ`sudo`ï¼‰æƒé™è¿è¡Œå®ƒã€‚

ç°åœ¨åˆ›å»ºå¦ä¸€ä¸ªæ–‡ä»¶ `routes.toml`ï¼š

```toml
[http]
  [http.middlewares]

    [http.middlewares.api-stripprefix.stripPrefix]
      prefixes = ["/api/v1"]

  [http.routers]

    [http.routers.app-http]
      entryPoints = ["http"]
      service = "app"
      rule = "PathPrefix(`/api/v1`)"
      middlewares = ["api-stripprefix"]

  [http.services]

    [http.services.app]
      [http.services.app.loadBalancer]
        [[http.services.app.loadBalancer.servers]]
          url = "http://127.0.0.1:8000"
```

è¿™ä¸ªæ–‡ä»¶é…ç½® Traefik ä½¿ç”¨è·¯å¾„å‰ç¼€ `/api/v1`ã€‚

ç„¶å Traefik å°†å°†å…¶è¯·æ±‚é‡å®šå‘åˆ°æ‚¨åœ¨ `http://127.0.0.1:8000` ä¸Šè¿è¡Œçš„ Uvicornã€‚

ç°åœ¨å¯åŠ¨ Traefikï¼š

```bash
$ ./traefik --configFile=traefik.toml

INFO[0000] Configuration loaded from file: /home/user/awesomeapi/traefik.toml
```

ç°åœ¨ä½¿ç”¨ `--root-path` é€‰é¡¹å¯åŠ¨æ‚¨çš„åº”ç”¨ç¨‹åºï¼š

```bash
$ fastapi run main.py --forwarded-allow-ips="*" --root-path /api/v1

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

### æ£€æŸ¥å“åº”

ç°åœ¨ï¼Œå¦‚æœæ‚¨è®¿é—® Uvicorn ç«¯å£çš„ URLï¼šhttp://127.0.0.1:8000/appï¼Œæ‚¨å°†çœ‹åˆ°æ­£å¸¸å“åº”ï¼š

```json
{
    "message": "Hello World",
    "root_path": "/api/v1"
}
```

æç¤º

è¯·æ³¨æ„ï¼Œå³ä½¿æ‚¨åœ¨ `http://127.0.0.1:8000/app` è®¿é—®å®ƒï¼Œå®ƒä¹Ÿæ˜¾ç¤ºæ¥è‡ªé€‰é¡¹ `--root-path` çš„ `/api/v1` çš„ `root_path`ã€‚

ç°åœ¨æ‰“å¼€ Traefik ç«¯å£çš„ URLï¼ŒåŒ…æ‹¬è·¯å¾„å‰ç¼€ï¼šhttp://127.0.0.1:9999/api/v1/appã€‚

æˆ‘ä»¬å¾—åˆ°ç›¸åŒçš„å“åº”ï¼š

```json
{
    "message": "Hello World",
    "root_path": "/api/v1"
}
```

ä½†è¿™æ¬¡æ˜¯åœ¨å¸¦æœ‰ä»£ç†æä¾›çš„å‰ç¼€è·¯å¾„çš„ URL ä¸Šï¼š`/api/v1`ã€‚

å½“ç„¶ï¼Œè¿™é‡Œçš„æƒ³æ³•æ˜¯æ¯ä¸ªäººéƒ½é€šè¿‡ä»£ç†è®¿é—®åº”ç”¨ç¨‹åºï¼Œæ‰€ä»¥å¸¦æœ‰è·¯å¾„å‰ç¼€ `/api/v1` çš„ç‰ˆæœ¬æ˜¯"æ­£ç¡®"çš„ç‰ˆæœ¬ã€‚

è€Œæ²¡æœ‰è·¯å¾„å‰ç¼€ï¼ˆ`http://127.0.0.1:8000/app`ï¼‰çš„ç‰ˆæœ¬ï¼Œç”± Uvicorn ç›´æ¥æä¾›ï¼Œå°†ä¸“é—¨ä¾›ä»£ç†ï¼ˆTraefikï¼‰è®¿é—®ã€‚

è¿™æ¼”ç¤ºäº†ä»£ç†ï¼ˆTraefikï¼‰å¦‚ä½•ä½¿ç”¨è·¯å¾„å‰ç¼€ä»¥åŠæœåŠ¡å™¨ï¼ˆUvicornï¼‰å¦‚ä½•ä½¿ç”¨æ¥è‡ªé€‰é¡¹ `--root-path` çš„ `root_path`ã€‚

### æ£€æŸ¥æ–‡æ¡£ UI

ä½†è¿™æ˜¯æœ‰è¶£çš„éƒ¨åˆ†ã€‚âœ¨

è®¿é—®åº”ç”¨ç¨‹åºçš„"å®˜æ–¹"æ–¹å¼æ˜¯é€šè¿‡æˆ‘ä»¬å®šä¹‰çš„å¸¦æœ‰è·¯å¾„å‰ç¼€çš„ä»£ç†ã€‚æ‰€ä»¥ï¼Œæ­£å¦‚æˆ‘ä»¬é¢„æœŸçš„é‚£æ ·ï¼Œå¦‚æœæ‚¨å°è¯• Uvicorn ç›´æ¥æä¾›çš„æ–‡æ¡£ UIï¼ŒURL ä¸­æ²¡æœ‰è·¯å¾„å‰ç¼€ï¼Œå®ƒå°†æ— æ³•å·¥ä½œï¼Œå› ä¸ºå®ƒæœŸæœ›é€šè¿‡ä»£ç†è®¿é—®ã€‚

æ‚¨å¯ä»¥åœ¨ http://127.0.0.1:8000/docs æ£€æŸ¥å®ƒï¼š

![å›¾ç‰‡ 1](https://fastapi.tiangolo.com/img/tutorial/behind-a-proxy/image01.png)

ä½†å¦‚æœæˆ‘ä»¬åœ¨"å®˜æ–¹" URL ä½¿ç”¨å¸¦æœ‰ç«¯å£ `9999` çš„ä»£ç†è®¿é—®æ–‡æ¡£ UIï¼Œåœ¨ `/api/v1/docs`ï¼Œå®ƒæ­£ç¡®å·¥ä½œï¼ğŸ‰

æ‚¨å¯ä»¥åœ¨ http://127.0.0.1:9999/api/v1/docs æ£€æŸ¥å®ƒï¼š

![å›¾ç‰‡ 2](https://fastapi.tiangolo.com/img/tutorial/behind-a-proxy/image02.png)

æ­£å¦‚æˆ‘ä»¬æƒ³è¦çš„ã€‚âœ”ï¸

è¿™æ˜¯å› ä¸º FastAPI ä½¿ç”¨è¿™ä¸ª `root_path` æ¥åœ¨ OpenAPI ä¸­ä½¿ç”¨ `root_path` æä¾›çš„ URL åˆ›å»ºé»˜è®¤çš„ `æœåŠ¡å™¨`ã€‚

## é™„åŠ æœåŠ¡å™¨

è­¦å‘Š

è¿™æ˜¯ä¸€ä¸ªæ›´é«˜çº§çš„ç”¨ä¾‹ã€‚è¯·éšæ„è·³è¿‡å®ƒã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒFastAPI å°†åœ¨ OpenAPI æ¨¡å¼ä¸­åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ `root_path` URL çš„ `æœåŠ¡å™¨`ã€‚

ä½†æ‚¨ä¹Ÿå¯ä»¥æä¾›å…¶ä»–æ›¿ä»£çš„ `æœåŠ¡å™¨`ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨å¸Œæœ›ç›¸åŒçš„æ–‡æ¡£ UI ä¸é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒäº¤äº’ã€‚

å¦‚æœæ‚¨ä¼ é€’è‡ªå®šä¹‰çš„ `æœåŠ¡å™¨` åˆ—è¡¨å¹¶ä¸”æœ‰ä¸€ä¸ª `root_path`ï¼ˆå› ä¸ºæ‚¨çš„ API ä½äºä»£ç†åé¢ï¼‰ï¼ŒFastAPI å°†åœ¨åˆ—è¡¨çš„å¼€å¤´æ’å…¥ä¸€ä¸ªå¸¦æœ‰è¿™ä¸ª `root_path` çš„"æœåŠ¡å™¨"ã€‚

ä¾‹å¦‚ï¼š

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI(
    servers=[
        {"url": "https://stag.example.com", "description": "Staging environment"},
        {"url": "https://prod.example.com", "description": "Production environment"},
    ],
    root_path="/api/v1",
)

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

å°†ç”Ÿæˆå¦‚ä¸‹çš„ OpenAPI æ¨¡å¼ï¼š

```json
{
    "openapi": "3.1.0",
    // More stuff here
    "servers": [
        {
            "url": "/api/v1"
        },
        {
            "url": "https://stag.example.com",
            "description": "Staging environment"
        },
        {
            "url": "https://prod.example.com",
            "description": "Production environment"
        }
    ],
    "paths": {
            // More stuff here
    }
}
```

æç¤º

è¯·æ³¨æ„è‡ªåŠ¨ç”Ÿæˆçš„æœåŠ¡å™¨ï¼Œ`url` å€¼ä¸º `/api/v1`ï¼Œå–è‡ª `root_path`ã€‚

åœ¨ http://127.0.0.1:9999/api/v1/docs çš„æ–‡æ¡£ UI ä¸­ï¼Œå®ƒå°†çœ‹èµ·æ¥åƒï¼š

![å›¾ç‰‡ 3](https://fastapi.tiangolo.com/img/tutorial/behind-a-proxy/image03.png)

æç¤º

æ–‡æ¡£ UI å°†ä¸æ‚¨é€‰æ‹©çš„æœåŠ¡å™¨äº¤äº’ã€‚

### ç¦ç”¨æ¥è‡ª `root_path` çš„è‡ªåŠ¨æœåŠ¡å™¨

å¦‚æœæ‚¨ä¸å¸Œæœ› FastAPI åŒ…å«ä½¿ç”¨ `root_path` çš„è‡ªåŠ¨æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å‚æ•° `root_path_in_servers=False`ï¼š

Python 3.8+

```python
from fastapi import FastAPI, Request

app = FastAPI(
    servers=[
        {"url": "https://stag.example.com", "description": "Staging environment"},
        {"url": "https://prod.example.com", "description": "Production environment"},
    ],
    root_path="/api/v1",
    root_path_in_servers=False,
)

@app.get("/app")
def read_main(request: Request):
    return {"message": "Hello World", "root_path": request.scope.get("root_path")}
```

ç„¶åå®ƒä¸ä¼šåŒ…å«åœ¨ OpenAPI æ¨¡å¼ä¸­ã€‚

## æŒ‚è½½å­åº”ç”¨ç¨‹åº

å¦‚æœæ‚¨éœ€è¦æŒ‚è½½å­åº”ç”¨ç¨‹åºï¼ˆå¦‚å­åº”ç”¨ç¨‹åº - æŒ‚è½½ä¸­æ‰€è¿°ï¼‰ï¼ŒåŒæ—¶è¿˜ä½¿ç”¨å¸¦æœ‰ `root_path` çš„ä»£ç†ï¼Œæ‚¨å¯ä»¥æ­£å¸¸è¿›è¡Œï¼Œæ­£å¦‚æ‚¨æ‰€æœŸæœ›çš„é‚£æ ·ã€‚

FastAPI å°†åœ¨å†…éƒ¨æ™ºèƒ½åœ°ä½¿ç”¨ `root_path`ï¼Œæ‰€ä»¥å®ƒå°±æ˜¯èƒ½å·¥ä½œã€‚âœ¨