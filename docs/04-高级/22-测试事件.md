# 测试事件:生命周期 - startup 和 shutdown - FastAPI

在测试应用程序时,您可能需要控制 startup 和 shutdown 事件.

## 使用 `TestClient` 测试事件

当您使用 `TestClient` 时,startup 和 shutdown 事件会自动运行.

### 基本示例

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.testclient import TestClient

items = {}


@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    items["foo"] = {"name": "Fighters"}
    items["bar"] = {"name": "Tenders"}
    yield
    # Shutdown
    items.clear()


app = FastAPI(lifespan=lifespan)


@app.get("/items/{item_id}")
async def read_item(item_id: str):
    return items[item_id]


def test_read_item():
    with TestClient(app) as client:
        response = client.get("/items/foo")
        assert response.status_code == 200
        assert response.json() == {"name": "Fighters"}
```

## 使用 `AsyncClient` 进行异步测试

对于更复杂的异步测试,您可以使用 `httpx.AsyncClient`:

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
import httpx
import pytest

items = {}


@asynccontextmanager
async def lifespan(app: FastAPI):
    # Startup
    items["foo"] = {"name": "Fighters"}
    items["bar"] = {"name": "Tenders"}
    yield
    # Shutdown
    items.clear()


app = FastAPI(lifespan=lifespan)


@app.get("/items/{item_id}")
async def read_item(item_id: str):
    return items[item_id]


@pytest.mark.asyncio
async def test_read_item():
    async with httpx.AsyncClient(app=app, base_url="http://test") as ac:
        response = await ac.get("/items/foo")
        assert response.status_code == 200
        assert response.json() == {"name": "Fighters"}
```

## 测试多个事件处理器

如果您的应用程序有多个 startup 和 shutdown 事件处理器,您可以测试它们的执行顺序:

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.testclient import TestClient

startup_events = []
shutdown_events = []


@asynccontextmanager
async def lifespan(app: FastAPI):
    startup_events.append("first")
    yield
    shutdown_events.append("first")


app = FastAPI(lifespan=lifespan)


@app.on_event("startup")
async def second_startup():
    startup_events.append("second")


@app.on_event("shutdown")
async def second_shutdown():
    shutdown_events.append("second")


def test_event_order():
    with TestClient(app) as client:
        # 测试期间应用程序已启动
        assert "first" in startup_events
        assert "second" in startup_events
        # shutdown 事件尚未触发
        assert len(shutdown_events) == 0

    # 测试完成后,shutdown 事件应该已触发
    assert "first" in shutdown_events
    assert "second" in shutdown_events
    # shutdown 事件按相反顺序执行
    assert shutdown_events.index("second") < shutdown_events.index("first")
```

## 测试带有异常的事件处理

您可以测试事件处理器中的异常处理:

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI, HTTPException
from fastapi.testclient import TestClient
import pytest

startup_failed = False
cleanup_called = False


@asynccontextmanager
async def lifespan(app: FastAPI):
    global startup_failed
    try:
        # 模拟启动失败
        raise ValueError("Startup failed")
    except Exception:
        startup_failed = True
        raise
    yield
    global cleanup_called
    cleanup_called = True


app = FastAPI(lifespan=lifespan)


def test_startup_failure():
    # 由于启动失败,应用程序不应该启动
    with pytest.raises(Exception):
        with TestClient(app) as client:
            pass

    assert startup_failed
    # cleanup 不应该被调用,因为 yield 之前就失败了
    assert not cleanup_called
```

## 使用 pytest fixtures 管理生命周期

您可以使用 pytest fixtures 来管理测试生命周期:

```python
import pytest
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.testclient import TestClient

@pytest.fixture
def app_with_lifespan():
    items = {}

    @asynccontextmanager
    async def lifespan(app: FastAPI):
        # Startup
        items["foo"] = {"name": "Fighters"}
        yield
        # Shutdown
        items.clear()

    app = FastAPI(lifespan=lifespan)

    @app.get("/items/{item_id}")
    async def read_item(item_id: str):
        return items[item_id]

    return app


def test_read_item_with_fixture(app_with_lifespan):
    with TestClient(app_with_lifespan) as client:
        response = client.get("/items/foo")
        assert response.status_code == 200
        assert response.json() == {"name": "Fighters"}
```

## 测试资源初始化

测试应用程序的资源初始化:

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI
from fastapi.testclient import TestClient
import asyncio

database_connected = False
cache_initialized = False


@asynccontextmanager
async def lifespan(app: FastAPI):
    global database_connected, cache_initialized
    # 模拟异步资源初始化
    await asyncio.sleep(0.1)
    database_connected = True

    await asyncio.sleep(0.1)
    cache_initialized = True

    yield

    # 清理资源
    database_connected = False
    cache_initialized = False


app = FastAPI(lifespan=lifespan)


@app.get("/status")
async def get_status():
    return {
        "database": database_connected,
        "cache": cache_initialized
    }


def test_resource_initialization():
    with TestClient(app) as client:
        response = client.get("/status")
        assert response.status_code == 200
        assert response.json() == {
            "database": True,
            "cache": True
        }
```

## 测试依赖关系

测试事件处理器与其他组件的依赖关系:

```python
from contextlib import asynccontextmanager
from fastapi import FastAPI, Depends
from fastapi.testclient import TestClient

# 模拟依赖项
class Database:
    def __init__(self):
        self.connected = False

    async def connect(self):
        self.connected = True

    async def disconnect(self):
        self.connected = False


db = Database()


async def get_database():
    return db


@asynccontextmanager
async def lifespan(app: FastAPI):
    await db.connect()
    yield
    await db.disconnect()


app = FastAPI(lifespan=lifespan)


@app.get("/check")
async def check_database(database=Depends(get_database)):
    return {"connected": database.connected}


def test_dependency_with_lifespan():
    with TestClient(app) as client:
        response = client.get("/check")
        assert response.status_code == 200
        assert response.json() == {"connected": True}

    # 测试结束后,数据库应该已断开连接
    assert not db.connected
```

## 注意事项

1. **事件自动触发**:`TestClient` 会自动触发 startup 和 shutdown 事件.

2. **异步测试**:使用 `httpx.AsyncClient` 进行更复杂的异步测试.

3. **资源清理**:确保在 shutdown 事件中正确清理资源.

4. **测试隔离**:每个测试应该有独立的资源状态.

5. **性能考虑**:注意生命周期事件对测试性能的影响.

## 更多信息

有关更多详细信息,请查看 FastAPI 的测试文档和生命周期事件文档.