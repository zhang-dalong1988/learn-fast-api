# 安全概述

FastAPI 提供了多种工具来帮助你处理安全、认证和授权,无需研究所有安全规范.

你将在接下来的章节中看到.

## 安全是什么?

如果你想了解一些关于安全的通用信息,或者你不确定"认证"、"OAuth2"、"JWT"、"Bearer token"、"哈希密码"等术语的含义,请继续阅读本概述.

如果你已经对这些安全概念很了解,可以直接跳到下一章:安全第一步.

## 安全工作流程

FastAPI 提供了几个工具来处理安全,每个工具都有一个特定的用途.

但在深入技术细节之前,让我们首先了解一下整个工作流程.

## 一个场景

让我们从一个常见的场景开始.

- 你的 API 有一些"/路径"/"操作".
- 它们应该受到限制.
- 只有特定的用户可以访问它们.
- 这些用户有自己的用户名和密码(或没有,我们稍后会看到).
- 你的前端使用用户名和密码与用户进行交互.
- 前端将这些凭据发送到你的 API,并对它们进行验证.
- 如果凭据正确,API 给前端一个"令牌".
- 前端存储该令牌.
- 前端从那里向受保护的 API 路径发送请求,并使用该令牌.
- API 接收到令牌,验证它,如果有效,则允许访问受保护的路径.

令牌通常是临时的,有到期时间.这样,如果令牌被泄露,时间也是有限的.然后,前端需要再次发送凭据并获取一个新令牌.

当用户在系统中注销时,前​​端可以忘记该令牌.

这就是 OAuth2 的工作流程.

### OAuth2

你可以阅读大量关于 OAuth2 的规范,它相当"泛化"和抽象.

OAuth2 要求应用/客户端获取一个令牌,并在后续请求中使用该令牌.

然后,OAuth2 没有定义如何获取这些令牌.它定义了几种方法来获取令牌.

其中最常见的方法被称为"密码流",这正是我们在本例中将要使用的.

### OpenID Connect (OIDC)

OpenID Connect (OIDC) 是另一个构建在 OAuth2 之上的规范.

它定义了如何**认证**用户(检查他们是谁).这就是与 OAuth2 的主要区别,OAuth2 更侧重于**授权**(允许谁做什么).

OIDC 还定义了如何检索用户信息,并定义了一些其他有用的东西,如"发现机制",你可以在其中自动发现系统支持的认证类型.

为了能够向你的应用添加 OIDC,你将不得不使用 OIDC"提供者".

OIDC 提供者是一个可以对你的用户进行认证并提供令牌的服务.

这些服务通常会自动处理令牌刷新等.他们可能有自己的数据库,或者可能与你现有的用户数据库集成.

### 添加第三方认证

添加第三方认证(如 Google、Facebook、Twitter、GitHub 等)与 OIDC 非常相似,因为所有这些主要服务都提供 OIDC.

主要区别在于,你不必直接向 OIDC 提供者发送用户名和密码.

用户将在你的前端点击一个按钮("使用 Google 登录"),浏览器将被重定向到 Google 的登录页面,在那里登录,然后 Google 会将浏览器重定向回你的应用.

在所有这个过程中,Google 会处理用户界面、密码和认证.

然后,Google 会向你的应用发送一个令牌.你的应用程序将使用 Google 的令牌与 Google 的 API 通信,获取有关用户的信息(如姓名、电子邮件、个人资料照片等),或者如果需要,你可以在自己的数据库中创建用户记录.

你将可以使用 FastAPI 的工具来完成所有这些操作,如果你需要的话.

### 何时使用哪种方法

使用 OAuth2 with Password Flow 的情况:

- 你自己的前端正在登录到你自己的 API.
- 你可以安全地存储用户的凭据(例如,在你自己的数据库中).
- 你希望为用户和授权提供一个简单的用户体验.

使用第三方/外部 OIDC 提供者(如 Google、Facebook、Twitter 等)的情况:

- 你在构建面向公众的应用,让用户可以通过他们已有的账户登录.
- 你不想处理用户数据、密码、安全性等所有复杂性.
- 你委托给其他服务来完成认证工作.

还有其他情况,但这些是最常见的.

现在,让我们看看如何处理第一个案例,使用密码流的 OAuth2.

## 哈希密码

"哈希"意味着将某些内容(在这种情况下是密码)转换为看起来像随机字符的序列(但只是看起来随机).每次你传入完全相同的密码,你都会得到完全相同的哈希值.

你无法将哈希值转换回密码.但你可以检查一个密码是否与哈希值匹配,通过将密码哈希并比较哈希结果.

这样,你可以存储用户密码的哈希值,而不是密码本身.

如果你的数据库被泄露,攻击者将只有哈希值,而不是实际密码.

## JWT 令牌

JWT 表示"JSON Web Token".

它是一种标准的令牌格式.它包含了一个 JSON 对象,其中的所有声明(数据项)都是数字签名的.

这意味着签名可以用来验证令牌的完整性,确保它在传输过程中没有被篡改.

例如,你可以在 JWT 令牌中有一个名为 `sub` 的声明,其值为用户名.

令牌生成后,你可以用密码生成的签名加密它.

然后,当用户带着令牌回来时,你可以验证签名,以确保令牌没有伪造,因为它只能用密码签名.

而且,因为没有密钥,攻击者无法创建具有有效签名的新令牌.

你还可以设置令牌的到期时间,在该时间之后,令牌将不再有效.

有了 JWT,你可以为令牌本身创建所有需要的信息,包括用户权限(角色)、令牌到期时间等信息.

当你收到一个令牌时,你可以独立验证它,而无需从数据库中查找.

由于你可以独立验证它,所以你不需要在每个微服务中都存储会话状态或令牌状态.每个服务可以使用相同的密钥验证令牌,而无需进行网络通信或数据库查询.

这对于大型分布式系统(如微服务架构)非常有用.

## 下一章

现在,你已经有了一个关于安全概念的总体概述,让我们看看如何使用 FastAPI 提供的工具来实际实现密码流的 OAuth2.