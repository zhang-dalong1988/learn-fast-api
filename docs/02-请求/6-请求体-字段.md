# 请求体字段 - FastAPI 教程

## 1. 导入 Field

使用 Pydantic 的 Field 在模型内部声明验证和元数据。

```python
# Python 3.10+
from typing import Annotated
from fastapi import Body, FastAPI
from pydantic import BaseModel, Field  # 关键: Field 用于在模型中添加验证和元数据

app = FastAPI()  # 创建 FastAPI 应用

class Item(BaseModel):
    name: str  # 必需字段，没有验证
    description: str | None = Field(  # 使用 Field 添加验证和元数据
        default=None,  # 可选字段，默认为 None
        title="The description of the item",  # 在文档中显示的标题
        max_length=300  # 长度验证：最多300个字符
    )
    price: float = Field(  # 使用 Field 添加数值验证
        gt=0,  # 验证约束：必须大于 0
        description="The price must be greater than zero"  # 验证失败时的错误信息
    )
    tax: float | None = None  # 可选字段，没有额外验证约束

@app.put("/items/{item_id}")  # PUT 方法用于更新资源
async def update_item(
    item_id: int,  # 路径参数：商品 ID
    item: Annotated[Item, Body(embed=True)]  # embed=True 改变请求体结构，数据会嵌套在 "item" 键下
):
    results = {"item_id": item_id, "item": item}
    return results
```

```python
# Python 3.9+
from typing import Annotated, Union  # Union 用于 Python 3.9/3.10 兼容
from fastapi import Body, FastAPI  # 导入 FastAPI 和 Body
from pydantic import BaseModel, Field  # 从 pydantic 导入 BaseModel 和 Field

app = FastAPI()  # 创建 FastAPI 应用实例

class Item(BaseModel):  # 继承 BaseModel 创建数据模型
    name: str  # 必需的字符串字段
    description: Union[str, None] = Field(  # 可选字符串字段，使用 Field 添加验证
        default=None,  # 默认值为 None
        title="The description of the item",  # 字段标题
        max_length=300  # 最大长度限制为 300
    )
    price: float = Field(
        gt=0,  # 必须大于 0
        description="The price must be greater than zero"  # 字段描述
    )
    tax: Union[float, None] = None  # 可选的浮点数字段，无验证

@app.put("/items/{item_id}")  # 定义 PUT 路由，用于更新资源
async def update_item(
    item_id: int,  # 路径参数：商品 ID
    item: Annotated[Item, Body(embed=True)]  # 请求体：Item 模型，embed=True 表示数据嵌套
):
    results = {"item_id": item_id, "item": item}  # 返回合并的结果
    return results
```

**提示**: 尽可能使用 `Annotated` 版本。

**警告**: 请注意, Field 是直接从 pydantic 导入的, 而不是像其他所有 (Query、Path、Body 等) 那样从 fastapi 导入。

## 2. 声明模型属性

然后你可以将 Field 与模型属性一起使用:

```python
# Python 3.10+
from typing import Annotated
from fastapi import Body, FastAPI
from pydantic import BaseModel, Field

app = FastAPI()

class Item(BaseModel):  # 定义请求体数据模型
    name: str  # 必需字段，不需要特殊验证
    description: str | None = Field(  # 可选字段，使用 Field 添加验证规则
        default=None,  # 默认值为 None，表示字段可选
        title="The description of the item",  # 在 API 文档中显示的标题
        max_length=300  # 字符串长度限制：最多 300 个字符
    )
    price: float = Field(  # 必需字段，使用 Field 添加数值验证
        gt=0,  # 数值约束：必须大于 0 (greater than)
        description="The price must be greater than zero"  # 验证失败时的错误提示
    )
    tax: float | None = None  # 可选字段，使用默认类型验证

@app.put("/items/{item_id}")  # PUT 路由，用于更新资源
async def update_item(
    item_id: int,  # 路径参数：要更新的商品 ID
    item: Annotated[Item, Body(embed=True)]  # 请求体参数，embed=True 将数据嵌套在 "item" 键下
):
    results = {"item_id": item_id, "item": item}  # 返回合并的结果
    return results
```

```python
# Python 3.9+
from typing import Annotated, Union  # Union 用于 Python 3.9 的可选类型注解
from fastapi import Body, FastAPI
from pydantic import BaseModel, Field

app = FastAPI()  # 创建 FastAPI 应用实例

class Item(BaseModel):  # 定义请求体数据模型
    name: str  # 必需字段，自动进行基本类型验证
    description: Union[str, None] = Field(  # Python 3.9 方式声明可选字段
        default=None,  # 设置默认值为 None 使字段可选
        title="The description of the item",  # API 文档中显示的字段标题
        max_length=300  # 字符串最大长度限制
    )
    price: float = Field(
        gt=0,  # 数值必须大于 0，防止负价格
        description="The price must be greater than zero"  # 验证错误时的描述信息
    )
    tax: Union[float, None] = None  # 可选的税率字段，无额外约束

@app.put("/items/{item_id}")  # 定义 PUT 路由端点
async def update_item(
    item_id: int,  # URL 路径参数
    item: Annotated[Item, Body(embed=True)]  # 请求体，使用 Annotated 语法
):
    results = {"item_id": item_id, "item": item}  # 构建响应数据
    return results
```

### 2.1 旧版本语法（不推荐）

```python
# Python 3.9+
from typing import Union  # Python 3.9 需要使用 Union 而不是 |
from fastapi import Body, FastAPI
from pydantic import BaseModel, Field

app = FastAPI()  # 创建 FastAPI 应用实例

class Item(BaseModel):  # 使用 Pydantic 定义数据模型
    name: str  # 必需的字符串字段
    description: Union[str, None] = Field(  # 使用 Field 声明字段的验证规则
        default=None,  # 默认值为 None，使字段可选
        title="The description of the item",  # 在 API 文档中显示的标题
        max_length=300  # 字符串长度验证
    )
    price: float = Field(
        gt=0,  # 价格必须大于 0
        description="The price must be greater than zero"  # 错误提示信息
    )
    tax: Union[float, None] = None  # 可选的税率字段

@app.put("/items/{item_id}")  # PUT 端点用于更新资源
async def update_item(
    item_id: int,  # 路径参数
    item: Item = Body(embed=True)  # 旧版本语法：将 Body 作为默认值
):
    results = {"item_id": item_id, "item": item}  # 返回处理结果
    return results
```

Field 的工作方式与 Query、Path 和 Body 相同, 它具有相同的参数, 等等。

## 3. Field 的参数

Field 支持以下常用参数:

### 3.1 验证参数

- `default`: 默认值
- `default_factory`: 默认值工厂函数
- `alias`: 字段别名
- `title`: 字段标题
- `description`: 字段描述
- `gt`: 大于 (greater than)
- `ge`: 大于等于 (greater than or equal)
- `lt`: 小于 (less than)
- `le`: 小于等于 (less than or equal)
- `multiple_of`: 必须是某数的倍数
- `min_length`: 最小长度
- `max_length`: 最大长度
- `regex`: 正则表达式模式

### 3.2 示例

```python
# Python 3.10+
from typing import Annotated  # Annotated 用于添加元数据和验证
from pydantic import BaseModel, Field

class Product(BaseModel):  # 使用 Field 展示各种验证约束
    name: Annotated[str, Field(
        min_length=1,  # 名称至少1个字符，防止空字符串
        max_length=100  # 名称最多100个字符
    )]
    price: Annotated[float, Field(
        gt=0,  # 价格必须大于0
        le=10000,  # 价格小于等于10000
        description="价格必须在 0-10000 之间"  # 验证说明
    )]
    discount: Annotated[float | None, Field(
        ge=0,  # 折扣率大于等于0
        le=1,  # 折扣率小于等于1（100%）
        description="折扣率，0-1 之间"  # 0-1表示0%-100%
    )] = None  # 可选字段，默认为None
    tags: Annotated[list[str], Field(
        max_items=10  # 标签列表最多10个元素
    )] = []  # 默认为空列表
    is_available: bool = True  # 布尔字段，默认值为True
```

## 4. 添加额外信息

你可以在 Field、Query、Body 等中声明额外信息。它将包含在生成的 JSON Schema 中。

你将在后面的文档中学习更多关于添加额外信息的内容, 当学习声明示例时。

**警告**: 传递给 Field 的额外键也将存在于生成的应用程序的 OpenAPI schema 中。由于这些键不一定是 OpenAPI 规范的一部分, 一些 OpenAPI 工具(例如 OpenAPI 验证器)可能无法使用你生成的 schema。

## 5. 完整示例

```python
# Python 3.10+
from typing import Annotated, List  # List 用于列表类型注解
from fastapi import FastAPI, Body, HTTPException  # 导入 FastAPI 核心组件
from pydantic import BaseModel, Field, validator  # validator 用于自定义验证
from datetime import datetime  # 用于处理日期时间

app = FastAPI()  # 初始化 FastAPI 应用

class Product(BaseModel):
    """商品模型 - 展示 Field 的各种验证功能"""

    id: Annotated[int, Field(
        ge=1,  # ID 必须大于等于1
        description="商品ID"
    )]
    name: Annotated[str, Field(
        min_length=1,  # 名称不能为空
        max_length=100,  # 名称长度限制
        description="商品名称",
        example="智能手机"  # API 文档中的示例值
    )]
    description: Annotated[str | None, Field(
        max_length=500,  # 描述最多500字符
        description="商品描述",
        default=None  # 可选字段
    )]
    price: Annotated[float, Field(
        gt=0,  # 价格必须大于0
        le=999999,  # 价格上限
        description="商品价格",
        example=4999.99  # 示例价格
    )]
    discount: Annotated[float | None, Field(
        ge=0,  # 折扣率最小值0%
        le=1,  # 折扣率最大值100%
        description="折扣率 (0-1)",
        default=None
    )]
    stock: Annotated[int, Field(
        ge=0,  # 库存不能为负数
        description="库存数量"
    )]
    tags: Annotated[List[str], Field(
        max_items=10,  # 最多10个标签
        description="商品标签",
        default=[]  # 默认空列表
    )]
    is_active: bool = Field(
        default=True,  # 默认上架状态
        description="是否上架"
    )
    created_at: datetime = Field(
        default_factory=datetime.now,  # 使用工厂函数生成默认值
        description="创建时间"
    )

    @validator('discount')  # 自定义验证器装饰器
    def validate_discount(cls, v, values):
        """验证折扣率不能使价格低于原价的10%"""
        if v is not None and 'price' in values:  # 确保有折扣和价格
            min_price = values['price'] * 0.1  # 最低价格为原价的10%
            if values['price'] * (1 - v) < min_price:  # 计算折扣后价格
                raise ValueError('折扣后的价格不能低于原价的10%')
        return v

    model_config = {  # Pydantic 模型配置
        "json_schema_extra": {  # JSON Schema 额外信息
            "example": {  # 完整的请求体示例
                "id": 1,
                "name": "智能手机",
                "description": "最新款智能手机",
                "price": 4999.99,
                "discount": 0.9,  # 90%折扣（即10% off）
                "stock": 100,
                "tags": ["电子产品", "智能手机"],
                "is_active": True,
                "created_at": "2023-12-19T10:00:00Z"
            }
        }
    }

class UpdateProduct(BaseModel):
    """更新商品模型 - 所有字段都是可选的，用于部分更新"""

    name: Annotated[str | None, Field(min_length=1, max_length=100)] = None
    description: Annotated[str | None, Field(max_length=500)] = None
    price: Annotated[float | None, Field(gt=0, le=999999)] = None
    discount: Annotated[float | None, Field(ge=0, le=1)] = None
    stock: Annotated[int | None, Field(ge=0)] = None
    tags: Annotated[List[str] | None, Field(max_items=10)] = None
    is_active: bool | None = None

@app.post("/products/")  # POST 路由创建新商品
async def create_product(product: Annotated[Product, Body(description="要创建的商品信息")]):
    """创建新商品 - 演示完整的字段验证"""
    return {
        "message": "商品创建成功",
        "product": product.model_dump()  # 将 Pydantic 模型转为字典
    }

@app.patch("/products/{product_id}")  # PATCH 路由部分更新商品
async def update_product(
    product_id: Annotated[int, Field(ge=1, description="商品ID")],  # 路径参数验证
    product_update: Annotated[UpdateProduct, Body(description="要更新的商品信息")]
):
    """更新商品信息 - 演示部分更新和可选字段"""
    return {
        "message": f"商品 {product_id} 更新成功",
        "product_id": product_id,
        "updates": {k: v for k, v in product_update.model_dump().items() if v is not None}
        # 只包含非None值的更新字段
    }

@app.get("/products/{product_id}")  # GET 路由获取商品信息
async def get_product(
    product_id: Annotated[int, Field(ge=1, description="商品ID")]
):
    """获取商品信息 - 演示路径参数的 Field 验证"""
    return {
        "product_id": product_id,
        "message": "商品信息获取成功"
    }
```

## 6. 技术细节

实际上, Query、Path 和你稍后将看到的其他函数创建的是一个公共 Param 类的子类的对象, 该类本身就是 Pydantic 的 FieldInfo 类的子类。

而 Pydantic 的 Field 也返回 FieldInfo 的实例。

Body 也直接返回 FieldInfo 的子类的对象。

还有其他你稍后将看到的类是 Body 类的子类。

**请记住**, 当你从 fastapi 导入 Query、Path 等时, 那些实际上是返回特殊类的函数。

**提示**: 请注意每个带有类型、默认值和 Field 的模型属性都具有与路径操作函数参数相同的结构, 只是使用 Field 而不是 Path、Query 和 Body。

## 7. 总结

- 你可以使用 Pydantic 的 Field 为模型属性声明额外的验证和元数据
- Field 提供了丰富的验证选项 (gt、ge、lt、le、min_length、max_length 等)
- Field 可以添加描述、标题等元数据, 用于自动生成的文档
- Field 与 Query、Path、Body 具有相似的参数和工作方式
- Field 从 pydantic 导入, 而不是从 fastapi

这些特性使得 FastAPI 能够构建强类型、自动验证和文档完善的 API。
