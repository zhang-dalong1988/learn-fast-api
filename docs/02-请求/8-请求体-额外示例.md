# 8. 请求体 - 额外示例

在 FastAPI 中，你可以为 API 的请求体添加示例数据。这些示例会自动显示在 API 文档中，帮助开发者理解如何正确使用你的 API。

## 8.1 为什么需要示例？

- **提升用户体验**：让使用者快速了解数据格式
- **降低学习成本**：通过示例直接展示用法
- **减少错误**：清晰的示例减少请求错误
- **自动集成**：示例会自动出现在 Swagger UI 和 ReDoc 中

## 8.2 Pydantic 模型中的示例

### 8.2.1 Pydantic v2（推荐方式）

在 Pydantic v2 中，我们使用 `model_config` 来定义示例：

```python
from fastapi import FastAPI
from pydantic import BaseModel

# 创建 FastAPI 应用实例
app = FastAPI()

# 定义商品模型
class Item(BaseModel):
    name: str                        # 商品名称（必需）
    description: str | None = None   # 商品描述（可选）
    price: float                     # 商品价格（必需）
    tax: float | None = None         # 税率（可选）

    # Pydantic v2 配置：定义 JSON Schema 的额外信息
    model_config = {
        "json_schema_extra": {  # 在生成的 JSON Schema 中添加额外信息（如示例数据）
            "examples": [              # 示例数据列表
                {
                    "summary": "基础商品示例",  # 示例标题
                    "description": "这是一个普通的商品示例",  # 示例描述
                    "value": {                   # 实际的示例数据
                        "name": "苹果手机",
                        "description": "最新款智能手机",
                        "price": 5999.0,
                        "tax": 480.0
                    }
                },
                {
                    "summary": "免税商品示例",
                    "description": "这个商品没有税费",
                    "value": {
                        "name": "香蕉",
                        "description": "进口香蕉",
                        "price": 12.5
                        # 注意：tax 字段未提供，因为它有默认值 None
                    }
                }
            ]
        }
    }

# 定义 PUT 路由：更新商品信息
@app.put("/items/{item_id}")
async def update_item(
    item_id: int,      # 路径参数：商品 ID
    item: Item         # 请求体：商品数据（会自动验证）
):
    """更新商品信息"""
    # 返回更新后的商品信息
    return {
        "item_id": item_id,
        "item": item,
        "message": f"商品 {item.name} 更新成功"
    }
```

### 8.2.2 多种示例展示

上面的代码会产生什么效果？

1. **在 Swagger UI 中**：用户可以看到两个可选择的示例
2. **自动填充功能**：点击示例后，表单会自动填充示例数据
3. **验证效果**：提交的数据会根据模型定义进行验证

## 8.3 Field 级别的示例

你也可以为每个字段单独添加示例：

```python
from fastapi import FastAPI
from pydantic import BaseModel, Field  # Field 用于字段级别的配置

app = FastAPI()

class Item(BaseModel):
    # 使用 Field 为每个字段添加详细配置
    name: str = Field(
        ...,
        examples=["笔记本电脑", "无线鼠标"],  # 名称示例
        description="商品的名称"
    )

    description: str | None = Field(
        None,  # 默认值
        examples=["高性能办公笔记本，适合商务人士使用"],  # 描述示例
        description="商品的详细描述"
    )

    price: float = Field(
        ...,
        gt=0,  # 必须大于 0
        examples=[99.99, 5999.00, 12.5],  # 价格示例
        description="商品价格（必须大于 0）"
    )

    tax: float | None = Field(
        None,
        ge=0,  # 必须大于等于 0（如果有值）
        examples=[0.0, 8.0, 480.0],  # 税费示例
        description="商品税费（如果有）"
    )

    tags: list[str] = Field(
        default=[],  # 默认为空列表
        examples=[["电子产品", "电脑"], ["食品", "水果"]],  # 标签示例
        description="商品标签列表"
    )

@app.post("/items/")
async def create_item(item: Item):
    """创建新商品"""
    return {
        "item": item,
        "message": "商品创建成功"
    }
```

**Field 的优势：**
- 每个字段都有独立的示例
- 可以设置字段级别的验证规则
- 提供更详细的字段描述

## 8.4 Body 参数中的示例

### 8.4.1 单个示例

```python
from typing import Annotated  # Python 3.9+ 需要导入（推荐使用）

from fastapi import FastAPI, Body
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None

@app.put("/items/{item_id}")
async def update_item(
    item_id: int,
    # 使用 Annotated 包装 Item 类型，添加 Body 配置
    item: Annotated[
        Item,
        Body(
            examples=[  # 在 Body 中定义示例
                {
                    "summary": "简单示例",  # 示例标题
                    "description": "一个基本的商品示例",  # 示例描述
                    "value": {  # 实际的示例数据
                        "name": "咖啡杯",
                        "price": 29.9
                    }
                }
            ]
        )
    ]
):
    return {"item_id": item_id, "item": item}
```

### 8.4.2 多个示例

```python
from typing import Annotated

from fastapi import FastAPI, Body
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None

@app.put("/items/{item_id}")
async def update_item(
    item_id: int,
    item: Annotated[
        Item,
        Body(
            # 定义多个示例，展示不同的数据格式
            examples=[
                {
                    "summary": "完整商品",  # 示例 1：包含所有字段
                    "description": "包含完整信息的商品",
                    "value": {
                        "name": "蓝牙耳机",
                        "description": "无线蓝牙降噪耳机",
                        "price": 399.0,
                        "tax": 31.2
                    }
                },
                {
                    "summary": "简化商品",  # 示例 2：只包含必要字段
                    "description": "只有必要字段的简化版商品",
                    "value": {
                        "name": "矿泉水",
                        "price": 2.0
                    }
                },
                {
                    "summary": "错误示例（会失败）",  # 示例 3：展示错误情况
                    "description": "这个示例会验证失败，因为价格小于 0",
                    "value": {
                        "name": "无效商品",
                        "price": -10.0  # 负价格会导致验证失败
                    }
                }
            ]
        )
    ]
):
    return {"item_id": item_id, "item": item}
```

## 8.5 最佳实践

### 8.5.1 示例应该真实且有用

```python
# ✅ 好的示例：真实数据
{
    "name": "iPhone 15 Pro",
    "description": "苹果最新款旗舰手机",
    "price": 8999.0,
    "tax": 720.0
}

# ❌ 不好的示例：无意义的占位符
{
    "name": "test",
    "description": "test desc",
    "price": 1.0
}
```

### 8.5.2 提供多种场景

```python
model_config = {
    "json_schema_extra": {
        "examples": [
            {
                "summary": "高端产品",
                "value": {
                    "name": "MacBook Pro",
                    "price": 15999.0
                }
            },
            {
                "summary": "平价产品",
                "value": {
                    "name": "USB 数据线",
                    "price": 19.9
                }
            },
            {
                "summary": "免费产品",
                "value": {
                    "name": "电子书",
                    "price": 0.0
                }
            }
        ]
    }
}
```

### 8.5.3 包含边界情况

```python
examples=[
    {
        "summary": "最小值",
        "value": {
            "name": "最便宜的商品",
            "price": 0.01  # 最小可能的价格
        }
    },
    {
        "summary": "空描述",
        "value": {
            "name": "神秘商品",
            "description": "",  # 空描述
            "price": 100.0
        }
    }
]
```

## 8.6 总结

为 FastAPI 添加示例的好处：

1. **自动文档生成**：示例会自动出现在 API 文档中
2. **更好的开发体验**：前端开发者可以快速了解 API 用法
3. **测试友好**：示例可以用作测试数据
4. **减少沟通成本**：示例比纯文字描述更直观

记住：好的示例应该真实、完整、多样化，并且覆盖常见的使用场景。