# 请求体

## 1. 基本概念

要向 FastAPI 路径操作 (如 POST, PUT, DELETE 或 PATCH 操作) 发送数据, 你可以使用 **Pydantic 模型**。

```python
# 从 pydantic 导入 BaseModel 基类
from pydantic import BaseModel


# 定义 Item 数据模型, 继承自 BaseModel
class Item(BaseModel):
    name: str  # 名称字段, 必填, 字符串类型
    description: str | None = None  # 描述字段, 可选, 字符串或 None
    price: float  # 价格字段, 必填, 浮点数类型
    tax: float | None = None  # 税费字段, 可选, 浮点数或 None
```

然后将它声明为路径操作的参数:

```python
# 导入 FastAPI 框架
from fastapi import FastAPI
# 从 pydantic 导入 BaseModel 基类
from pydantic import BaseModel


# 定义 Item 数据模型
class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None


# 创建应用实例
app = FastAPI()


# 定义 POST 路径操作, 接收 JSON 请求体
@app.post("/items/")
async def create_item(item: Item):
    # 直接返回接收到的 item 对象
    return item
```

## 2. 什么是 Pydantic 模型?

Pydantic 是一个 Python 库, 用于使用 Python 类型注解进行数据验证和设置管理。

Pydantic 模型是一个继承自 `BaseModel` 的类, 使用类型注解定义字段。

FastAPI 使用 Pydantic 来:
- 验证请求中的数据
- 将数据转换为声明的类型
- 为 API 文档生成 JSON Schema
- 自动生成 API 文档

## 3. 请求体 vs 路径参数

- **路径参数**: URL 路径的一部分, 如 `/items/{item_id}`
- **查询参数**: URL 中 `?` 后面的键值对, 如 `?skip=0&limit=10`
- **请求体**: 在请求体中发送的数据 (通常是 JSON)

## 4. 完整示例

这是一个包含所有类型参数的完整示例:

```python
# 导入 FastAPI 框架
from fastapi import FastAPI
# 从 pydantic 导入 BaseModel 基类
from pydantic import BaseModel


# 定义 Item 数据模型
class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None


# 创建应用实例
app = FastAPI()


# 定义 PUT 路径操作, 包含路径参数和请求体
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Item):
    # 返回包含 item_id 和 item 所有字段的字典
    return {"item_id": item_id, **item.dict()}
```

在这个例子中:
- `item_id` 是路径参数 (整数)
- `item` 是请求体 (Pydantic 模型)

JSON 请求体应该是这样:

```json
{
    "name": "Foo",
    "description": "The description",
    "price": 45.2,
    "tax": 3.5
}
```

## 5. 可选字段

有默认值的字段 (如 `description: str | None = None`) 是可选的。

在 JSON 中, 你可以省略它们:

```json
{
    "name": "Foo",
    "price": 45.2
}
```

或者包含它们并设为 `null`:

```json
{
    "name": "Foo",
    "description": null,
    "price": 45.2
}
```

## 6. 请求体 + 路径参数 + 查询参数

你还可以同时声明路径参数, 查询参数和请求体:

```python
# 导入 FastAPI 框架
from fastapi import FastAPI
# 从 pydantic 导入 BaseModel 基类
from pydantic import BaseModel


# 定义 Item 数据模型
class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None


# 创建应用实例
app = FastAPI()


# 定义 PUT 路径操作, 包含路径参数, 请求体和查询参数
@app.put("/items/{item_id}")
async def update_item(
    item_id: int,
    item: Item,
    q: str | None = None
):
    # 创建包含 item_id 和 item 字段的结果字典
    result = {"item_id": item_id, **item.dict()}
    # 如果提供了查询参数 q, 添加到结果中
    if q:
        result.update({"q": q})
    # 返回结果
    return result
```

在这个例子中:
- `item_id` 是路径参数
- `item` 是请求体
- `q` 是可选的查询参数

## 7. 多个请求体参数

你还可以声明多个请求体参数 (例如 `item` 和 `user`):

```python
# 导入 FastAPI 框架
from fastapi import FastAPI
# 从 pydantic 导入 BaseModel 基类
from pydantic import BaseModel


# 定义 Item 数据模型
class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None


# 定义 User 数据模型
class User(BaseModel):
    username: str  # 用户名字段, 必填
    full_name: str | None = None  # 全名字段, 可选


# 创建应用实例
app = FastAPI()


# 定义 PUT 路径操作, 接收两个请求体参数
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Item, user: User):
    # 返回包含所有参数的字典
    return {
        "item_id": item_id,
        "item": item,
        "user": user
    }
```

FastAPI 会期望这样的请求体:

```json
{
    "item": {
        "name": "Foo",
        "price": 45.2
    },
    "user": {
        "username": "johndoe"
    }
}
```

注意, 键 `item` 和 `user` 是函数中的参数名称。

## 8. 请求体中的单个值

如果你想接收单个值作为请求体 (不是 JSON 对象), 可以使用 `Body`:

```python
# 导入 FastAPI 框架和 Body
from fastapi import FastAPI, Body
# 从 pydantic 导入 BaseModel 基类
from pydantic import BaseModel


# 定义 Item 数据模型
class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None


# 定义 User 数据模型
class User(BaseModel):
    username: str
    full_name: str | None = None


# 创建应用实例
app = FastAPI()


# 定义 PUT 路径操作, 包含请求体参数和单个值
@app.put("/items/{item_id}")
async def update_item(
    item_id: int,
    item: Item,
    user: User,
    importance: int = Body(...)
):
    # Body(...) 使 importance 成为请求体中的必需字段
    return {
        "item_id": item_id,
        "item": item,
        "user": user,
        "importance": importance
    }
```

`Body(...)` (其中 `...` 等同于 `Ellipsis`) 使参数在请求体中成为必需的。

JSON 请求体应该是这样:

```json
{
    "item": {
        "name": "Foo",
        "price": 45.2
    },
    "user": {
        "username": "johndoe"
    },
    "importance": 5
}
```

## 9. 如何声明必填字段

你可以通过不提供默认值来声明字段为必填:

```python
# 定义 Item 数据模型
class Item(BaseModel):
    name: str  # 必填字段, 没有默认值
    description: str | None = None  # 可选字段, 默认值为 None
    price: float  # 必填字段, 没有默认值
    tax: float | None = None  # 可选字段, 默认值为 None
```

在这里, `name` 和 `price` 是必填的。`description` 和 `tax` 是可选的 (它们的默认值为 `None`)。
