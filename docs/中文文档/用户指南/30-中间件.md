# ä¸­é—´ä»¶ (Middleware)

ä½ å¯ä»¥å‘ __FastAPI__ åº”ç”¨æ·»åŠ ä¸­é—´ä»¶ã€‚

## 1. ä»€ä¹ˆæ˜¯ä¸­é—´ä»¶

"ä¸­é—´ä»¶" æ˜¯ä¸€ä¸ªå‡½æ•°, å®ƒåœ¨æ¯ä¸ª __request__ è¢«ä»»ä½•ç‰¹å®šçš„ _path operation_ å¤„ç†ä¹‹å‰éƒ½ä¼šå·¥ä½œ. å¹¶ä¸”åœ¨æ¯ä¸ª __response__ è¿”å›ä¹‹å‰ä¹Ÿä¼šå·¥ä½œ.

ä¸­é—´ä»¶çš„å·¥ä½œæµç¨‹:

- æ¥æ”¶åˆ°è¾¾ä½ åº”ç”¨çš„æ¯ä¸ª __request__
- ç„¶åå¯ä»¥å¯¹è¿™ä¸ª __request__ åšä¸€äº›æ“ä½œæˆ–è¿è¡Œä»»ä½•éœ€è¦çš„ä»£ç 
- ç„¶åå°† __request__ ä¼ é€’ç»™åº”ç”¨çš„å…¶ä½™éƒ¨åˆ† (ç”±æŸä¸ª _path operation_) è¿›è¡Œå¤„ç†
- ç„¶åæ¥æ”¶ç”±åº”ç”¨ (ç”±æŸä¸ª _path operation_) ç”Ÿæˆçš„ __response__
- å¯ä»¥å¯¹è¿™ä¸ª __response__ åšä¸€äº›æ“ä½œæˆ–è¿è¡Œä»»ä½•éœ€è¦çš„ä»£ç 
- ç„¶åè¿”å› __response__

### æŠ€æœ¯ç»†èŠ‚

å¦‚æœä½ æœ‰å¸¦ `yield` çš„ä¾èµ–, é€€å‡ºä»£ç å°†åœ¨ä¸­é—´ä»¶ _ä¹‹å_ è¿è¡Œ.

å¦‚æœæœ‰ä»»ä½•åå°ä»»åŠ¡ (åœ¨ Background Tasks ç« èŠ‚ä¸­ä»‹ç», ç¨åä¼šçœ‹åˆ°), å®ƒä»¬å°†åœ¨æ‰€æœ‰ä¸­é—´ä»¶ _ä¹‹å_ è¿è¡Œ.

## 2. åˆ›å»ºä¸­é—´ä»¶

è¦åˆ›å»ºä¸­é—´ä»¶, ä½ å¯ä»¥åœ¨å‡½æ•°é¡¶éƒ¨ä½¿ç”¨è£…é¥°å™¨ `@app.middleware("http")`.

ä¸­é—´ä»¶å‡½æ•°æ¥æ”¶:

- `request` - è¯·æ±‚å¯¹è±¡
- å‡½æ•° `call_next` - è¯¥å‡½æ•°å°†æ¥æ”¶ `request` ä½œä¸ºå‚æ•°
  - è¯¥å‡½æ•°å°† `request` ä¼ é€’ç»™ç›¸åº”çš„ _path operation_
  - ç„¶åè¿”å›ç”±ç›¸åº”çš„ _path operation_ ç”Ÿæˆçš„ `response`
- ä½ å¯ä»¥åœ¨è¿”å›ä¹‹å‰è¿›ä¸€æ­¥ä¿®æ”¹ `response`

**Python 3.8+**

```python
# å¯¼å…¥æ—¶é—´æ¨¡å—, ç”¨äºè®¡ç®—è¯·æ±‚å¤„ç†æ—¶é—´
import time

# å¯¼å…¥ FastAPI å’Œ Request ç±»
from fastapi import FastAPI, Request

# åˆ›å»º FastAPI åº”ç”¨å®ä¾‹
app = FastAPI()

# ä½¿ç”¨è£…é¥°å™¨åˆ›å»º HTTP ä¸­é—´ä»¶
@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    # è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´ - perf_counter() æä¾›é«˜ç²¾åº¦è®¡æ—¶
    start_time = time.perf_counter()
    # è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è·¯å¾„æ“ä½œ, è·å–å“åº”
    response = await call_next(request)
    # è®¡ç®—è¯·æ±‚å¤„ç†æ€»æ—¶é—´ (ç§’)
    process_time = time.perf_counter() - start_time
    # å°†å¤„ç†æ—¶é—´æ·»åŠ åˆ°å“åº”å¤´ä¸­, è‡ªå®šä¹‰å“åº”å¤´é€šå¸¸ä½¿ç”¨ "X-" å‰ç¼€
    response.headers["X-Process-Time"] = str(process_time)
    # è¿”å›ä¿®æ”¹åçš„å“åº”
    return response
```

### æŠ€æœ¯ç»†èŠ‚

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `from starlette.requests import Request`.

__FastAPI__ ä¸ºäº†æ–¹ä¾¿å¼€å‘è€…ç›´æ¥æä¾›äº†å®ƒ. ä½†å®ƒå®é™…ä¸Šæ¥è‡ª Starlette.

## 3. åœ¨ response ä¹‹å‰å’Œä¹‹åæ·»åŠ ä»£ç 

ä½ å¯ä»¥åœ¨ä»»ä½• _path operation_ æ¥æ”¶åˆ° `request` ä¹‹å‰, æ·»åŠ ä¸ `request` ä¸€èµ·è¿è¡Œçš„ä»£ç .

ä¹Ÿå¯ä»¥åœ¨ç”Ÿæˆ `response` ä¹‹å, è¿”å›å®ƒä¹‹å‰æ·»åŠ ä»£ç .

ä¾‹å¦‚, ä½ å¯ä»¥æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰å“åº”å¤´ `X-Process-Time`, åŒ…å«å¤„ç†è¯·æ±‚å’Œç”Ÿæˆå“åº”æ‰€èŠ±è´¹çš„æ—¶é—´ (ç§’):

**Python 3.8+**

```python
# å¯¼å…¥æ—¶é—´æ¨¡å—, ç”¨äºè®¡ç®—è¯·æ±‚å¤„ç†æ—¶é—´
import time

# å¯¼å…¥ FastAPI å’Œ Request ç±»
from fastapi import FastAPI, Request

# åˆ›å»º FastAPI åº”ç”¨å®ä¾‹
app = FastAPI()

# ä½¿ç”¨è£…é¥°å™¨åˆ›å»º HTTP ä¸­é—´ä»¶
@app.middleware("http")
async def add_process_time_header(request: Request, call_next):
    # è®°å½•è¯·æ±‚å¼€å§‹æ—¶é—´ - ä½¿ç”¨ perf_counter() å› ä¸ºå®ƒæ¯” time() æ›´ç²¾ç¡®
    start_time = time.perf_counter()
    # è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è·¯å¾„æ“ä½œ, è·å–å“åº”
    # call_next ä¼šå°†è¯·æ±‚ä¼ é€’ç»™è·¯å¾„æ“ä½œå¤„ç†
    response = await call_next(request)
    # è®¡ç®—è¯·æ±‚å¤„ç†æ€»æ—¶é—´ (ç§’)
    # perf_counter() è¿”å›æ€§èƒ½è®¡æ•°å™¨çš„å€¼ (ä»¥ç§’ä¸ºå•ä½), åŒ…æ‹¬ç¡çœ æ—¶é—´
    process_time = time.perf_counter() - start_time
    # å°†å¤„ç†æ—¶é—´æ·»åŠ åˆ°å“åº”å¤´ä¸­
    # è‡ªå®šä¹‰å“åº”å¤´é€šå¸¸ä½¿ç”¨ "X-" å‰ç¼€, è¿™æ˜¯ HTTP çº¦å®š
    response.headers["X-Process-Time"] = str(process_time)
    # è¿”å›ä¿®æ”¹åçš„å“åº”
    return response
```

### æç¤º

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ `time.perf_counter()` è€Œä¸æ˜¯ `time.time()`, å› ä¸ºå®ƒå¯¹äºè¿™äº›ç”¨ä¾‹å¯ä»¥æ›´ç²¾ç¡®. ğŸ¤“

## 4. å¤šä¸ªä¸­é—´ä»¶çš„æ‰§è¡Œé¡ºåº

å½“ä½ ä½¿ç”¨ `@app.middleware()` è£…é¥°å™¨æˆ– `app.add_middleware()` æ–¹æ³•æ·»åŠ å¤šä¸ªä¸­é—´ä»¶æ—¶, æ¯ä¸ªæ–°ä¸­é—´ä»¶éƒ½ä¼šåŒ…è£…åº”ç”¨, å½¢æˆä¸€ä¸ªæ ˆ. æœ€åæ·»åŠ çš„ä¸­é—´ä»¶æ˜¯ _æœ€å¤–å±‚_, ç¬¬ä¸€ä¸ªæ˜¯ _æœ€å†…å±‚_.

åœ¨è¯·æ±‚è·¯å¾„ä¸Š, _æœ€å¤–å±‚_ ä¸­é—´ä»¶å…ˆè¿è¡Œ.

åœ¨å“åº”è·¯å¾„ä¸Š, å®ƒæœ€åè¿è¡Œ.

ä¾‹å¦‚:

```python
# æ·»åŠ ä¸­é—´ä»¶ A - å…ˆæ·»åŠ , æ‰€ä»¥åœ¨æ›´å†…å±‚
app.add_middleware(MiddlewareA)
# æ·»åŠ ä¸­é—´ä»¶ B - åæ·»åŠ , æ‰€ä»¥åœ¨æ›´å¤–å±‚
app.add_middleware(MiddlewareB)
```

è¿™ä¼šå¯¼è‡´ä»¥ä¸‹æ‰§è¡Œé¡ºåº:

- __Request (è¯·æ±‚)__: MiddlewareB â†’ MiddlewareA â†’ route
  - è¯·æ±‚å…ˆç»è¿‡ MiddlewareB (æœ€å¤–å±‚)
  - ç„¶åç»è¿‡ MiddlewareA (å†…å±‚)
  - æœ€ååˆ°è¾¾è·¯ç”±å¤„ç†å‡½æ•°
- __Response (å“åº”)__: route â†’ MiddlewareA â†’ MiddlewareB
  - å“åº”ä»è·¯ç”±å¤„ç†å‡½æ•°è¿”å›
  - ç„¶åç»è¿‡ MiddlewareA (å†…å±‚)
  - æœ€åç»è¿‡ MiddlewareB (æœ€å¤–å±‚)

è¿™ç§æ ˆå¼è¡Œä¸ºç¡®ä¿ä¸­é—´ä»¶ä»¥å¯é¢„æµ‹å’Œå¯æ§çš„é¡ºåºæ‰§è¡Œ.

## 5. å…¶ä»–ä¸­é—´ä»¶

ä½ ç¨åå¯ä»¥åœ¨é«˜çº§ç”¨æˆ·æŒ‡å—ä¸­é˜…è¯»æ›´å¤šå…³äºå…¶ä»–ä¸­é—´ä»¶çš„å†…å®¹: Advanced Middleware.

åœ¨ä¸‹ä¸€èŠ‚ä¸­, ä½ å°†é˜…è¯»å¦‚ä½•ä½¿ç”¨ä¸­é—´ä»¶å¤„ç† CORS.
