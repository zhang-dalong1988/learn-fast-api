# 路径参数

## 1. 基本语法

你可以使用与 Python 格式字符串相同的语法声明路径 "参数" 或 "变量":

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()


# 定义一个路径操作，其中 {item_id} 是路径参数
@app.get("/items/{item_id}")
async def read_item(item_id: str):
    # item_id 参数会从 URL 中自动提取并传递给函数
    # 返回包含 item_id 的字典
    return {"item_id": item_id}
```

路径参数 `item_id` 的值会作为参数 `item_id` 传递给你的函数。

因此，如果你运行这个示例并访问 `http://127.0.0.1:8000/items/foo`，你会看到类似这样的响应:

```json
{"item_id": "foo"}
```

## 2. 带类型的路径参数

你可以使用标准的 Python 类型注解来声明路径参数的类型，使用与 Pydantic 模型相同的语法:

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()


# 定义路径操作，item_id 参数声明为 int 类型
@app.get("/items/{item_id}")
async def read_item(item_id: int):
    # FastAPI 会自动将字符串转换为整数
    # 返回包含整数类型 item_id 的字典
    return {"item_id": item_id}
```

在这个例子中，`item_id` 被声明为 `int` 类型。

### 2.1 测试

访问 `http://127.0.0.1:8000/items/3`。

你会得到类似这样的响应:

```json
{"item_id": 3}
```

这会提供编辑器支持 (错误检查、自动补全等)，并将值转换为指定的类型。

## 3. 数据验证

如果你访问 `http://127.0.0.1:8000/items/foo` 呢？

你会得到一个友好的 HTTP 错误，像这样:

```json
{
    "detail": [
        {
            "loc": [
                "path",
                "item_id"
            ],
            "msg": "value is not a valid integer",
            "type": "type_error.integer"
        }
    ]
}
```

这是因为路径参数 `item_id` 被声明为 `int` 类型。

因此，`foo` 不是有效的整数。

如果你提供一个浮点数而不是整数，也会出现同样的错误: 例如 `http://127.0.0.1:8000/items/4.2`

因为 `4.2` 也不是有效的整数。

**注意**: FastAPI 会自动将字符串 `"3"` 转换为整数 `3`。

## 4. 路径顺序很重要

在创建路径操作时，你可能会遇到某些路径是固定的情况。

比如 `/users/me`，假设它是用来获取当前用户的数据。

然后你还可以有一个路径 `/users/{user_id}`，通过 ID 获取特定用户的数据。

因为路径操作是按顺序评估的，你需要确保 `/users/me` 的路径在 `/users/{user_id}` 之前声明:

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()


# 定义获取当前用户的路径操作（固定路径）
@app.get("/users/me")
async def read_user_me():
    # 返回当前用户的信息
    return {"user_id": "the current user"}


# 定义通过 ID 获取用户的路径操作（动态路径）
@app.get("/users/{user_id}")
async def read_user(user_id: str):
    # 返回指定 ID 的用户信息
    return {"user_id": user_id}
```

否则，`/users/{user_id}` 的路径也会匹配 `/users/me`，认为它接收的是一个值为 `"me"` 的参数 `user_id`。

## 5. 预定义值

如果你有一个路径操作接收路径参数，但你希望有效的路径参数值是预定义的，你可以使用标准的 Python `Enum`:

### 5.1 创建 Enum 类

创建一个继承自 `str` 和 `enum.Enum` 的 Enum 类。

同时继承 `str` 作为 Enum 类的基类。通过继承 `str`，API 文档能够知道值必须是 `string` 类型，并能够正确渲染它们。

然后使用固定值声明类属性，这些将是可用的有效值:

```python
# 导入枚举类 Enum
from enum import Enum

# 导入 FastAPI 框架
from fastapi import FastAPI


# 定义模型名称枚举类，继承 str 和 Enum
class ModelName(str, Enum):
    # 定义三个可用的模型名称
    alexnet = "alexnet"  # AlexNet 模型
    resnet = "resnet"    # ResNet 模型
    lenet = "lenet"      # LeNet 模型


# 创建应用实例
app = FastAPI()


# 定义模型路径操作，模型名称必须是预定义的枚举值之一
@app.get("/models/{model_name}")
async def get_model(model_name: ModelName):
    # 如果模型是 AlexNet，返回深度学习相关的消息
    if model_name == ModelName.alexnet:
        return {"model_name": model_name, "message": "Deep Learning FTW!"}

    # 如果模型是 LeNet（使用 .value 获取实际值），返回 LeCNN 相关消息
    if model_name.value == "lenet":
        return {"model_name": model_name, "message": "LeCNN all the images"}

    # 其他模型（如 ResNet），返回残差连接相关消息
    return {"model_name": model_name, "message": "Have some residual connections"}
```

### 5.2 使用枚举

你可以将 Enum 类用作路径操作函数参数的类型注解:

```python
# 导入枚举类 Enum
from enum import Enum

# 导入 FastAPI 框架
from fastapi import FastAPI


# 定义模型名称枚举类
class ModelName(str, Enum):
    alexnet = "alexnet"
    resnet = "resnet"
    lenet = "lenet"


# 创建应用实例
app = FastAPI()


# 使用枚举类型限制模型名称参数
@app.get("/models/{model_name}")
async def get_model(model_name: ModelName):
    # 根据不同的模型返回不同的消息
    if model_name == ModelName.alexnet:
        return {"model_name": model_name, "message": "Deep Learning FTW!"}

    if model_name.value == "lenet":
        return {"model_name": model_name, "message": "LeCNN all the examples"}

    return {"model_name": model_name, "message": "Have some residual connections"}
```

## 6. 路径转换器

你可以使用 `path` 类型 (像 `str`、`int` 等) 来声明包含路径的路径参数:

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()


# 定义文件路径操作，使用 :path 转换器匹配任意路径
@app.get("/files/{file_path:path}")
async def read_file(file_path: str):
    # file_path 可以包含斜杠，匹配任意路径
    return {"file_path": file_path}
```

**注意**: 路径参数 `file_path` 需要有类型注解 `str` (或任何其他会被转换为 `str` 的类型)，否则不会正常工作。

### 6.1 示例

URL: `/files//home/johndoe/myfile.txt`

路径参数将是: `/home/johndoe/myfile.txt`

开头的 `/` 会生成不同的路径，所以 URL 会是 `/files/home/johndoe/myfile.txt`。

如果你希望路径参数包含一个路径，可以使用 `:path` 语法告诉 FastAPI 该参数应该匹配任何路径。

例如，URL `/files//home/johndoe/myfile.txt` 的 file_path 将是 `/home/johndoe/myfile.txt`。

## 7. 总结

使用路径参数，你可以:

* 声明路径参数的类型
* 获得数据验证
* 获得数据转换
* 获得带有路径参数的 API 文档

并且你可以:

* 排序路径操作
* 使用枚举定义预定义值
* 使用路径转换器
