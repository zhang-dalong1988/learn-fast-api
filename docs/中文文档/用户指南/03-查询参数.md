# 查询参数

当你声明不属于路径参数的其他函数参数时, 它们会被自动解释为 "查询" 参数。

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 模拟数据库中的项目列表
fake_items_db = [{"item_name": "Foo"}, {"item_name": "Bar"}, {"item_name": "Baz"}]

# 定义路径操作, 使用查询参数 skip 和 limit
@app.get("/items/")
async def read_item(skip: int = 0, limit: int = 10):
    # 返回从 skip 开始到 skip+limit 的项目列表
    return fake_items_db[skip : skip + limit]
```

查询是 URL 中 `?` 后面的一组键值对, 用 `&` 字符分隔。

例如, 在 URL 中:

```
http://127.0.0.1:8000/items/?skip=0&limit=10
```

...查询参数是:

- `skip`: 值为 `0`
- `limit`: 值为 `10`

由于它们是 URL 的一部分, 它们 "自然" 是字符串。

但是当你用 Python 类型声明它们时 (在上面的例子中, 为 `int`), 它们会被转换为该类型并针对该类型进行验证。

应用于路径参数的所有相同过程也适用于查询参数:

- 编辑器支持 (显然)
- 数据 "解析"
- 数据验证
- 自动文档

## 1. 默认值

由于查询参数不是路径的固定部分, 它们可以是可选的, 并且可以有默认值。

在上面的例子中, 它们的默认值是 `skip=0` 和 `limit=10`。

因此, 访问 URL:

```
http://127.0.0.1:8000/items/
```

与访问以下 URL 相同:

```
http://127.0.0.1:8000/items/?skip=0&limit=10
```

但如果你访问, 例如:

```
http://127.0.0.1:8000/items/?skip=20
```

你函数中的参数值将是:

- `skip=20`: 因为你在 URL 中设置了它
- `limit=10`: 因为那是默认值

## 2. 可选参数

同样, 你可以通过将可选查询参数的默认值设置为 `None` 来声明它们:

### 2.1 Python 3.10+

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 定义路径操作, 包含路径参数和可选查询参数
@app.get("/items/{item_id}")
async def read_item(item_id: str, q: str | None = None):
    # 如果提供了查询参数 q, 则返回包含 q 的响应
    if q:
        return {"item_id": item_id, "q": q}
    # 否则只返回 item_id
    return {"item_id": item_id}
```

### 2.2 Python 3.8+

```python
# 从 typing 模块导入 Union 类型
from typing import Union
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 定义路径操作, 包含路径参数和可选查询参数
@app.get("/items/{item_id}")
async def read_item(item_id: str, q: Union[str, None] = None):
    # 如果提供了查询参数 q, 则返回包含 q 的响应
    if q:
        return {"item_id": item_id, "q": q}
    # 否则只返回 item_id
    return {"item_id": item_id}
```

在这种情况下, 函数参数 `q` 将是可选的, 并且默认为 `None`。

### 2.3 验证

还要注意 **FastAPI** 足够聪明, 能够注意到路径参数 `item_id` 是路径参数, 而 `q` 不是, 所以它是查询参数。

## 3. 查询参数类型转换

你还可以声明 `bool` 类型, 它们将被转换:

### 3.1 Python 3.10+

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 定义路径操作, 包含可选查询参数 q 和 short
@app.get("/items/{item_id}")
async def read_item(item_id: str, q: str | None = None, short: bool = False):
    # 创建包含 item_id 的基础响应
    item = {"item_id": item_id}
    # 如果提供了查询参数 q, 则将其添加到响应中
    if q:
        item.update({"q": q})
    # 如果 short 为 False, 则添加详细描述
    if not short:
        item.update(
            {"description": "This is an amazing item that has a long description"}
        )
    return item
```

### 3.2 Python 3.8+

```python
# 从 typing 模块导入 Union 类型
from typing import Union
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 定义路径操作, 包含可选查询参数 q 和 short
@app.get("/items/{item_id}")
async def read_item(item_id: str, q: Union[str, None] = None, short: bool = False):
    # 创建包含 item_id 的基础响应
    item = {"item_id": item_id}
    # 如果提供了查询参数 q, 则将其添加到响应中
    if q:
        item.update({"q": q})
    # 如果 short 为 False, 则添加详细描述
    if not short:
        item.update(
            {"description": "This is an amazing item that has a long description"}
        )
    return item
```

在这种情况下, 如果你访问:

```
http://127.0.0.1:8000/items/foo?short=1
```

或

```
http://127.0.0.1:8000/items/foo?short=True
```

或

```
http://127.0.0.1:8000/items/foo?short=true
```

或

```
http://127.0.0.1:8000/items/foo?short=on
```

或

```
http://127.0.0.1:8000/items/foo?short=yes
```

或任何其他大小写变体 (大写, 首字母大写等), 你的函数将看到参数 `short` 的 `bool` 值为 `True`。否则为 `False`。

## 4. 多个路径和查询参数

你可以同时声明多个路径参数和查询参数, **FastAPI** 知道哪个是哪个。

而且你不必按任何特定顺序声明它们。

它们将按名称检测:

### 4.1 Python 3.10+

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 定义路径操作, 包含两个路径参数和两个查询参数
@app.get("/users/{user_id}/items/{item_id}")
async def read_user_item(
    user_id: int, item_id: str, q: str | None = None, short: bool = False
):
    # 创建包含 item_id 和 owner_id 的基础响应
    item = {"item_id": item_id, "owner_id": user_id}
    # 如果提供了查询参数 q, 则将其添加到响应中
    if q:
        item.update({"q": q})
    # 如果 short 为 False, 则添加详细描述
    if not short:
        item.update(
            {"description": "This is an amazing item that has a long description"}
        )
    return item
```

### 4.2 Python 3.8+

```python
# 从 typing 模块导入 Union 类型
from typing import Union
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 定义路径操作, 包含两个路径参数和两个查询参数
@app.get("/users/{user_id}/items/{item_id}")
async def read_user_item(
    user_id: int, item_id: str, q: Union[str, None] = None, short: bool = False
):
    # 创建包含 item_id 和 owner_id 的基础响应
    item = {"item_id": item_id, "owner_id": user_id}
    # 如果提供了查询参数 q, 则将其添加到响应中
    if q:
        item.update({"q": q})
    # 如果 short 为 False, 则添加详细描述
    if not short:
        item.update(
            {"description": "This is an amazing item that has a long description"}
        )
    return item
```

## 5. 必需查询参数

当你为非路径参数声明默认值时 (目前, 我们只看到了查询参数), 它不是必需的。

如果你不想添加特定值而只是使其可选, 请将默认值设置为 `None`。

但是当你想要使查询参数成为必需参数时, 你可以不声明任何默认值:

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 定义路径操作, 包含必需查询参数 needy
@app.get("/items/{item_id}")
async def read_user_item(item_id: str, needy: str):
    # 返回包含 item_id 和 needy 的响应
    item = {"item_id": item_id, "needy": needy}
    return item
```

这里查询参数 `needy` 是类型为 `str` 的必需查询参数。

如果你在浏览器中打开像这样的 URL:

```
http://127.0.0.1:8000/items/foo-item
```

...而不添加必需参数 `needy`, 你将看到类似这样的错误:

```json
{
  "detail": [
    {
      "type": "missing",
      "loc": [
        "query",
        "needy"
      ],
      "msg": "Field required",
      "input": null
    }
  ]
}
```

由于 `needy` 是必需参数, 你需要在 URL 中设置它:

```
http://127.0.0.1:8000/items/foo-item?needy=sooooneedy
```

...这将工作:

```json
{
    "item_id": "foo-item",
    "needy": "sooooneedy"
}
```

当然, 你可以将一些参数定义为必需的, 一些参数定义为具有默认值, 一些参数定义为完全可选的:

### 5.1 Python 3.10+

```python
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 定义路径操作, 包含必需参数, 有默认值的参数和可选参数
@app.get("/items/{item_id}")
async def read_user_item(
    item_id: str, needy: str, skip: int = 0, limit: int | None = None
):
    # 返回包含所有参数的响应
    item = {"item_id": item_id, "needy": needy, "skip": skip, "limit": limit}
    return item
```

### 5.2 Python 3.8+

```python
# 从 typing 模块导入 Union 类型
from typing import Union
# 导入 FastAPI 框架
from fastapi import FastAPI

# 创建应用实例
app = FastAPI()

# 定义路径操作, 包含必需参数, 有默认值的参数和可选参数
@app.get("/items/{item_id}")
async def read_user_item(
    item_id: str, needy: str, skip: int = 0, limit: Union[int, None] = None
):
    # 返回包含所有参数的响应
    item = {"item_id": item_id, "needy": needy, "skip": skip, "limit": limit}
    return item
```

在这种情况下, 有 3 个查询参数:

- `needy`, 必需的 `str`
- `skip`, 默认值为 `0` 的 `int`
- `limit`, 可选的 `int`

## 6. 总结

使用查询参数, 你可以:

* 声明默认值
* 使用 `None` 将它们声明为 `可选`
* 声明必需的查询参数
* 声明查询参数类型
* 获得数据验证
* 获得数据转换
* 获得带有查询参数的 API 文档
