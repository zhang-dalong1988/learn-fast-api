# 请求体 - 字段

与使用 `Query`、`Path` 和 `Body` 在路径操作函数参数中声明额外验证和元数据的方式相同, 你可以使用 Pydantic 的 `Field` 在 Pydantic 模型内部声明验证和元数据。

## 1. 导入 Field

首先, 你需要导入它:

### Python 3.10+

```python
# 从 typing 模块导入 Annotated, 用于类型注解
from typing import Annotated

# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型, 继承自 Pydantic 的 BaseModel
class Item(BaseModel):
    # name 字段, 必需的字符串
    name: str
    # description 字段, 可选的字符串, 使用 Field 声明验证和元数据
    description: str | None = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度为 300 个字符
    )
    # price 字段, 必需的浮点数, 使用 Field 声明验证
    price: float = Field(
        gt=0,                                           # 必须大于 0
        description="The price must be greater than zero"  # 字段描述
    )
    # tax 字段, 可选的浮点数
    tax: float | None = None


# 定义 PUT 路由操作, 用于更新物品
@app.put("/items/{item_id}")
# item_id: 路径参数, 整数类型
# item: 请求体, 使用 Annotated 标注, Body(embed=True) 表示将请求体嵌套在 JSON 中
async def update_item(item_id: int, item: Annotated[Item, Body(embed=True)]):
    # 返回包含 item_id 和 item 的字典
    results = {"item_id": item_id, "item": item}
    return results
```

### Python 3.9+

```python
# 从 typing 模块导入 Annotated 和 Union
from typing import Annotated, Union

# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型
class Item(BaseModel):
    # name 字段, 必需的字符串
    name: str
    # description 字段, 可选的字符串或 None
    description: Union[str, None] = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度为 300 个字符
    )
    # price 字段, 必需的浮点数, 使用 Field 声明验证
    price: float = Field(
        gt=0,                                           # 必须大于 0
        description="The price must be greater than zero"  # 字段描述
    )
    # tax 字段, 可选的浮点数或 None
    tax: Union[float, None] = None


# 定义 PUT 路由操作
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Annotated[Item, Body(embed=True)]):
    # 返回包含 item_id 和 item 的字典
    results = {"item_id": item_id, "item": item}
    return results
```

### Python 3.8+

```python
# 从 typing 模块导入 Union
from typing import Union

# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field
# 从 typing_extensions 导入 Annotated (Python 3.8 需要)
from typing_extensions import Annotated

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型
class Item(BaseModel):
    # name 字段, 必需的字符串
    name: str
    # description 字段, 可选的字符串或 None
    description: Union[str, None] = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度为 300 个字符
    )
    # price 字段, 必需的浮点数, 使用 Field 声明验证
    price: float = Field(
        gt=0,                                           # 必须大于 0
        description="The price must be greater than zero"  # 字段描述
    )
    # tax 字段, 可选的浮点数或 None
    tax: Union[float, None] = None


# 定义 PUT 路由操作
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Annotated[Item, Body(embed=True)]):
    # 返回包含 item_id 和 item 的字典
    results = {"item_id": item_id, "item": item}
    return results
```

**提示**

如果可能, 优先使用 `Annotated` 版本。

### Python 3.10+ - 非 Annotated 版本

```python
# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型
class Item(BaseModel):
    # name 字段, 必需的字符串
    name: str
    # description 字段, 可选的字符串或 None
    description: str | None = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度为 300 个字符
    )
    # price 字段, 必需的浮点数, 使用 Field 声明验证
    price: float = Field(
        gt=0,                                           # 必须大于 0
        description="The price must be greater than zero"  # 字段描述
    )
    # tax 字段, 可选的浮点数或 None
    tax: float | None = None


# 定义 PUT 路由操作
@app.put("/items/{item_id}")
# 使用默认值的方式标注 Body(embed=True), 而不是 Annotated
async def update_item(item_id: int, item: Item = Body(embed=True)):
    # 返回包含 item_id 和 item 的字典
    results = {"item_id": item_id, "item": item}
    return results
```

**提示**

如果可能, 优先使用 `Annotated` 版本。

### Python 3.8+ - 非 Annotated 版本

```python
# 从 typing 模块导入 Union
from typing import Union

# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型
class Item(BaseModel):
    # name 字段, 必需的字符串
    name: str
    # description 字段, 可选的字符串或 None
    description: Union[str, None] = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度为 300 个字符
    )
    # price 字段, 必需的浮点数, 使用 Field 声明验证
    price: float = Field(
        gt=0,                                           # 必须大于 0
        description="The price must be greater than zero"  # 字段描述
    )
    # tax 字段, 可选的浮点数或 None
    tax: Union[float, None] = None


# 定义 PUT 路由操作
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Item = Body(embed=True)):
    # 返回包含 item_id 和 item 的字典
    results = {"item_id": item_id, "item": item}
    return results
```

**警告**

注意 `Field` 是直接从 `pydantic` 导入的, 而不是像其他所有的 (`Query`, `Path`, `Body` 等) 那样从 `fastapi` 导入。

## 2. 声明模型属性

然后你可以在模型属性中使用 `Field`:

### Python 3.10+

```python
# 从 typing 模块导入 Annotated
from typing import Annotated

# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型, 继承自 BaseModel
class Item(BaseModel):
    # name: 物品名称, 必需的字符串
    name: str
    # description: 物品描述, 可选字段
    # 使用 Field 声明了:
    # - 默认值为 None
    # - 标题为 "The description of the item"
    # - 最大长度为 300 个字符
    description: str | None = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度限制
    )
    # price: 物品价格, 必需的浮点数
    # 使用 Field 声明了:
    # - gt=0: 必须 greater than 0 (大于 0)
    # - description: 字段描述信息
    price: float = Field(
        gt=0,                                           # 大于 0 的验证
        description="The price must be greater than zero"  # 描述信息
    )
    # tax: 税费, 可选的浮点数
    tax: float | None = None


# 定义 PUT 路由, 更新物品信息
# item_id: 路径参数, 物品 ID
# item: 请求体, 使用 Annotated 标注为 Item 类型
#        Body(embed=True) 表示请求体将嵌套在一个 JSON 对象中
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Annotated[Item, Body(embed=True)]):
    # 返回结果字典, 包含 item_id 和更新后的 item 对象
    results = {"item_id": item_id, "item": item}
    return results
```

### Python 3.9+

```python
# 从 typing 模块导入 Annotated 和 Union
from typing import Annotated, Union

# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型
class Item(BaseModel):
    # name: 物品名称, 必需的字符串
    name: str
    # description: 物品描述, 可选的字符串或 None
    # 使用 Field 添加验证规则和元数据
    description: Union[str, None] = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度为 300 个字符
    )
    # price: 物品价格, 必需的浮点数
    # gt=0 表示值必须大于 0
    price: float = Field(
        gt=0,                                           # 大于 0 的验证规则
        description="The price must be greater than zero"  # 字段描述
    )
    # tax: 税费, 可选的浮点数或 None
    tax: Union[float, None] = None


# 定义 PUT 路由
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Annotated[Item, Body(embed=True)]):
    # 返回更新结果
    results = {"item_id": item_id, "item": item}
    return results
```

### Python 3.8+

```python
# 从 typing 模块导入 Union
from typing import Union

# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field
# 从 typing_extensions 导入 Annotated (Python 3.8 需要额外安装)
from typing_extensions import Annotated

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型
class Item(BaseModel):
    # name: 物品名称, 必需的字符串
    name: str
    # description: 物品描述, 可选的字符串或 None
    # 使用 Field 添加验证规则和元数据
    description: Union[str, None] = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度为 300 个字符
    )
    # price: 物品价格, 必需的浮点数
    price: float = Field(
        gt=0,                                           # 必须大于 0
        description="The price must be greater than zero"  # 字段描述
    )
    # tax: 税费, 可选的浮点数或 None
    tax: Union[float, None] = None


# 定义 PUT 路由
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Annotated[Item, Body(embed=True)]):
    # 返回更新结果
    results = {"item_id": item_id, "item": item}
    return results
```

**提示**

如果可能, 优先使用 `Annotated` 版本。

### Python 3.10+ - 非 Annotated 版本

```python
# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型
class Item(BaseModel):
    # name: 物品名称, 必需的字符串
    name: str
    # description: 物品描述, 可选的字符串或 None
    description: str | None = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度为 300 个字符
    )
    # price: 物品价格, 必需的浮点数
    price: float = Field(
        gt=0,                                           # 必须大于 0
        description="The price must be greater than zero"  # 字段描述
    )
    # tax: 税费, 可选的浮点数或 None
    tax: float | None = None


# 定义 PUT 路由
@app.put("/items/{item_id}")
# 使用默认值的方式标注 Body(embed=True)
async def update_item(item_id: int, item: Item = Body(embed=True)):
    # 返回更新结果
    results = {"item_id": item_id, "item": item}
    return results
```

**提示**

如果可能, 优先使用 `Annotated` 版本。

### Python 3.8+ - 非 Annotated 版本

```python
# 从 typing 模块导入 Union
from typing import Union

# 从 fastapi 导入 Body 和 FastAPI
from fastapi import Body, FastAPI
# 从 pydantic 导入 BaseModel 和 Field
from pydantic import BaseModel, Field

# 创建 FastAPI 应用实例
app = FastAPI()


# 定义 Item 模型
class Item(BaseModel):
    # name: 物品名称, 必需的字符串
    name: str
    # description: 物品描述, 可选的字符串或 None
    description: Union[str, None] = Field(
        default=None,                                    # 默认值为 None
        title="The description of the item",            # 字段标题
        max_length=300                                  # 最大长度为 300 个字符
    )
    # price: 物品价格, 必需的浮点数
    price: float = Field(
        gt=0,                                           # 必须大于 0
        description="The price must be greater than zero"  # 字段描述
    )
    # tax: 税费, 可选的浮点数或 None
    tax: Union[float, None] = None


# 定义 PUT 路由
@app.put("/items/{item_id}")
async def update_item(item_id: int, item: Item = Body(embed=True)):
    # 返回更新结果
    results = {"item_id": item_id, "item": item}
    return results
```

`Field` 的工作方式与 `Query`、`Path` 和 `Body` 相同, 它具有所有相同的参数等。

**技术细节**

实际上, `Query`、`Path` 和你接下来会看到的其他方法创建的是公共 `Param` 类的子类对象, 而 `Param` 类本身又是 Pydantic 的 `FieldInfo` 类的子类。

而 Pydantic 的 `Field` 也返回 `FieldInfo` 的实例。

`Body` 也直接返回 `FieldInfo` 子类的对象。你稍后会看到的其他类也是 `Body` 类的子类。

请记住, 当你从 `fastapi` 导入 `Query`、`Path` 和其他类时, 这些实际上是返回特殊类的函数。

**提示**

请注意, 每个具有类型、默认值和 `Field` 的模型属性, 与路径操作函数的参数具有相同的结构, 只是用 `Field` 代替了 `Path`、`Query` 和 `Body`。

你可以在 `Field`、`Query`、`Body` 等中声明额外信息。这些信息将被包含在生成的 JSON Schema 中。

稍后在学习如何声明示例时, 你将了解更多关于添加额外信息的内容。

**警告**

传递给 `Field` 的额外键也会出现在应用程序生成的 OpenAPI schema 中。
由于这些键可能不属于 OpenAPI 规范的一部分, 一些 OpenAPI 工具(例如 OpenAPI 验证器)可能无法使用你生成的 schema。

## 3. 总结

你可以使用 Pydantic 的 `Field` 为模型属性声明额外的验证和元数据。

你还可以使用额外的关键字参数传递额外的 JSON Schema 元数据。
