# æ›´å¤§çš„åº”ç”¨ - å¤šæ–‡ä»¶

å¦‚æœä½ æ­£åœ¨æ„å»ºä¸€ä¸ªåº”ç”¨æˆ– web API, å¾ˆå°‘èƒ½å°†æ‰€æœ‰å†…å®¹æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚

__FastAPI__ æä¾›äº†ä¸€ä¸ªä¾¿æ·å·¥å…·æ¥æ„å»ºä½ çš„åº”ç”¨ç»“æ„, åŒæ—¶ä¿æŒæ‰€æœ‰çµæ´»æ€§ã€‚

### æç¤º

å¦‚æœä½ æ¥è‡ª Flask, è¿™ç›¸å½“äº Flask çš„ Blueprintsã€‚

## 1. ç¤ºä¾‹æ–‡ä»¶ç»“æ„

å‡è®¾ä½ æœ‰ä¸€ä¸ªåƒè¿™æ ·çš„æ–‡ä»¶ç»“æ„:

```
.
â”œâ”€â”€ app
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ dependencies.py
â”‚   â””â”€â”€ routers
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ items.py
â”‚   â”‚   â””â”€â”€ users.py
â”‚   â””â”€â”€ internal
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ admin.py
```

### æç¤º

æœ‰å‡ ä¸ª `__init__.py` æ–‡ä»¶: æ¯ä¸ªç›®å½•æˆ–å­ç›®å½•ä¸­éƒ½æœ‰ä¸€ä¸ªã€‚

è¿™å°±æ˜¯å…è®¸ä»ä¸€ä¸ªæ–‡ä»¶å‘å¦ä¸€ä¸ªæ–‡ä»¶å¯¼å…¥ä»£ç çš„åŸå› ã€‚

ä¾‹å¦‚, åœ¨ `app/main.py` ä¸­, ä½ å¯ä»¥æœ‰åƒè¿™æ ·çš„ä¸€è¡Œ:

```
from app.routers import items
```

- `app` ç›®å½•åŒ…å«æ‰€æœ‰å†…å®¹ã€‚å®ƒæœ‰ä¸€ä¸ªç©ºæ–‡ä»¶ `app/__init__.py`, æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª "Python åŒ…"ï¼ˆ"Python æ¨¡å—" çš„é›†åˆï¼‰: `app`ã€‚
- å®ƒåŒ…å«ä¸€ä¸ª `app/main.py` æ–‡ä»¶ã€‚å› ä¸ºå®ƒåœ¨ Python åŒ…ä¸­ï¼ˆä¸€ä¸ªæœ‰ `__init__.py` æ–‡ä»¶çš„ç›®å½•ï¼‰, æ‰€ä»¥å®ƒæ˜¯è¯¥åŒ…çš„ä¸€ä¸ª "æ¨¡å—": `app.main`ã€‚
- è¿˜æœ‰ä¸€ä¸ª `app/dependencies.py` æ–‡ä»¶, å°±åƒ `app/main.py` ä¸€æ ·, å®ƒæ˜¯ä¸€ä¸ª "æ¨¡å—": `app.dependencies`ã€‚
- è¿˜æœ‰ä¸€ä¸ªå­ç›®å½• `app/routers/`, å¸¦æœ‰å¦ä¸€ä¸ªæ–‡ä»¶ `__init__.py`, æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ª "Python å­åŒ…": `app.routers`ã€‚
- æ–‡ä»¶ `app/routers/items.py` åœ¨ä¸€ä¸ªåŒ… `app/routers/` ä¸­, æ‰€ä»¥å®ƒæ˜¯ä¸€ä¸ªå­æ¨¡å—: `app.routers.items`ã€‚
- `app/routers/users.py` åŒæ ·å¦‚æ­¤, å®ƒæ˜¯å¦ä¸€ä¸ªå­æ¨¡å—: `app.routers.users`ã€‚
- è¿˜æœ‰ä¸€ä¸ªå­ç›®å½• `app/internal/`, å¸¦æœ‰å¦ä¸€ä¸ªæ–‡ä»¶ `__init__.py`, æ‰€ä»¥å®ƒæ˜¯å¦ä¸€ä¸ª "Python å­åŒ…": `app.internal`ã€‚
- æ–‡ä»¶ `app/internal/admin.py` æ˜¯å¦ä¸€ä¸ªå­æ¨¡å—: `app.internal.admin`ã€‚

![Image 1](https://example.com/img/tutorial/bigger-applications/package.drawio.svg)

å¸¦æœ‰æ³¨é‡Šçš„ç›¸åŒæ–‡ä»¶ç»“æ„:

```
.
â”œâ”€â”€ app                  # "app" æ˜¯ä¸€ä¸ª Python åŒ…
â”‚   â”œâ”€â”€ __init__.py      # è¿™ä¸ªæ–‡ä»¶ä½¿ "app" æˆä¸ºä¸€ä¸ª "Python åŒ…"
â”‚   â”œâ”€â”€ main.py          # "main" æ¨¡å—, ä¾‹å¦‚ import app.main
â”‚   â”œâ”€â”€ dependencies.py  # "dependencies" æ¨¡å—, ä¾‹å¦‚ import app.dependencies
â”‚   â””â”€â”€ routers          # "routers" æ˜¯ä¸€ä¸ª "Python å­åŒ…"
â”‚   â”‚   â”œâ”€â”€ __init__.py  # ä½¿ "routers" æˆä¸ºä¸€ä¸ª "Python å­åŒ…"
â”‚   â”‚   â”œâ”€â”€ items.py     # "items" å­æ¨¡å—, ä¾‹å¦‚ import app.routers.items
â”‚   â”‚   â””â”€â”€ users.py     # "users" å­æ¨¡å—, ä¾‹å¦‚ import app.routers.users
â”‚   â””â”€â”€ internal         # "internal" æ˜¯ä¸€ä¸ª "Python å­åŒ…"
â”‚       â”œâ”€â”€ __init__.py  # ä½¿ "internal" æˆä¸ºä¸€ä¸ª "Python å­åŒ…"
â”‚       â””â”€â”€ admin.py     # "admin" å­æ¨¡å—, ä¾‹å¦‚ import app.internal.admin
```

## 2. `APIRouter`

å‡è®¾ä¸“é—¨å¤„ç†ç”¨æˆ·çš„æ–‡ä»¶æ˜¯ä½äº `/app/routers/users.py` çš„å­æ¨¡å—ã€‚

ä½ æƒ³è¦å°†ä¸ä½ ç”¨æˆ·ç›¸å…³çš„ _è·¯å¾„æ“ä½œ_ ä¸å…¶ä½™ä»£ç åˆ†å¼€, ä»¥ä¿æŒç»„ç»‡æœ‰åºã€‚

ä½†å®ƒä»ç„¶æ˜¯åŒä¸€ä¸ª __FastAPI__ åº”ç”¨/web API çš„ä¸€éƒ¨åˆ†ï¼ˆå®ƒæ˜¯åŒä¸€ä¸ª "Python åŒ…" çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚

ä½ å¯ä»¥ä½¿ç”¨ `APIRouter` ä¸ºè¯¥æ¨¡å—åˆ›å»º _è·¯å¾„æ“ä½œ_ã€‚

### 2.1 å¯¼å…¥ `APIRouter`

ä½ å¯¼å…¥å®ƒå¹¶åˆ›å»ºä¸€ä¸ª "å®ä¾‹", å°±åƒä½¿ç”¨ç±» `FastAPI` ä¸€æ ·:

**app/routers/users.py**

```python
# ä» fastapi å¯¼å…¥ APIRouter
# APIRouter ç”¨äºå°†è·¯ç”±ç»„ç»‡åˆ°å•ç‹¬çš„æ–‡ä»¶ä¸­
from fastapi import APIRouter

# åˆ›å»º APIRouter å®ä¾‹
# è¿™ä¸ª router å°†åŒ…å«æ‰€æœ‰ä¸ç”¨æˆ·ç›¸å…³çš„è·¯å¾„æ“ä½œ
router = APIRouter()

# ä½¿ç”¨ @router è£…é¥°å™¨å®šä¹‰è·¯å¾„æ“ä½œ
# è·¯å¾„ä¸º /users/, æ ‡ç­¾ä¸º "users"ï¼ˆç”¨äº API æ–‡æ¡£åˆ†ç»„ï¼‰
@router.get("/users/", tags=["users"])
async def read_users():
    # è¿”å›ç”¨æˆ·åˆ—è¡¨
    return [{"username": "Rick"}, {"username": "Morty"}]

# å®šä¹‰å¦ä¸€ä¸ªç”¨æˆ·ç›¸å…³çš„è·¯å¾„æ“ä½œ
# è·¯å¾„ä¸º /users/me, ç”¨äºè·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
@router.get("/users/me", tags=["users"])
async def read_user_me():
    # è¿”å›å‡å½“å‰ç”¨æˆ·
    return {"username": "fakecurrentuser"}

# å®šä¹‰å¸¦è·¯å¾„å‚æ•°çš„è·¯å¾„æ“ä½œ
# {username} æ˜¯è·¯å¾„å‚æ•°, ä¼šè‡ªåŠ¨ä¼ é€’ç»™å‡½æ•°
@router.get("/users/{username}", tags=["users"])
async def read_user(username: str):
    # è¿”å›è¯·æ±‚çš„ç”¨æˆ·å
    return {"username": username}
```

### 2.2 ä½¿ç”¨ `APIRouter` çš„ _è·¯å¾„æ“ä½œ_

ç„¶åä½ ä½¿ç”¨å®ƒæ¥å£°æ˜ä½ çš„ _è·¯å¾„æ“ä½œ_ã€‚

ä½¿ç”¨å®ƒçš„æ–¹å¼ä¸ä½¿ç”¨ `FastAPI` ç±»çš„æ–¹å¼ç›¸åŒ:

**app/routers/users.py**

```python
from fastapi import APIRouter

# åˆ›å»ºè·¯ç”±å™¨å®ä¾‹
router = APIRouter()

# å®šä¹‰ GET è¯·æ±‚, è·å–æ‰€æœ‰ç”¨æˆ·
@router.get("/users/", tags=["users"])
async def read_users():
    return [{"username": "Rick"}, {"username": "Morty"}]

# å®šä¹‰ GET è¯·æ±‚, è·å–å½“å‰ç”¨æˆ·
@router.get("/users/me", tags=["users"])
async def read_user_me():
    return {"username": "fakecurrentuser"}

# å®šä¹‰ GET è¯·æ±‚, æ ¹æ® username è·å–ç‰¹å®šç”¨æˆ·
@router.get("/users/{username}", tags=["users"])
async def read_user(username: str):
    return {"username": username}
```

ä½ å¯ä»¥å°† `APIRouter` è§†ä¸ºä¸€ä¸ª "è¿·ä½  `FastAPI`" ç±»ã€‚

æ”¯æŒæ‰€æœ‰ç›¸åŒçš„é€‰é¡¹ã€‚

æ‰€æœ‰ç›¸åŒçš„ `parameters`ã€`responses`ã€`dependencies`ã€`tags` ç­‰ã€‚

### æç¤º

åœ¨è¿™ä¸ªä¾‹å­ä¸­, å˜é‡åä¸º `router`, ä½†ä½ å¯ä»¥éšæ„å‘½åã€‚

æˆ‘ä»¬å°†åœ¨ä¸» `FastAPI` åº”ç”¨ä¸­åŒ…å«è¿™ä¸ª `APIRouter`, ä½†é¦–å…ˆ, è®©æˆ‘ä»¬æ£€æŸ¥ä¾èµ–é¡¹å’Œå¦ä¸€ä¸ª `APIRouter`ã€‚

## 3. ä¾èµ–é¡¹

æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å°†åœ¨åº”ç”¨ç¨‹åºçš„å‡ ä¸ªåœ°æ–¹ä½¿ç”¨ä¸€äº›ä¾èµ–é¡¹ã€‚

æ‰€ä»¥æˆ‘ä»¬æŠŠå®ƒä»¬æ”¾åœ¨è‡ªå·±çš„ `dependencies` æ¨¡å—ä¸­ï¼ˆ`app/dependencies.py`ï¼‰ã€‚

ç°åœ¨æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªç®€å•çš„ä¾èµ–é¡¹æ¥è¯»å–è‡ªå®šä¹‰çš„ `X-Token` header:

**Python 3.9+**

**app/dependencies.py**

```python
# ä» typing å¯¼å…¥ Annotated, ç”¨äºç±»å‹æ³¨è§£
from typing import Annotated

# ä» fastapi å¯¼å…¥ Header å’Œ HTTPException
from fastapi import Header, HTTPException

# å®šä¹‰ä¸€ä¸ªä¾èµ–å‡½æ•°, ç”¨äºéªŒè¯ X-Token header
# x_token å‚æ•°ä¼šè‡ªåŠ¨ä»è¯·æ±‚å¤´ä¸­è·å–
async def get_token_header(x_token: Annotated[str, Header()]):
    # æ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆ
    if x_token != "fake-super-secret-token":
        # å¦‚æœ token æ— æ•ˆ, æŠ›å‡º 400 é”™è¯¯
        raise HTTPException(status_code=400, detail="X-Token header invalid")

# å®šä¹‰å¦ä¸€ä¸ªä¾èµ–å‡½æ•°, ç”¨äºéªŒè¯æŸ¥è¯¢å‚æ•°ä¸­çš„ token
async def get_query_token(token: str):
    # æ£€æŸ¥ token æ˜¯å¦ä¸º "jessica"
    if token != "jessica":
        # å¦‚æœä¸æ˜¯ jessica, æŠ›å‡º 400 é”™è¯¯
        raise HTTPException(status_code=400, detail="No Jessica token provided")
```

**Python 3.8+**

**app/dependencies.py**

```python
from fastapi import Header, HTTPException
# Python 3.8 éœ€è¦ä» typing_extensions å¯¼å…¥ Annotated
from typing_extensions import Annotated

async def get_token_header(x_token: Annotated[str, Header()]):
    if x_token != "fake-super-secret-token":
        raise HTTPException(status_code=400, detail="X-Token header invalid")

async def get_query_token(token: str):
    if token != "jessica":
        raise HTTPException(status_code=400, detail="No Jessica token provided")
```

### æç¤º

å°½å¯èƒ½ä½¿ç”¨ `Annotated` ç‰ˆæœ¬ã€‚

**Python 3.8+ non-Annotated**

**app/dependencies.py**

```python
from fastapi import Header, HTTPException

# ä¸ä½¿ç”¨ Annotated çš„ç‰ˆæœ¬
# ä½¿ç”¨é»˜è®¤å€¼æ¥æ ‡è®°è¿™æ˜¯ä¸€ä¸ª header å‚æ•°
async def get_token_header(x_token: str = Header()):
    if x_token != "fake-super-secret-token":
        raise HTTPException(status_code=400, detail="X-Token header invalid")

async def get_query_token(token: str):
    if token != "jessica":
        raise HTTPException(status_code=400, detail="No Jessica token provided")
```

### æç¤º

æˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªè™šæ„çš„ header æ¥ç®€åŒ–è¿™ä¸ªä¾‹å­ã€‚

ä½†åœ¨å®é™…æƒ…å†µä¸‹, ä½¿ç”¨é›†æˆçš„å®‰å…¨å·¥å…·ä¼šè·å¾—æ›´å¥½çš„ç»“æœã€‚

## 4. å¦ä¸€ä¸ªä½¿ç”¨ `APIRouter` çš„æ¨¡å—

å‡è®¾ä½ è¿˜æœ‰ä¸“é—¨ç”¨äºå¤„ç†åº”ç”¨ä¸­ "items" çš„ç«¯ç‚¹, ä½äº `app/routers/items.py` æ¨¡å—ä¸­ã€‚

ä½ æœ‰ä»¥ä¸‹ _è·¯å¾„æ“ä½œ_:

- `/items/`
- `/items/{item_id}`

å®ƒä¸ `app/routers/users.py` çš„ç»“æ„å®Œå…¨ç›¸åŒã€‚

ä½†æˆ‘ä»¬æƒ³æ›´èªæ˜ä¸€ç‚¹, ç®€åŒ–ä»£ç ã€‚

æˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ¨¡å—ä¸­çš„æ‰€æœ‰ _è·¯å¾„æ“ä½œ_ éƒ½æœ‰ç›¸åŒçš„:

- è·¯å¾„ `prefix`: `/items`ã€‚
- `tags`:ï¼ˆåªæœ‰ä¸€ä¸ªæ ‡ç­¾: `items`ï¼‰ã€‚
- é¢å¤–çš„ `responses`ã€‚
- `dependencies`: å®ƒä»¬éƒ½éœ€è¦æˆ‘ä»¬åˆ›å»ºçš„ `X-Token` ä¾èµ–é¡¹ã€‚

å› æ­¤, æˆ‘ä»¬å¯ä»¥å°†è¿™äº›æ·»åŠ åˆ° `APIRouter` ä¸­, è€Œä¸æ˜¯åœ¨æ¯ä¸ª _è·¯å¾„æ“ä½œ_ ä¸­æ·»åŠ æ‰€æœ‰è¿™äº›ã€‚

**app/routers/items.py**

```python
# å¯¼å…¥å¿…è¦çš„ FastAPI ç»„ä»¶
from fastapi import APIRouter, Depends, HTTPException

# ä½¿ç”¨ç›¸å¯¹å¯¼å…¥ä»çˆ¶ç›®å½•çš„ dependencies æ¨¡å—å¯¼å…¥ä¾èµ–å‡½æ•°
# .. è¡¨ç¤ºçˆ¶ç›®å½•ï¼ˆä» app/routers åˆ° appï¼‰
from ..dependencies import get_token_header

# åˆ›å»º APIRouter å®ä¾‹, å¹¶é…ç½®é€šç”¨å‚æ•°
router = APIRouter(
    prefix="/items",  # æ‰€æœ‰è·¯å¾„çš„å‰ç¼€
    tags=["items"],   # ç”¨äºæ–‡æ¡£åˆ†ç»„çš„æ ‡ç­¾
    # æ‰€æœ‰è·¯å¾„æ“ä½œçš„ä¾èµ–é¡¹åˆ—è¡¨
    # Depends() å‘Šè¯‰ FastAPI åœ¨å¤„ç†è¯·æ±‚å‰å…ˆæ‰§è¡Œè¿™ä¸ªä¾èµ–
    dependencies=[Depends(get_token_header)],
    # é¢å¤–çš„å“åº”, é€‚ç”¨äºæ‰€æœ‰è·¯å¾„æ“ä½œ
    responses={404: {"description": "Not found"}},
)

# æ¨¡æ‹Ÿçš„ items æ•°æ®åº“
fake_items_db = {"plumbus": {"name": "Plumbus"}, "gun": {"name": "Portal Gun"}}

# å®šä¹‰ GET è¯·æ±‚, è·å–æ‰€æœ‰ items
# å®é™…è·¯å¾„ä¼šæ˜¯ /items/ (å› ä¸ºæœ‰ prefix)
@router.get("/")
async def read_items():
    return fake_items_db

# å®šä¹‰ GET è¯·æ±‚, æ ¹æ® ID è·å–å•ä¸ª item
# å®é™…è·¯å¾„ä¼šæ˜¯ /items/{item_id}
@router.get("/{item_id}")
async def read_item(item_id: str):
    # æ£€æŸ¥ item æ˜¯å¦å­˜åœ¨
    if item_id not in fake_items_db:
        # ä¸å­˜åœ¨åˆ™æŠ›å‡º 404 é”™è¯¯
        raise HTTPException(status_code=404, detail="Item not found")
    # è¿”å› item çš„åç§°å’Œ ID
    return {"name": fake_items_db[item_id]["name"], "item_id": item_id}

# å®šä¹‰ PUT è¯·æ±‚, æ›´æ–° item
# ä¸ºè¿™ä¸ªç‰¹å®šè·¯å¾„æ·»åŠ é¢å¤–çš„æ ‡ç­¾å’Œå“åº”
@router.put(
    "/{item_id}",
    tags=["custom"],  # é¢å¤–çš„æ ‡ç­¾, ä¼šä¸è·¯ç”±å™¨çš„æ ‡ç­¾åˆå¹¶
    # é¢å¤–çš„å“åº”, ä¼šä¸è·¯ç”±å™¨çš„å“åº”åˆå¹¶
    responses={403: {"description": "Operation forbidden"}},
)
async def update_item(item_id: str):
    # åªå…è®¸æ›´æ–° "plumbus" è¿™ä¸ª item
    if item_id != "plumbus":
        raise HTTPException(
            status_code=403, detail="You can only update the item: plumbus"
        )
    # è¿”å›æ›´æ–°åçš„ item
    return {"item_id": item_id, "name": "The great Plumbus"}
```

ç”±äºæ¯ä¸ª _è·¯å¾„æ“ä½œ_ çš„è·¯å¾„å¿…é¡»ä»¥ `/` å¼€å¤´, å°±åƒè¿™æ ·:

```python
@router.get("/{item_id}")
async def read_item(item_id: str):
    ...
```

...æ‰€ä»¥å‰ç¼€ä¸èƒ½åŒ…å«æœ€åçš„ `/`ã€‚

å› æ­¤, åœ¨è¿™ç§æƒ…å†µä¸‹, å‰ç¼€æ˜¯ `/items`ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ ä¸€ä¸ª `tags` åˆ—è¡¨å’Œé¢å¤–çš„ `responses`, å®ƒä»¬å°†åº”ç”¨äºæ­¤è·¯ç”±å™¨ä¸­åŒ…å«çš„æ‰€æœ‰ _è·¯å¾„æ“ä½œ_ã€‚

æˆ‘ä»¬è¿˜å¯ä»¥æ·»åŠ ä¸€ä¸ª `dependencies` åˆ—è¡¨, å®ƒå°†æ·»åŠ åˆ°è·¯ç”±å™¨ä¸­çš„æ‰€æœ‰ _è·¯å¾„æ“ä½œ_ ä¸­, å¹¶å°†åœ¨å¯¹å®ƒä»¬å‘å‡ºçš„æ¯ä¸ªè¯·æ±‚æ—¶æ‰§è¡Œ/è§£å†³ã€‚

æœ€ç»ˆç»“æœæ˜¯ item è·¯å¾„ç°åœ¨æ˜¯:

- `/items/`
- `/items/{item_id}`

...æ­£å¦‚æˆ‘ä»¬é¢„æœŸçš„ã€‚

- å®ƒä»¬å°†è¢«æ ‡è®°ä¸ºåŒ…å«å•ä¸ªå­—ç¬¦ä¸² `"items"` çš„æ ‡ç­¾åˆ—è¡¨ã€‚
  - è¿™äº› "æ ‡ç­¾" å¯¹äºè‡ªåŠ¨äº¤äº’å¼æ–‡æ¡£ç³»ç»Ÿï¼ˆä½¿ç”¨ OpenAPIï¼‰ç‰¹åˆ«æœ‰ç”¨ã€‚
- å®ƒä»¬éƒ½å°†åŒ…æ‹¬é¢„å®šä¹‰çš„ `responses`ã€‚
- æ‰€æœ‰è¿™äº› _è·¯å¾„æ“ä½œ_ éƒ½å°†åœ¨å®ƒä»¬ä¹‹å‰æ‰§è¡Œ/è¯„ä¼°ä¾èµ–é¡¹åˆ—è¡¨ã€‚
  - å¦‚æœä½ è¿˜åœ¨ç‰¹å®šçš„ _è·¯å¾„æ“ä½œ_ ä¸­å£°æ˜ä¾èµ–é¡¹, __å®ƒä»¬ä¹Ÿä¼šè¢«æ‰§è¡Œ__ã€‚
  - è·¯ç”±å™¨ä¾èµ–é¡¹é¦–å…ˆæ‰§è¡Œ, ç„¶åæ˜¯è£…é¥°å™¨ä¸­çš„ `dependencies`, ç„¶åæ˜¯æ™®é€šå‚æ•°ä¾èµ–é¡¹ã€‚
  - ä½ è¿˜å¯ä»¥æ·»åŠ å¸¦æœ‰ `scopes` çš„ `Security` ä¾èµ–é¡¹ã€‚

### æç¤º

åœ¨ `APIRouter` ä¸­æ‹¥æœ‰ `dependencies` å¯ä»¥ç”¨äº, ä¾‹å¦‚, è¦æ±‚å¯¹æ•´ç»„ _è·¯å¾„æ“ä½œ_ è¿›è¡Œèº«ä»½éªŒè¯ã€‚å³ä½¿æ²¡æœ‰å•ç‹¬ä¸ºæ¯ä¸ªè·¯å¾„æ“ä½œæ·»åŠ ä¾èµ–é¡¹ã€‚

`prefix`ã€`tags`ã€`responses` å’Œ `dependencies` å‚æ•°ï¼ˆåœ¨è®¸å¤šå…¶ä»–æƒ…å†µä¸‹ä¸€æ ·ï¼‰åªæ˜¯ __FastAPI__ çš„ä¸€é¡¹åŠŸèƒ½, ç”¨äºå¸®åŠ©ä½ é¿å…ä»£ç é‡å¤ã€‚

### 4.1 å¯¼å…¥ä¾èµ–é¡¹

è¿™æ®µä»£ç ä½äºæ¨¡å— `app.routers.items` ä¸­, å³æ–‡ä»¶ `app/routers/items.py`ã€‚

æˆ‘ä»¬éœ€è¦ä»æ¨¡å— `app.dependencies`ï¼ˆæ–‡ä»¶ `app/dependencies.py`ï¼‰ä¸­è·å–ä¾èµ–å‡½æ•°ã€‚

æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ `..` çš„ç›¸å¯¹å¯¼å…¥æ¥å¯¼å…¥ä¾èµ–é¡¹:

**app/routers/items.py**

```python
from fastapi import APIRouter, Depends, HTTPException

# ä½¿ç”¨ä¸¤ä¸ªç‚¹ (..) è¿›è¡Œç›¸å¯¹å¯¼å…¥
# .. è¡¨ç¤ºçˆ¶ç›®å½•, æ‰€ä»¥ ..dependencies æŒ‡å‘ app/dependencies.py
from ..dependencies import get_token_header

router = APIRouter(
    prefix="/items",
    tags=["items"],
    dependencies=[Depends(get_token_header)],
    responses={404: {"description": "Not found"}},
)

fake_items_db = {"plumbus": {"name": "Plumbus"}, "gun": {"name": "Portal Gun"}}

@router.get("/")
async def read_items():
    return fake_items_db

@router.get("/{item_id}")
async def read_item(item_id: str):
    if item_id not in fake_items_db:
        raise HTTPException(status_code=404, detail="Item not found")
    return {"name": fake_items_db[item_id]["name"], "item_id": item_id}

@router.put(
    "/{item_id}",
    tags=["custom"],
    responses={403: {"description": "Operation forbidden"}},
)
async def update_item(item_id: str):
    if item_id != "plumbus":
        raise HTTPException(
            status_code=403, detail="You can only update the item: plumbus"
        )
    return {"item_id": item_id, "name": "The great Plumbus"}
```

#### ç›¸å¯¹å¯¼å…¥çš„å·¥ä½œåŸç†

### æç¤º

å¦‚æœä½ å®Œå…¨äº†è§£å¯¼å…¥çš„å·¥ä½œåŸç†, è¯·ç»§ç»­é˜…è¯»ä¸‹é¢çš„ä¸‹ä¸€èŠ‚ã€‚

ä¸€ä¸ªç‚¹ `.`, å°±åƒè¿™æ ·:

```
from .dependencies import get_token_header
```

æ„å‘³ç€:

- ä»æ­¤æ¨¡å—ï¼ˆæ–‡ä»¶ `app/routers/items.py`ï¼‰æ‰€åœ¨çš„åŒä¸€åŒ…ï¼ˆç›®å½• `app/routers/`ï¼‰å¼€å§‹...
- æ‰¾åˆ°æ¨¡å— `dependencies`ï¼ˆä¸€ä¸ªä½äº `app/routers/dependencies.py` çš„è™šæ„æ–‡ä»¶ï¼‰...
- ç„¶åä»ä¸­å¯¼å…¥å‡½æ•° `get_token_header`ã€‚

ä½†æ˜¯é‚£ä¸ªæ–‡ä»¶ä¸å­˜åœ¨, æˆ‘ä»¬çš„ä¾èµ–é¡¹ä½äº `app/dependencies.py` æ–‡ä»¶ä¸­ã€‚

è¿˜è®°å¾—æˆ‘ä»¬çš„åº”ç”¨/æ–‡ä»¶ç»“æ„æ˜¯ä»€ä¹ˆæ ·å­çš„:

![Image 2](https://example.com/img/tutorial/bigger-applications/package.drawio.svg)

---

ä¸¤ä¸ªç‚¹ `..`, å°±åƒè¿™æ ·:

```
from ..dependencies import get_token_header
```

æ„å‘³ç€:

- ä»æ­¤æ¨¡å—ï¼ˆæ–‡ä»¶ `app/routers/items.py`ï¼‰æ‰€åœ¨çš„åŒä¸€åŒ…ï¼ˆç›®å½• `app/routers/`ï¼‰å¼€å§‹...
- è½¬åˆ°çˆ¶åŒ…ï¼ˆç›®å½• `app/`ï¼‰...
- ç„¶ååœ¨é‚£é‡Œæ‰¾åˆ°æ¨¡å— `dependencies`ï¼ˆä½äº `app/dependencies.py` çš„æ–‡ä»¶ï¼‰...
- ç„¶åä»ä¸­å¯¼å…¥å‡½æ•° `get_token_header`ã€‚

è¿™å¯ä»¥æ­£å¸¸å·¥ä½œï¼ğŸ‰

---

åŒæ ·, å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº†ä¸‰ä¸ªç‚¹ `...`, å°±åƒè¿™æ ·:

```
from ...dependencies import get_token_header
```

é‚£å°†æ„å‘³ç€:

- ä»æ­¤æ¨¡å—ï¼ˆæ–‡ä»¶ `app/routers/items.py`ï¼‰æ‰€åœ¨çš„åŒä¸€åŒ…ï¼ˆç›®å½• `app/routers/`ï¼‰å¼€å§‹...
- è½¬åˆ°çˆ¶åŒ…ï¼ˆç›®å½• `app/`ï¼‰...
- ç„¶åè½¬åˆ°è¯¥åŒ…çš„çˆ¶çº§ï¼ˆæ²¡æœ‰çˆ¶åŒ…, `app` æ˜¯é¡¶çº§ ğŸ˜±ï¼‰...
- ç„¶ååœ¨é‚£é‡Œæ‰¾åˆ°æ¨¡å— `dependencies`ï¼ˆä½äº `app/dependencies.py` çš„æ–‡ä»¶ï¼‰...
- ç„¶åä»ä¸­å¯¼å…¥å‡½æ•° `get_token_header`ã€‚

é‚£å°†å¼•ç”¨ `app/` ä¹‹ä¸Šçš„æŸä¸ªåŒ…, å®ƒæœ‰è‡ªå·±çš„ `__init__.py` æ–‡ä»¶ç­‰ã€‚ä½†æˆ‘ä»¬æ²¡æœ‰é‚£ä¸ªã€‚æ‰€ä»¥, åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­è¿™ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚ğŸš¨

ä½†ç°åœ¨ä½ çŸ¥é“å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„, æ‰€ä»¥æ— è®ºå®ƒæœ‰å¤šå¤æ‚, ä½ éƒ½å¯ä»¥åœ¨è‡ªå·±çš„åº”ç”¨ä¸­ä½¿ç”¨ç›¸å¯¹å¯¼å…¥ã€‚ğŸ¤“

### 4.2 æ·»åŠ ä¸€äº›è‡ªå®šä¹‰çš„ `tags`ã€`responses` å’Œ `dependencies`

æˆ‘ä»¬æ²¡æœ‰å°†å‰ç¼€ `/items` æˆ– `tags=["items"]` æ·»åŠ åˆ°æ¯ä¸ª _è·¯å¾„æ“ä½œ_, å› ä¸ºæˆ‘ä»¬å·²å°†å®ƒä»¬æ·»åŠ åˆ° `APIRouter` ä¸­ã€‚

ä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥æ·»åŠ å°†åº”ç”¨äºç‰¹å®š _è·¯å¾„æ“ä½œ_ çš„ _æ›´å¤š_ `tags`, ä»¥åŠä¸€äº›ç‰¹å®šäºè¯¥ _è·¯å¾„æ“ä½œ_ çš„é¢å¤– `responses`:

**app/routers/items.py**

```python
from fastapi import APIRouter, Depends, HTTPException

from ..dependencies import get_token_header

router = APIRouter(
    prefix="/items",
    tags=["items"],
    dependencies=[Depends(get_token_header)],
    responses={404: {"description": "Not found"}},
)

fake_items_db = {"plumbus": {"name": "Plumbus"}, "gun": {"name": "Portal Gun"}}

@router.get("/")
async def read_items():
    return fake_items_db

@router.get("/{item_id}")
async def read_item(item_id: str):
    if item_id not in fake_items_db:
        raise HTTPException(status_code=404, detail="Item not found")
    return {"name": fake_items_db[item_id]["name"], "item_id": item_id}

# ä¸ºè¿™ä¸ªç‰¹å®šè·¯å¾„æ·»åŠ é¢å¤–çš„æ ‡ç­¾å’Œå“åº”
@router.put(
    "/{item_id}",
    tags=["custom"],  # è¿™ä¸ªæ ‡ç­¾ä¼šä¸è·¯ç”±å™¨çš„ ["items"] åˆå¹¶æˆ ["items", "custom"]
    responses={403: {"description": "Operation forbidden"}},  # è¿™ä¸ªå“åº”ä¼šä¸è·¯ç”±å™¨çš„ 404 å“åº”åˆå¹¶
)
async def update_item(item_id: str):
    if item_id != "plumbus":
        raise HTTPException(
            status_code=403, detail="You can only update the item: plumbus"
        )
    return {"item_id": item_id, "name": "The great Plumbus"}
```

### æç¤º

æœ€åä¸€ä¸ªè·¯å¾„æ“ä½œå°†å…·æœ‰æ ‡ç­¾çš„ç»„åˆ: `["items", "custom"]`ã€‚

å®ƒè¿˜å°†åœ¨æ–‡æ¡£ä¸­åŒ…å«ä¸¤ä¸ªå“åº”, ä¸€ä¸ªç”¨äº `404`, ä¸€ä¸ªç”¨äº `403`ã€‚

## 5. ä¸» `FastAPI`

ç°åœ¨, è®©æˆ‘ä»¬çœ‹çœ‹ä½äº `app/main.py` çš„æ¨¡å—ã€‚

åœ¨è¿™é‡Œä½ å¯¼å…¥å’Œä½¿ç”¨ç±» `FastAPI`ã€‚

è¿™å°†æ˜¯ä½ åº”ç”¨ç¨‹åºä¸­æŠŠæ‰€æœ‰å†…å®¹è”ç³»åœ¨ä¸€èµ·çš„ä¸»æ–‡ä»¶ã€‚

ç”±äºä½ çš„å¤§éƒ¨åˆ†é€»è¾‘ç°åœ¨éƒ½ä½äºå…¶è‡ªå·±çš„ç‰¹å®šæ¨¡å—ä¸­, ä¸»æ–‡ä»¶å°†éå¸¸ç®€å•ã€‚

### 5.1 å¯¼å…¥ `FastAPI`

ä½ å¯ä»¥åƒå¾€å¸¸ä¸€æ ·å¯¼å…¥å’Œåˆ›å»ºä¸€ä¸ª `FastAPI` ç±»ã€‚

æˆ‘ä»¬ç”šè‡³å¯ä»¥å£°æ˜å°†ä¸æ¯ä¸ª `APIRouter` çš„ä¾èµ–é¡¹ç»„åˆçš„å…¨å±€ä¾èµ–é¡¹:

**app/main.py**

```python
# å¯¼å…¥ FastAPI ç›¸å…³ç»„ä»¶
from fastapi import Depends, FastAPI

# ä½¿ç”¨ç›¸å¯¹å¯¼å…¥ä»åŒä¸€åŒ…çš„å­æ¨¡å—ä¸­å¯¼å…¥
# .dependencies è¡¨ç¤ºå½“å‰åŒ…çš„ dependencies æ¨¡å—
from .dependencies import get_query_token, get_token_header
# .internal è¡¨ç¤º internal å­åŒ…
from .internal import admin
# .routers è¡¨ç¤º routers å­åŒ…
from .routers import items, users

# åˆ›å»º FastAPI åº”ç”¨å®ä¾‹
# dependencies å‚æ•°æŒ‡å®šå…¨å±€ä¾èµ–é¡¹, ä¼šåº”ç”¨äºæ‰€æœ‰è·¯å¾„æ“ä½œ
app = FastAPI(dependencies=[Depends(get_query_token)])

# å°† users è·¯ç”±å™¨åŒ…å«åˆ°ä¸»åº”ç”¨ä¸­
# users.router æ˜¯åœ¨ app/routers/users.py ä¸­å®šä¹‰çš„ APIRouter å®ä¾‹
app.include_router(users.router)

# å°† items è·¯ç”±å™¨åŒ…å«åˆ°ä¸»åº”ç”¨ä¸­
# items.router æ˜¯åœ¨ app/routers/items.py ä¸­å®šä¹‰çš„ APIRouter å®ä¾‹
app.include_router(items.router)

# å°† admin è·¯ç”±å™¨åŒ…å«åˆ°ä¸»åº”ç”¨ä¸­, å¹¶è¦†ç›–ä¸€äº›å‚æ•°
# prefix ä¼šæ·»åŠ åˆ°æ‰€æœ‰è·¯å¾„å‰
# tags ä¼šæ·»åŠ åˆ°æ‰€æœ‰è·¯å¾„æ“ä½œ
# dependencies ä¼šæ·»åŠ é¢å¤–çš„ä¾èµ–é¡¹
# responses ä¼šæ·»åŠ é¢å¤–çš„å“åº”
app.include_router(
    admin.router,
    prefix="/admin",  # ä¸ºè¿™ä¸ªè·¯ç”±å™¨è®¾ç½®è‡ªå®šä¹‰å‰ç¼€
    tags=["admin"],   # ä¸ºè¿™ä¸ªè·¯ç”±å™¨è®¾ç½®æ ‡ç­¾
    # ä¸ºè¿™ä¸ªè·¯ç”±å™¨ä¸­çš„æ‰€æœ‰è·¯å¾„æ·»åŠ ä¾èµ–é¡¹
    dependencies=[Depends(get_token_header)],
    # ä¸ºè¿™ä¸ªè·¯ç”±å™¨æ·»åŠ é¢å¤–çš„å“åº”
    # 418 æ˜¯ I'm a teapot çš„ HTTP çŠ¶æ€ç ï¼ˆä¸€ä¸ªç©ç¬‘ï¼‰
    responses={418: {"description": "I'm a teapot"}},
)

# åœ¨ä¸»åº”ç”¨ä¸­ç›´æ¥å®šä¹‰ä¸€ä¸ªè·¯å¾„æ“ä½œ
# è¿™ä¸ªè·¯å¾„ä½äºæ ¹è·¯å¾„ /
@app.get("/")
async def root():
    return {"message": "Hello Bigger Applications!"}
```

### 5.2 å¯¼å…¥ `APIRouter`

ç°åœ¨æˆ‘ä»¬å¯¼å…¥å…¶ä»–å…·æœ‰ `APIRouter` çš„å­æ¨¡å—:

**app/main.py**

```python
from fastapi import Depends, FastAPI

# ä»åŒä¸€åŒ…ï¼ˆappï¼‰çš„ä¸åŒå­æ¨¡å—å¯¼å…¥
# . è¡¨ç¤ºå½“å‰åŒ…ï¼ˆappï¼‰
# .dependencies æŒ‡å‘ app/dependencies.py
from .dependencies import get_query_token, get_token_header
# .internal æŒ‡å‘ app/internal/ åŒ…
from .internal import admin
# .routers æŒ‡å‘ app/routers/ åŒ…
from .routers import items, users

app = FastAPI(dependencies=[Depends(get_query_token)])

app.include_router(users.router)
app.include_router(items.router)
app.include_router(
    admin.router,
    prefix="/admin",
    tags=["admin"],
    dependencies=[Depends(get_token_header)],
    responses={418: {"description": "I'm a teapot"}},
)

@app.get("/")
async def root():
    return {"message": "Hello Bigger Applications!"}
```

ç”±äºæ–‡ä»¶ `app/routers/users.py` å’Œ `app/routers/items.py` æ˜¯å±äºåŒä¸€ Python åŒ… `app` çš„å­æ¨¡å—, æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ªç‚¹ `.` é€šè¿‡ "ç›¸å¯¹å¯¼å…¥" æ¥å¯¼å…¥å®ƒä»¬ã€‚

### 5.3 å¯¼å…¥çš„å·¥ä½œåŸç†

è¿™ä¸€éƒ¨åˆ†:

```python
from .routers import items, users
```

æ„å‘³ç€:

- ä»æ­¤æ¨¡å—ï¼ˆæ–‡ä»¶ `app/main.py`ï¼‰æ‰€åœ¨çš„åŒä¸€åŒ…ï¼ˆç›®å½• `app/`ï¼‰å¼€å§‹...
- æŸ¥æ‰¾å­åŒ… `routers`ï¼ˆä½äº `app/routers/` çš„ç›®å½•ï¼‰...
- ç„¶åä»ä¸­å¯¼å…¥å­æ¨¡å— `items`ï¼ˆä½äº `app/routers/items.py` çš„æ–‡ä»¶ï¼‰å’Œ `users`ï¼ˆä½äº `app/routers/users.py` çš„æ–‡ä»¶ï¼‰...

æ¨¡å— `items` å°†æœ‰ä¸€ä¸ªå˜é‡ `router`ï¼ˆ`items.router`ï¼‰ã€‚è¿™ä¸æˆ‘ä»¬åœ¨æ–‡ä»¶ `app/routers/items.py` ä¸­åˆ›å»ºçš„ç›¸åŒ, å®ƒæ˜¯ä¸€ä¸ª `APIRouter` å¯¹è±¡ã€‚

ç„¶åæˆ‘ä»¬å¯¹æ¨¡å— `users` åšåŒæ ·çš„äº‹æƒ…ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥åƒè¿™æ ·å¯¼å…¥å®ƒä»¬:

```python
from app.routers import items, users
```

### æç¤º

ç¬¬ä¸€ä¸ªç‰ˆæœ¬æ˜¯ "ç›¸å¯¹å¯¼å…¥":

```python
from .routers import items, users
```

ç¬¬äºŒä¸ªç‰ˆæœ¬æ˜¯ "ç»å¯¹å¯¼å…¥":

```python
from app.routers import items, users
```

è¦äº†è§£æ›´å¤šå…³äº Python åŒ…å’Œæ¨¡å—çš„ä¿¡æ¯, è¯·é˜…è¯»å…³äºæ¨¡å—çš„å®˜æ–¹ Python æ–‡æ¡£ã€‚

### 5.4 é¿å…åç§°å†²çª

æˆ‘ä»¬ç›´æ¥å¯¼å…¥å­æ¨¡å— `items`, è€Œä¸æ˜¯åªå¯¼å…¥å…¶å˜é‡ `router`ã€‚

è¿™æ˜¯å› ä¸ºåœ¨å­æ¨¡å— `users` ä¸­æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªåä¸º `router` çš„å˜é‡ã€‚

å¦‚æœæˆ‘ä»¬ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°å¯¼å…¥å®ƒä»¬, å°±åƒè¿™æ ·:

```python
from .routers.items import router
from .routers.users import router
```

`users` ä¸­çš„ `router` ä¼šè¦†ç›– `items` ä¸­çš„ `router`, æˆ‘ä»¬å°†æ— æ³•åŒæ—¶ä½¿ç”¨å®ƒä»¬ã€‚

æ‰€ä»¥, ä¸ºäº†èƒ½å¤Ÿåœ¨åŒä¸€æ–‡ä»¶ä¸­ä½¿ç”¨å®ƒä»¬, æˆ‘ä»¬ç›´æ¥å¯¼å…¥å­æ¨¡å—:

**app/main.py**

```python
from fastapi import Depends, FastAPI

from .dependencies import get_query_token, get_token_header
from .internal import admin
# å¯¼å…¥æ•´ä¸ªå­æ¨¡å—, è€Œä¸æ˜¯ç›´æ¥å¯¼å…¥ router å˜é‡
# è¿™æ ·å¯ä»¥é¿å…åç§°å†²çª, å› ä¸ºä¸¤ä¸ªæ¨¡å—éƒ½æœ‰ router å˜é‡
from .routers import items, users

app = FastAPI(dependencies=[Depends(get_query_token)])

# ä½¿ç”¨ items.router è®¿é—® items æ¨¡å—çš„ router
app.include_router(items.router)
# ä½¿ç”¨ users.router è®¿é—® users æ¨¡å—çš„ router
app.include_router(users.router)
app.include_router(
    admin.router,
    prefix="/admin",
    tags=["admin"],
    dependencies=[Depends(get_token_header)],
    responses={418: {"description": "I'm a teapot"}},
)

@app.get("/")
async def root():
    return {"message": "Hello Bigger Applications!"}
```

### 5.5 åŒ…å« `users` å’Œ `items` çš„ `APIRouter`

ç°åœ¨, è®©æˆ‘ä»¬åŒ…å«æ¥è‡ªå­æ¨¡å— `users` å’Œ `items` çš„ `router`:

**app/main.py**

```python
from fastapi import Depends, FastAPI

from .dependencies import get_query_token, get_token_header
from .internal import admin
from .routers import items, users

app = FastAPI(dependencies=[Depends(get_query_token)])

# å°† users è·¯ç”±å™¨åŒ…å«åˆ°ä¸»åº”ç”¨
app.include_router(users.router)
# å°† items è·¯ç”±å™¨åŒ…å«åˆ°ä¸»åº”ç”¨
app.include_router(items.router)
app.include_router(
    admin.router,
    prefix="/admin",
    tags=["admin"],
    dependencies=[Depends(get_token_header)],
    responses={418: {"description": "I'm a teapot"}},
)

@app.get("/")
async def root():
    return {"message": "Hello Bigger Applications!"}
```

### æç¤º

`users.router` åŒ…å«æ–‡ä»¶ `app/routers/users.py` ä¸­çš„ `APIRouter`ã€‚

`items.router` åŒ…å«æ–‡ä»¶ `app/routers/items.py` ä¸­çš„ `APIRouter`ã€‚

ä½¿ç”¨ `app.include_router()`, æˆ‘ä»¬å¯ä»¥å°†æ¯ä¸ª `APIRouter` æ·»åŠ åˆ°ä¸» `FastAPI` åº”ç”¨ç¨‹åºä¸­ã€‚

å®ƒå°†æŠŠè¯¥è·¯ç”±å™¨çš„æ‰€æœ‰è·¯ç”±ä½œä¸ºå…¶ä¸€éƒ¨åˆ†åŒ…å«åœ¨å†…ã€‚

### æŠ€æœ¯ç»†èŠ‚

å®ƒå®é™…ä¸Šä¼šåœ¨å†…éƒ¨ä¸º `APIRouter` ä¸­å£°æ˜çš„æ¯ä¸ª _è·¯å¾„æ“ä½œ_ åˆ›å»ºä¸€ä¸ª _è·¯å¾„æ“ä½œ_ã€‚

å› æ­¤, åœ¨å¹•å, å®ƒå®é™…ä¸Šå°±åƒä¸€åˆ‡éƒ½æ˜¯åŒä¸€ä¸ªåº”ç”¨ä¸€æ ·å·¥ä½œã€‚

### æç¤º

ä½ ä¸å¿…æ‹…å¿ƒåŒ…å«è·¯ç”±å™¨æ—¶çš„æ€§èƒ½é—®é¢˜ã€‚

è¿™å°†åªéœ€è¦å¾®ç§’çº§çš„æ—¶é—´, å¹¶ä¸”åªä¼šåœ¨å¯åŠ¨æ—¶å‘ç”Ÿã€‚

æ‰€ä»¥å®ƒä¸ä¼šå½±å“æ€§èƒ½ã€‚âš¡

### 5.6 åŒ…å«å¸¦æœ‰è‡ªå®šä¹‰ `prefix`ã€`tags`ã€`responses` å’Œ `dependencies` çš„ `APIRouter`

ç°åœ¨, å‡è®¾ä½ çš„ç»„ç»‡ç»™äº†ä½  `app/internal/admin.py` æ–‡ä»¶ã€‚

å®ƒåŒ…å«ä¸€ä¸ª `APIRouter`, å…¶ä¸­åŒ…å«ä¸€äº›ç®¡ç†å‘˜ _è·¯å¾„æ“ä½œ_, ä½ çš„ç»„ç»‡åœ¨å‡ ä¸ªé¡¹ç›®ä¹‹é—´å…±äº«è¿™äº›æ“ä½œã€‚

å¯¹äºè¿™ä¸ªä¾‹å­, å®ƒå°†éå¸¸ç®€å•ã€‚ä½†æ˜¯, å‡è®¾ç”±äºå®ƒä¸ç»„ç»‡ä¸­çš„å…¶ä»–é¡¹ç›®å…±äº«, æˆ‘ä»¬æ— æ³•ä¿®æ”¹å®ƒå¹¶ç›´æ¥å‘ `APIRouter` æ·»åŠ  `prefix`ã€`dependencies`ã€`tags` ç­‰:

**app/internal/admin.py**

```python
from fastapi import APIRouter

# åˆ›å»ºä¸€ä¸ªç®€å•çš„ APIRouter
# è¿™ä¸ªè·¯ç”±å™¨å¯èƒ½åœ¨å¤šä¸ªé¡¹ç›®ä¹‹é—´å…±äº«
# æ‰€ä»¥æˆ‘ä»¬ä¸åœ¨åˆ›å»ºæ—¶æ·»åŠ ä»»ä½•é…ç½®
router = APIRouter()

# å®šä¹‰ä¸€ä¸ªç®¡ç†å‘˜è·¯å¾„æ“ä½œ
@router.post("/")
async def update_admin():
    return {"message": "Admin getting schwifty"}
```

ä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¸Œæœ›åœ¨åŒ…å« `APIRouter` æ—¶è®¾ç½®ä¸€ä¸ªè‡ªå®šä¹‰çš„ `prefix`, ä»¥ä¾¿å®ƒçš„æ‰€æœ‰ _è·¯å¾„æ“ä½œ_ éƒ½ä»¥ `/admin` å¼€å¤´, æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨æˆ‘ä»¬ä¸ºæ­¤é¡¹ç›®å·²æœ‰çš„ `dependencies` æ¥ä¿æŠ¤å®ƒ, å¹¶ä¸”æˆ‘ä»¬æƒ³è¦åŒ…å« `tags` å’Œ `responses`ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†é‚£äº›å‚æ•°ä¼ é€’ç»™ `app.include_router()` æ¥å£°æ˜æ‰€æœ‰è¿™äº›, è€Œä¸å¿…ä¿®æ”¹åŸå§‹çš„ `APIRouter`:

**app/main.py**

```python
from fastapi import Depends, FastAPI

from .dependencies import get_query_token, get_token_header
from .internal import admin
from .routers import items, users

app = FastAPI(dependencies=[Depends(get_query_token)])

app.include_router(users.router)
app.include_router(items.router)
# åŒ…å« admin è·¯ç”±å™¨æ—¶è¦†ç›–é…ç½®
# è¿™æ ·ä¸ä¼šä¿®æ”¹åŸå§‹çš„ admin.py æ–‡ä»¶
# åªæ˜¯åœ¨æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨ä¸åŒçš„é…ç½®
app.include_router(
    admin.router,  # åŸå§‹çš„ routerï¼ˆæ²¡æœ‰é…ç½®ï¼‰
    # åœ¨è¿™é‡Œä¸ºæˆ‘ä»¬çš„é¡¹ç›®æ·»åŠ è‡ªå®šä¹‰é…ç½®
    prefix="/admin",  # æ‰€æœ‰è·¯å¾„éƒ½ä¼šåŠ ä¸Š /admin å‰ç¼€
    tags=["admin"],   # åœ¨æ–‡æ¡£ä¸­åˆ†ç»„ä¸º "admin"
    # ä¸ºæ‰€æœ‰ç®¡ç†å‘˜è·¯å¾„æ·»åŠ èº«ä»½éªŒè¯ä¾èµ–
    dependencies=[Depends(get_token_header)],
    # æ·»åŠ é¢å¤–çš„å“åº”
    responses={418: {"description": "I'm a teapot"}},
)

@app.get("/")
async def root():
    return {"message": "Hello Bigger Applications!"}
```

è¿™æ ·, åŸå§‹çš„ `APIRouter` å°†ä¿æŒä¸å˜, æ‰€ä»¥æˆ‘ä»¬ä»ç„¶å¯ä»¥ä¸ç»„ç»‡ä¸­çš„å…¶ä»–é¡¹ç›®å…±äº«åŒä¸€ä¸ª `app/internal/admin.py` æ–‡ä»¶ã€‚

ç»“æœæ˜¯åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­, `admin` æ¨¡å—çš„æ¯ä¸ª _è·¯å¾„æ“ä½œ_ éƒ½ä¼šæœ‰:

- å‰ç¼€ `/admin`ã€‚
- æ ‡ç­¾ `admin`ã€‚
- ä¾èµ–é¡¹ `get_token_header`ã€‚
- å“åº” `418`ã€‚ğŸµ

ä½†è¿™åªä¼šå½±å“æˆ‘ä»¬åº”ç”¨ä¸­çš„é‚£ä¸ª `APIRouter`, è€Œä¸ä¼šå½±å“ä½¿ç”¨å®ƒçš„ä»»ä½•å…¶ä»–ä»£ç ã€‚

å› æ­¤, ä¾‹å¦‚, å…¶ä»–é¡¹ç›®å¯ä»¥ä½¿ç”¨å¸¦æœ‰ä¸åŒèº«ä»½éªŒè¯æ–¹æ³•çš„åŒä¸€ä¸ª `APIRouter`ã€‚

### 5.7 åŒ…å«ä¸€ä¸ª _è·¯å¾„æ“ä½œ_

æˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥å‘ `FastAPI` åº”ç”¨æ·»åŠ  _è·¯å¾„æ“ä½œ_ã€‚

æˆ‘ä»¬åœ¨è¿™é‡Œè¿™æ ·åš...åªæ˜¯ä¸ºäº†è¡¨æ˜æˆ‘ä»¬å¯ä»¥ ğŸ¤·:

**app/main.py**

```python
from fastapi import Depends, FastAPI

from .dependencies import get_query_token, get_token_header
from .internal import admin
from .routers import items, users

app = FastAPI(dependencies=[Depends(get_query_token)])

app.include_router(users.router)
app.include_router(items.router)
app.include_router(
    admin.router,
    prefix="/admin",
    tags=["admin"],
    dependencies=[Depends(get_token_header)],
    responses={418: {"description": "I'm a teapot"}},
)

# å¯ä»¥åœ¨ä¸»åº”ç”¨ä¸­ç›´æ¥å®šä¹‰è·¯å¾„æ“ä½œ
# è¿™ä¸é€šè¿‡ include_router æ·»åŠ çš„è·¯å¾„æ“ä½œå®Œå…¨å…¼å®¹
@app.get("/")
async def root():
    return {"message": "Hello Bigger Applications!"}
```

å®ƒå°†ä¸ä½¿ç”¨ `app.include_router()` æ·»åŠ çš„æ‰€æœ‰å…¶ä»– _è·¯å¾„æ“ä½œ_ ä¸€èµ·æ­£å¸¸å·¥ä½œã€‚

### éå¸¸æŠ€æœ¯æ€§çš„ç»†èŠ‚

__æ³¨æ„__: è¿™æ˜¯ä¸€ä¸ªéå¸¸æŠ€æœ¯æ€§çš„ç»†èŠ‚, ä½ å¯èƒ½å¯ä»¥ __ç›´æ¥è·³è¿‡__ã€‚

---

`APIRouter` æ²¡æœ‰è¢« "æŒ‚è½½", å®ƒä»¬å¹¶æ²¡æœ‰ä¸åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†éš”ç¦»ã€‚

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æƒ³è¦åœ¨ OpenAPI æ¨¡å¼å’Œç”¨æˆ·ç•Œé¢ä¸­åŒ…å«å®ƒä»¬çš„ _è·¯å¾„æ“ä½œ_ã€‚

ç”±äºæˆ‘ä»¬ä¸èƒ½åªæ˜¯å°†å®ƒä»¬éš”ç¦»å¹¶ç‹¬ç«‹äºå…¶ä½™éƒ¨åˆ† "æŒ‚è½½" å®ƒä»¬, _è·¯å¾„æ“ä½œ_ è¢« "å…‹éš†"ï¼ˆé‡æ–°åˆ›å»ºï¼‰, è€Œä¸æ˜¯ç›´æ¥åŒ…å«ã€‚

## 6. æ£€æŸ¥è‡ªåŠ¨ API æ–‡æ¡£

ç°åœ¨, è¿è¡Œä½ çš„åº”ç”¨:

```bash
$ fastapi dev app/main.py

<span style="color: green;">INFO</span>:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
```

å¹¶åœ¨ http://127.0.0.1:8000/docs æ‰“å¼€æ–‡æ¡£ã€‚

ä½ å°†çœ‹åˆ°è‡ªåŠ¨ API æ–‡æ¡£, åŒ…æ‹¬æ¥è‡ªæ‰€æœ‰å­æ¨¡å—çš„è·¯å¾„, ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„ï¼ˆå’Œå‰ç¼€ï¼‰ä»¥åŠæ­£ç¡®çš„æ ‡ç­¾:

![Image 3](https://example.com/img/tutorial/bigger-applications/image01.png)

## 7. ä½¿ç”¨ä¸åŒçš„ `prefix` å¤šæ¬¡åŒ…å«åŒä¸€ä¸ªè·¯ç”±å™¨

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸åŒçš„å‰ç¼€å¤šæ¬¡ä½¿ç”¨ `.include_router()` æ¥åŒ…å« _åŒä¸€ä¸ª_ è·¯ç”±å™¨ã€‚

è¿™å¯èƒ½å¾ˆæœ‰ç”¨, ä¾‹å¦‚, åœ¨ä¸åŒçš„å‰ç¼€ä¸‹æš´éœ²åŒä¸€ä¸ª API, ä¾‹å¦‚ `/api/v1` å’Œ `/api/latest`ã€‚

è¿™æ˜¯ä¸€ä¸ªé«˜çº§ç”¨æ³•, ä½ å¯èƒ½çœŸçš„ä¸éœ€è¦, ä½†å®ƒå°±åœ¨é‚£é‡Œ, ä»¥é˜²ä½ éœ€è¦ã€‚

## 8. åœ¨å¦ä¸€ä¸ª `APIRouter` ä¸­åŒ…å« `APIRouter`

å°±åƒä½ å¯ä»¥åœ¨ `FastAPI` åº”ç”¨ç¨‹åºä¸­åŒ…å« `APIRouter` ä¸€æ ·, ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨å¦ä¸€ä¸ª `APIRouter` ä¸­åŒ…å« `APIRouter`:

```python
router.include_router(other_router)
```

ç¡®ä¿åœ¨å°† `router` åŒ…å«åœ¨ `FastAPI` åº”ç”¨ç¨‹åºä¸­ä¹‹å‰æ‰§è¡Œæ­¤æ“ä½œ, ä»¥ä¾¿ `other_router` çš„ _è·¯å¾„æ“ä½œ_ ä¹Ÿè¢«åŒ…å«åœ¨å†…ã€‚
