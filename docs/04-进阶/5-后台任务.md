# 5 - åå°ä»»åŠ¡

ä½ å¯ä»¥å®šä¹‰åå°ä»»åŠ¡åœ¨è¿”å›å“åº”åè¿è¡Œ.

è¿™å¯¹äºéœ€è¦åœ¨è¯·æ±‚ä¹‹åæ‰§è¡Œä½†å®¢æˆ·ç«¯ä¸å¿…ç­‰å¾…æ“ä½œå®Œæˆå°±èƒ½æ¥æ”¶å“åº”çš„æ“ä½œéå¸¸æœ‰ç”¨.

åŒ…æ‹¬ä¾‹å¦‚:

- æ‰§è¡Œæ“ä½œåå‘é€ç”µå­é‚®ä»¶é€šçŸ¥:
  - ç”±äºè¿æ¥åˆ°ç”µå­é‚®ä»¶æœåŠ¡å™¨å¹¶å‘é€é‚®ä»¶å¾€å¾€æ˜¯"æ…¢"çš„(å‡ ç§’é’Ÿ),ä½ å¯ä»¥ç«‹å³è¿”å›å“åº”,ç„¶ååœ¨åå°å‘é€é‚®ä»¶é€šçŸ¥.
- å¤„ç†æ•°æ®:
  - ä¾‹å¦‚,å‡è®¾ä½ æ¥æ”¶åˆ°ä¸€ä¸ªå¿…é¡»ç»è¿‡ç¼“æ…¢å¤„ç†çš„æ–‡ä»¶,ä½ å¯ä»¥è¿”å›"Accepted"(HTTP 202)çš„å“åº”,ç„¶ååœ¨åå°å¤„ç†è¯¥æ–‡ä»¶.

## ä½¿ç”¨ `BackgroundTasks`

é¦–å…ˆ,å¯¼å…¥ `BackgroundTasks` å¹¶åœ¨ä½ çš„è·¯å¾„æ“ä½œå‡½æ•°ä¸­å®šä¹‰ä¸€ä¸ªç±»å‹ä¸º `BackgroundTasks` çš„å‚æ•°:

Python 3.8+

```python
from fastapi import BackgroundTasks, FastAPI

app = FastAPI()

def write_notification(email: str, message=""):
    with open("log.txt", mode="w") as email_file:
        content = f"notification for {email}: {message}"
        email_file.write(content)

@app.post("/send-notification/{email}")
async def send_notification(email: str, background_tasks: BackgroundTasks):
    background_tasks.add_task(write_notification, email, message="some notification")
    return {"message": "Notification sent in the background"}
```

FastAPI å°†ä¸ºä½ åˆ›å»º `BackgroundTasks` ç±»å‹çš„å¯¹è±¡,å¹¶å°†å…¶ä½œä¸ºè¯¥å‚æ•°ä¼ é€’.

## åˆ›å»ºä»»åŠ¡å‡½æ•°

åˆ›å»ºä¸€ä¸ªå°†ä½œä¸ºåå°ä»»åŠ¡è¿è¡Œçš„å‡½æ•°.

å®ƒåªæ˜¯ä¸€ä¸ªå¯ä»¥æ¥æ”¶å‚æ•°çš„æ ‡å‡†å‡½æ•°.

å®ƒå¯ä»¥æ˜¯ä¸€ä¸ª `async def` æˆ–æ™®é€šçš„ `def` å‡½æ•°,FastAPI å°†çŸ¥é“å¦‚ä½•æ­£ç¡®å¤„ç†å®ƒ.

åœ¨æœ¬ä¾‹ä¸­,ä»»åŠ¡å‡½æ•°å°†å†™å…¥æ–‡ä»¶(æ¨¡æ‹Ÿå‘é€ç”µå­é‚®ä»¶).

ç”±äºå†™å…¥æ“ä½œä¸ä½¿ç”¨ `async` å’Œ `await`,æˆ‘ä»¬ç”¨æ™®é€šçš„ `def` å®šä¹‰å‡½æ•°:

Python 3.8+

```python
from fastapi import BackgroundTasks, FastAPI

app = FastAPI()

def write_notification(email: str, message=""):
    with open("log.txt", mode="w") as email_file:
        content = f"notification for {email}: {message}"
        email_file.write(content)

@app.post("/send-notification/{email}")
async def send_notification(email: str, background_tasks: BackgroundTasks):
    background_tasks.add_task(write_notification, email, message="some notification")
    return {"message": "Notification sent in the background"}
```

## æ·»åŠ åå°ä»»åŠ¡

åœ¨ä½ çš„è·¯å¾„æ“ä½œå‡½æ•°å†…éƒ¨,ä½¿ç”¨ `.add_task()` æ–¹æ³•å°†ä½ çš„ä»»åŠ¡å‡½æ•°ä¼ é€’ç»™åå°ä»»åŠ¡å¯¹è±¡:

Python 3.8+

```python
from fastapi import BackgroundTasks, FastAPI

app = FastAPI()

def write_notification(email: str, message=""):
    with open("log.txt", mode="w") as email_file:
        content = f"notification for {email}: {message}"
        email_file.write(content)

@app.post("/send-notification/{email}")
async def send_notification(email: str, background_tasks: BackgroundTasks):
    background_tasks.add_task(write_notification, email, message="some notification")
    return {"message": "Notification sent in the background"}
```

`.add_task()` æ¥æ”¶ä»¥ä¸‹å‚æ•°:

- è¦åœ¨åå°è¿è¡Œçš„ä»»åŠ¡å‡½æ•°(`write_notification`).
- åº”è¯¥æŒ‰é¡ºåºä¼ é€’ç»™ä»»åŠ¡å‡½æ•°çš„ä»»ä½•å‚æ•°åºåˆ—(`email`).
- åº”è¯¥ä¼ é€’ç»™ä»»åŠ¡å‡½æ•°çš„ä»»ä½•å…³é”®å­—å‚æ•°(`message="some notification"`).

## ä¾èµ–æ³¨å…¥

ä½¿ç”¨ `BackgroundTasks` ä¹Ÿå¯ä»¥ä¸ä¾èµ–æ³¨å…¥ç³»ç»Ÿä¸€èµ·å·¥ä½œ,ä½ å¯ä»¥åœ¨å¤šä¸ªçº§åˆ«å£°æ˜ç±»å‹ä¸º `BackgroundTasks` çš„å‚æ•°:åœ¨è·¯å¾„æ“ä½œå‡½æ•°ä¸­ã€åœ¨ä¾èµ–é¡¹(å¯ä¾èµ–é¡¹)ä¸­ã€åœ¨å­ä¾èµ–é¡¹ä¸­ç­‰.

FastAPI çŸ¥é“åœ¨æ¯ç§æƒ…å†µä¸‹è¯¥åšä»€ä¹ˆä»¥åŠå¦‚ä½•é‡ç”¨åŒä¸€ä¸ªå¯¹è±¡,ä»¥ä¾¿æ‰€æœ‰åå°ä»»åŠ¡åˆå¹¶åœ¨ä¸€èµ·å¹¶åœ¨åå°è¿è¡Œ:

Python 3.10+

```python
from typing import Annotated

from fastapi import BackgroundTasks, Depends, FastAPI

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: str | None = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: Annotated[str, Depends(get_query)]
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

ğŸ¤“ å…¶ä»–ç‰ˆæœ¬å’Œå˜ä½“

Python 3.9+
```python
from typing import Annotated, Union

from fastapi import BackgroundTasks, Depends, FastAPI

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: Union[str, None] = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: Annotated[str, Depends(get_query)]
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

Python 3.8+ (non-Annotated)
```python
from typing import Union

from fastapi import BackgroundTasks, Depends, FastAPI
from typing_extensions import Annotated

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: Union[str, None] = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: Annotated[str, Depends(get_query)]
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

Python 3.10+ (non-Annotated)
```python
from fastapi import BackgroundTasks, Depends, FastAPI

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: str | None = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: str = Depends(get_query)
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

Python 3.9+ (non-Annotated)
```python
from typing import Union

from fastapi import BackgroundTasks, Depends, FastAPI

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: Union[str, None] = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: str = Depends(get_query)
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

æç¤º

å¦‚æœå¯èƒ½,è¯·ä¼˜å…ˆä½¿ç”¨ `Annotated` ç‰ˆæœ¬.

åœ¨è¿™ä¸ªä¾‹å­ä¸­,æ¶ˆæ¯å°†åœ¨å‘é€å“åº”åå†™å…¥ `log.txt` æ–‡ä»¶.

å¦‚æœè¯·æ±‚ä¸­å­˜åœ¨æŸ¥è¯¢å‚æ•°,å®ƒå°†åœ¨åå°ä»»åŠ¡ä¸­å†™å…¥æ—¥å¿—.

ç„¶ååœ¨è·¯å¾„æ“ä½œå‡½æ•°ä¸­ç”Ÿæˆçš„å¦ä¸€ä¸ªåå°ä»»åŠ¡å°†ä½¿ç”¨ `email` è·¯å¾„å‚æ•°å†™å…¥æ¶ˆæ¯.

## æŠ€æœ¯ç»†èŠ‚

`BackgroundTasks` ç±»ç›´æ¥æ¥è‡ª `starlette.background`.

å®ƒè¢«ç›´æ¥å¯¼å…¥/åŒ…å«åˆ° FastAPI ä¸­,ä»¥ä¾¿ä½ å¯ä»¥ä» `fastapi` å¯¼å…¥å®ƒ,å¹¶é¿å…æ„å¤–ä» `starlette.background` å¯¼å…¥æ›¿ä»£çš„ `BackgroundTask`(æœ«å°¾æ²¡æœ‰ `s`).

ä»…é€šè¿‡ä½¿ç”¨ `BackgroundTasks`(è€Œä¸æ˜¯ `BackgroundTask`),å°±å¯ä»¥å°†å…¶ç”¨ä½œè·¯å¾„æ“ä½œå‡½æ•°å‚æ•°,å¹¶è®© FastAPI ä¸ºä½ å¤„ç†å…¶ä½™éƒ¨åˆ†,å°±åƒç›´æ¥ä½¿ç”¨ `Request` å¯¹è±¡ä¸€æ ·.

åœ¨ FastAPI ä¸­ä»ç„¶å¯ä»¥å•ç‹¬ä½¿ç”¨ `BackgroundTask`,ä½†ä½ å¿…é¡»åœ¨ä»£ç ä¸­åˆ›å»ºå¯¹è±¡å¹¶è¿”å›åŒ…å«å®ƒçš„ Starlette `Response`.

ä½ å¯ä»¥åœ¨ Starlette çš„å®˜æ–¹æ–‡æ¡£ä¸­æŸ¥çœ‹æœ‰å…³åå°ä»»åŠ¡çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯.

## æ³¨æ„äº‹é¡¹

å¦‚æœä½ éœ€è¦æ‰§è¡Œç¹é‡çš„åå°è®¡ç®—,å¹¶ä¸”ä¸ä¸€å®šéœ€è¦ç”±åŒä¸€è¿›ç¨‹è¿è¡Œå®ƒ(ä¾‹å¦‚,ä½ ä¸éœ€è¦å…±äº«å†…å­˜ã€å˜é‡ç­‰),ä½ å¯èƒ½ä¼šå—ç›Šäºä½¿ç”¨å…¶ä»–æ›´å¤§çš„å·¥å…·,å¦‚ Celery.

å®ƒä»¬å¾€å¾€éœ€è¦æ›´å¤æ‚çš„é…ç½®,æ¶ˆæ¯/ä½œä¸šé˜Ÿåˆ—ç®¡ç†å™¨,å¦‚ RabbitMQ æˆ– Redis,ä½†å®ƒä»¬å…è®¸ä½ åœ¨å¤šä¸ªè¿›ç¨‹ä¸­è¿è¡Œåå°ä»»åŠ¡,ç‰¹åˆ«æ˜¯åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Š.

ä½†æ˜¯,å¦‚æœä½ éœ€è¦ä»åŒä¸€ä¸ª FastAPI åº”ç”¨ç¨‹åºè®¿é—®å˜é‡å’Œå¯¹è±¡,æˆ–è€…ä½ éœ€è¦æ‰§è¡Œå°å‹åå°ä»»åŠ¡(å¦‚å‘é€ç”µå­é‚®ä»¶é€šçŸ¥),ä½ å¯ä»¥ç®€å•åœ°ä½¿ç”¨ `BackgroundTasks`.

## å›é¡¾

å¯¼å…¥å¹¶ä½¿ç”¨ `BackgroundTasks` åœ¨è·¯å¾„æ“ä½œå‡½æ•°å’Œä¾èµ–é¡¹ä¸­æ·»åŠ åå°ä»»åŠ¡çš„å‚æ•°.