# 5 - åå°ä»»åŠ¡

ä½ å¯ä»¥å®šä¹‰åå°ä»»åŠ¡åœ¨è¿”å›å“åº”åè¿è¡Œã€‚

è¿™å¯¹äºéœ€è¦åœ¨è¯·æ±‚ä¹‹åæ‰§è¡Œä½†å®¢æˆ·ç«¯ä¸å¿…ç­‰å¾…æ“ä½œå®Œæˆå°±èƒ½æ¥æ”¶å“åº”çš„æ“ä½œéå¸¸æœ‰ç”¨ã€‚

åŒ…æ‹¬ä¾‹å¦‚ï¼š

- æ‰§è¡Œæ“ä½œåå‘é€ç”µå­é‚®ä»¶é€šçŸ¥ï¼š
  - ç”±äºè¿æ¥åˆ°ç”µå­é‚®ä»¶æœåŠ¡å™¨å¹¶å‘é€é‚®ä»¶å¾€å¾€æ˜¯"æ…¢"çš„ï¼ˆå‡ ç§’é’Ÿï¼‰ï¼Œä½ å¯ä»¥ç«‹å³è¿”å›å“åº”ï¼Œç„¶ååœ¨åå°å‘é€é‚®ä»¶é€šçŸ¥ã€‚
- å¤„ç†æ•°æ®ï¼š
  - ä¾‹å¦‚ï¼Œå‡è®¾ä½ æ¥æ”¶åˆ°ä¸€ä¸ªå¿…é¡»ç»è¿‡ç¼“æ…¢å¤„ç†çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥è¿”å›"Accepted"ï¼ˆHTTP 202ï¼‰çš„å“åº”ï¼Œç„¶ååœ¨åå°å¤„ç†è¯¥æ–‡ä»¶ã€‚

## ä½¿ç”¨ `BackgroundTasks`

é¦–å…ˆï¼Œå¯¼å…¥ `BackgroundTasks` å¹¶åœ¨ä½ çš„è·¯å¾„æ“ä½œå‡½æ•°ä¸­å®šä¹‰ä¸€ä¸ªç±»å‹ä¸º `BackgroundTasks` çš„å‚æ•°ï¼š

Python 3.8+

```python
from fastapi import BackgroundTasks, FastAPI

app = FastAPI()

def write_notification(email: str, message=""):
    with open("log.txt", mode="w") as email_file:
        content = f"notification for {email}: {message}"
        email_file.write(content)

@app.post("/send-notification/{email}")
async def send_notification(email: str, background_tasks: BackgroundTasks):
    background_tasks.add_task(write_notification, email, message="some notification")
    return {"message": "Notification sent in the background"}
```

FastAPI å°†ä¸ºä½ åˆ›å»º `BackgroundTasks` ç±»å‹çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶ä½œä¸ºè¯¥å‚æ•°ä¼ é€’ã€‚

## åˆ›å»ºä»»åŠ¡å‡½æ•°

åˆ›å»ºä¸€ä¸ªå°†ä½œä¸ºåå°ä»»åŠ¡è¿è¡Œçš„å‡½æ•°ã€‚

å®ƒåªæ˜¯ä¸€ä¸ªå¯ä»¥æ¥æ”¶å‚æ•°çš„æ ‡å‡†å‡½æ•°ã€‚

å®ƒå¯ä»¥æ˜¯ä¸€ä¸ª `async def` æˆ–æ™®é€šçš„ `def` å‡½æ•°ï¼ŒFastAPI å°†çŸ¥é“å¦‚ä½•æ­£ç¡®å¤„ç†å®ƒã€‚

åœ¨æœ¬ä¾‹ä¸­ï¼Œä»»åŠ¡å‡½æ•°å°†å†™å…¥æ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿå‘é€ç”µå­é‚®ä»¶ï¼‰ã€‚

ç”±äºå†™å…¥æ“ä½œä¸ä½¿ç”¨ `async` å’Œ `await`ï¼Œæˆ‘ä»¬ç”¨æ™®é€šçš„ `def` å®šä¹‰å‡½æ•°ï¼š

Python 3.8+

```python
from fastapi import BackgroundTasks, FastAPI

app = FastAPI()

def write_notification(email: str, message=""):
    with open("log.txt", mode="w") as email_file:
        content = f"notification for {email}: {message}"
        email_file.write(content)

@app.post("/send-notification/{email}")
async def send_notification(email: str, background_tasks: BackgroundTasks):
    background_tasks.add_task(write_notification, email, message="some notification")
    return {"message": "Notification sent in the background"}
```

## æ·»åŠ åå°ä»»åŠ¡

åœ¨ä½ çš„è·¯å¾„æ“ä½œå‡½æ•°å†…éƒ¨ï¼Œä½¿ç”¨ `.add_task()` æ–¹æ³•å°†ä½ çš„ä»»åŠ¡å‡½æ•°ä¼ é€’ç»™åå°ä»»åŠ¡å¯¹è±¡ï¼š

Python 3.8+

```python
from fastapi import BackgroundTasks, FastAPI

app = FastAPI()

def write_notification(email: str, message=""):
    with open("log.txt", mode="w") as email_file:
        content = f"notification for {email}: {message}"
        email_file.write(content)

@app.post("/send-notification/{email}")
async def send_notification(email: str, background_tasks: BackgroundTasks):
    background_tasks.add_task(write_notification, email, message="some notification")
    return {"message": "Notification sent in the background"}
```

`.add_task()` æ¥æ”¶ä»¥ä¸‹å‚æ•°ï¼š

- è¦åœ¨åå°è¿è¡Œçš„ä»»åŠ¡å‡½æ•°ï¼ˆ`write_notification`ï¼‰ã€‚
- åº”è¯¥æŒ‰é¡ºåºä¼ é€’ç»™ä»»åŠ¡å‡½æ•°çš„ä»»ä½•å‚æ•°åºåˆ—ï¼ˆ`email`ï¼‰ã€‚
- åº”è¯¥ä¼ é€’ç»™ä»»åŠ¡å‡½æ•°çš„ä»»ä½•å…³é”®å­—å‚æ•°ï¼ˆ`message="some notification"`ï¼‰ã€‚

## ä¾èµ–æ³¨å…¥

ä½¿ç”¨ `BackgroundTasks` ä¹Ÿå¯ä»¥ä¸ä¾èµ–æ³¨å…¥ç³»ç»Ÿä¸€èµ·å·¥ä½œï¼Œä½ å¯ä»¥åœ¨å¤šä¸ªçº§åˆ«å£°æ˜ç±»å‹ä¸º `BackgroundTasks` çš„å‚æ•°ï¼šåœ¨è·¯å¾„æ“ä½œå‡½æ•°ä¸­ã€åœ¨ä¾èµ–é¡¹ï¼ˆå¯ä¾èµ–é¡¹ï¼‰ä¸­ã€åœ¨å­ä¾èµ–é¡¹ä¸­ç­‰ã€‚

FastAPI çŸ¥é“åœ¨æ¯ç§æƒ…å†µä¸‹è¯¥åšä»€ä¹ˆä»¥åŠå¦‚ä½•é‡ç”¨åŒä¸€ä¸ªå¯¹è±¡ï¼Œä»¥ä¾¿æ‰€æœ‰åå°ä»»åŠ¡åˆå¹¶åœ¨ä¸€èµ·å¹¶åœ¨åå°è¿è¡Œï¼š

Python 3.10+

```python
from typing import Annotated

from fastapi import BackgroundTasks, Depends, FastAPI

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: str | None = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: Annotated[str, Depends(get_query)]
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

ğŸ¤“ å…¶ä»–ç‰ˆæœ¬å’Œå˜ä½“

Python 3.9+
```python
from typing import Annotated, Union

from fastapi import BackgroundTasks, Depends, FastAPI

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: Union[str, None] = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: Annotated[str, Depends(get_query)]
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

Python 3.8+ (non-Annotated)
```python
from typing import Union

from fastapi import BackgroundTasks, Depends, FastAPI
from typing_extensions import Annotated

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: Union[str, None] = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: Annotated[str, Depends(get_query)]
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

Python 3.10+ (non-Annotated)
```python
from fastapi import BackgroundTasks, Depends, FastAPI

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: str | None = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: str = Depends(get_query)
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

Python 3.9+ (non-Annotated)
```python
from typing import Union

from fastapi import BackgroundTasks, Depends, FastAPI

app = FastAPI()

def write_log(message: str):
    with open("log.txt", mode="a") as log:
        log.write(message)

def get_query(background_tasks: BackgroundTasks, q: Union[str, None] = None):
    if q:
        message = f"found query: {q}\n"
        background_tasks.add_task(write_log, message)
    return q

@app.post("/send-notification/{email}")
async def send_notification(
    email: str, background_tasks: BackgroundTasks, q: str = Depends(get_query)
):
    message = f"message to {email}\n"
    background_tasks.add_task(write_log, message)
    return {"message": "Message sent"}
```

æç¤º

å¦‚æœå¯èƒ½ï¼Œè¯·ä¼˜å…ˆä½¿ç”¨ `Annotated` ç‰ˆæœ¬ã€‚

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæ¶ˆæ¯å°†åœ¨å‘é€å“åº”åå†™å…¥ `log.txt` æ–‡ä»¶ã€‚

å¦‚æœè¯·æ±‚ä¸­å­˜åœ¨æŸ¥è¯¢å‚æ•°ï¼Œå®ƒå°†åœ¨åå°ä»»åŠ¡ä¸­å†™å…¥æ—¥å¿—ã€‚

ç„¶ååœ¨è·¯å¾„æ“ä½œå‡½æ•°ä¸­ç”Ÿæˆçš„å¦ä¸€ä¸ªåå°ä»»åŠ¡å°†ä½¿ç”¨ `email` è·¯å¾„å‚æ•°å†™å…¥æ¶ˆæ¯ã€‚

## æŠ€æœ¯ç»†èŠ‚

`BackgroundTasks` ç±»ç›´æ¥æ¥è‡ª `starlette.background`ã€‚

å®ƒè¢«ç›´æ¥å¯¼å…¥/åŒ…å«åˆ° FastAPI ä¸­ï¼Œä»¥ä¾¿ä½ å¯ä»¥ä» `fastapi` å¯¼å…¥å®ƒï¼Œå¹¶é¿å…æ„å¤–ä» `starlette.background` å¯¼å…¥æ›¿ä»£çš„ `BackgroundTask`ï¼ˆæœ«å°¾æ²¡æœ‰ `s`ï¼‰ã€‚

ä»…é€šè¿‡ä½¿ç”¨ `BackgroundTasks`ï¼ˆè€Œä¸æ˜¯ `BackgroundTask`ï¼‰ï¼Œå°±å¯ä»¥å°†å…¶ç”¨ä½œè·¯å¾„æ“ä½œå‡½æ•°å‚æ•°ï¼Œå¹¶è®© FastAPI ä¸ºä½ å¤„ç†å…¶ä½™éƒ¨åˆ†ï¼Œå°±åƒç›´æ¥ä½¿ç”¨ `Request` å¯¹è±¡ä¸€æ ·ã€‚

åœ¨ FastAPI ä¸­ä»ç„¶å¯ä»¥å•ç‹¬ä½¿ç”¨ `BackgroundTask`ï¼Œä½†ä½ å¿…é¡»åœ¨ä»£ç ä¸­åˆ›å»ºå¯¹è±¡å¹¶è¿”å›åŒ…å«å®ƒçš„ Starlette `Response`ã€‚

ä½ å¯ä»¥åœ¨ Starlette çš„å®˜æ–¹æ–‡æ¡£ä¸­æŸ¥çœ‹æœ‰å…³åå°ä»»åŠ¡çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚

## æ³¨æ„äº‹é¡¹

å¦‚æœä½ éœ€è¦æ‰§è¡Œç¹é‡çš„åå°è®¡ç®—ï¼Œå¹¶ä¸”ä¸ä¸€å®šéœ€è¦ç”±åŒä¸€è¿›ç¨‹è¿è¡Œå®ƒï¼ˆä¾‹å¦‚ï¼Œä½ ä¸éœ€è¦å…±äº«å†…å­˜ã€å˜é‡ç­‰ï¼‰ï¼Œä½ å¯èƒ½ä¼šå—ç›Šäºä½¿ç”¨å…¶ä»–æ›´å¤§çš„å·¥å…·ï¼Œå¦‚ Celeryã€‚

å®ƒä»¬å¾€å¾€éœ€è¦æ›´å¤æ‚çš„é…ç½®ï¼Œæ¶ˆæ¯/ä½œä¸šé˜Ÿåˆ—ç®¡ç†å™¨ï¼Œå¦‚ RabbitMQ æˆ– Redisï¼Œä½†å®ƒä»¬å…è®¸ä½ åœ¨å¤šä¸ªè¿›ç¨‹ä¸­è¿è¡Œåå°ä»»åŠ¡ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šã€‚

ä½†æ˜¯ï¼Œå¦‚æœä½ éœ€è¦ä»åŒä¸€ä¸ª FastAPI åº”ç”¨ç¨‹åºè®¿é—®å˜é‡å’Œå¯¹è±¡ï¼Œæˆ–è€…ä½ éœ€è¦æ‰§è¡Œå°å‹åå°ä»»åŠ¡ï¼ˆå¦‚å‘é€ç”µå­é‚®ä»¶é€šçŸ¥ï¼‰ï¼Œä½ å¯ä»¥ç®€å•åœ°ä½¿ç”¨ `BackgroundTasks`ã€‚

## å›é¡¾

å¯¼å…¥å¹¶ä½¿ç”¨ `BackgroundTasks` åœ¨è·¯å¾„æ“ä½œå‡½æ•°å’Œä¾èµ–é¡¹ä¸­æ·»åŠ åå°ä»»åŠ¡çš„å‚æ•°ã€‚